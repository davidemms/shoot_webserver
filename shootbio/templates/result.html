<!DOCTYPE html>
<html lang = 'en'>

<head>

    <title>SHOOT Results: {{ query_gene_name }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootswatch/4.1.1/spacelab/bootstrap.min.css">

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <script src="//d3js.org/d3.v5.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='phylotree.js') }}"></script>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='phylotree.css') }}" />
    <style>

        nav {
          margin-bottom: 25px;
        }

        footer {
          margin-top: 25px;
        }

        .fa-rotate-45 {
          -webkit-transform: rotate(45deg);
          -moz-transform: rotate(45deg);
          -ms-transform: rotate(45deg);
          -o-transform: rotate(45deg);
          transform: rotate(45deg);
        }

        .fa-rotate-135 {
          -webkit-transform: rotate(135deg);
          -moz-transform: rotate(135deg);
          -ms-transform: rotate(135deg);
          -o-transform: rotate(135deg);
          transform: rotate(135deg);
        }

        @media (max-width: 1075px) { 
          .container {
            padding-top: 50px;
          }
        }

        .btn {
          height: 30px;
        }

        .query_gene {
          color:#2b8cbe;
        }

        #toolbar {
          display: flex;
          justify-content: space-between;
          width: 550px;
        }
        
        #controls {
          position: fixed;
          left: 5px;
        }
   </style>
</head>

<body>

<!--
###############################################################################################################################
-->

<nav class="navbar navbar-expand-lg navbar-light bg-light">

  <a class="navbar-brand" href="/">SHOOT: sprout a new branch on the tree of life</a>

  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="navbar-nav">

      <li class="nav-item dropdown">
        <a href="#" id="newick-dropdown" class="nav-link dropdown-toggle" role="button" data-toggle="modal" data-target="#newick_export_modal">Export tree <b class="caret"></b></a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('download_sequences') }}" class="nav-link" role="button">Export sequences</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('faq') }}" class="nav-link" role="link" target="_blank">FAQ</a>
      </li>
    </ul>

    <!-- <ul class="nav navbar-nav mx-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Tag 
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="selection_name_dropdown">
          <a id="selection_new" class="dropdown-item" href="#">New selection set</a>
          <a id="selection_delete" class="dropdown-item" href="#">Delete selection set</a>
          <a id="selection_rename" class="dropdown-item" href="#">Rename selection set</a>
          <div class="dropdown-divider"></div>
        </div>
      </li>

      <li>
        <form class="form-inline my-2 my-lg-0">
          <input type="text" id = 'selection_name_box' class="form-control mr-sm-2" value="Foreground" disabled size=40>
        </form>
      </li>

      <li id="save_selection_name" style="display:none;" class="my-auto">
        <a href="#"><button id="cancel_selection_button" class="btn btn-info btn-sm">Cancel</button></a>
        <a href="#"><button id="save_selection_button" class="btn btn-info btn-sm">Save</button></a>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Selection
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a id="select_all" class="dropdown-item" href="#">Select all</a>
          <a id="select_all_internal" class="dropdown-item" href="#">Select all internal nodes</a>
          <a id="select_all_leaves" class="dropdown-item" href="#">Select all leaf nodes</a>
          <a id="clear_internal" class="dropdown-item" href="#">Clear all internal nodes</a>
          <a id="clear_leaves" class="dropdown-item" href="#">Clear all leaves</a>
          <a id="select_none" class="dropdown-item" href="#">Clear selection</a>
          <div class="dropdown-divider"></div>
          <a id="mp_label" class="dropdown-item" href="#">Label internal nodes using maximum parsimony</a>
          <a id="and_label" class="dropdown-item" href="#">Label internal nodes using conjunction (AND)</a>
          <a id="or_label" class="dropdown-item" href="#">Label internal nodes using disjunction (OR)</a>
        </div>
      </li>
    </ul> -->

    <ul class="navbar-nav ml-auto">
      <li>
        <form class="form-inline my-2 my-lg-0">
          <input type="text" id = 'branch_filter' class="form-control mr-sm-2" placeholder="Filter branches on" onkeypress="return event.keyCode != 13">
        </form>
      </li>
    </ul>
  </div><!-- /.container-fluid -->
</nav>

<div class="modal" id = 'newick_export_modal' role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body" id = 'newick_body'>
         <textarea id = 'nwk_export_spec' autofocus = true placeholder = "" style = 'width: 100%; height: 100%' rows = 20></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal" id = 'progress_model'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Task in progress</h4>
      </div>
      <div class="modal-body" id = 'progress_model_body'>
         
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id = 'controls'>
    <form id = 'controls_form' style = 'width:200px;'>
    </form>
</div>

{% if error %}
<div class="alert alert-warning" role="alert">  
<h1>Messages:</h1>
<p>{{ error }}</p>
</div>
{% endif %}

<div class="container">
  <p class="lead">Query gene: <span class="query_gene">{{ query_gene_name }}</span></p>
</div>


<div class = 'container' id = "main_display">

  <div class = 'row'>
    <div class = 'col-md-auto'>
      <div class="btn-toolbar" role="toolbar" id='toolbar'>
        <div class="btn-group">
          <button type="button" class="btn btn-light btn-sm" data-direction = 'vertical' data-amount = '1' title = "Expand vertical spacing">
              <i class="fa fa-arrows-v" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" data-direction = 'vertical' data-amount = '-1' title = "Compress vertical spacing">
              <i class="fa  fa-compress fa-rotate-135" ></i>
          </button>
          <button type="button" class="btn btn-light btn-sm" data-direction = 'horizontal' data-amount = '1' title = "Expand horizonal spacing">
              <i class="fa fa-arrows-h" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" data-direction = 'horizontal' data-amount = '-1' title = "Compress horizonal spacing">
              <i class="fa  fa-compress fa-rotate-45" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_ascending" title = "Sort deepest clades to the bototm">
              <i class="fa fa-sort-amount-asc" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_descending" title = "Sort deepsest clades to the top">
              <i class="fa fa-sort-amount-desc" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_original" title = "Restore original order">
              <i class="fa fa-sort" ></i>
          </button>
          <!-- <button type="button" class="btn btn-light btn-sm" id = "collapse_wider_tree" title = "Collapse wider tree">
             <i class="fa compress-arrows-alt" ></i>
         </button> -->
          
           <button type="button" class="btn btn-light btn-sm" id = "save_image" title = "Save image">
              <i class="fa fa-picture-o" ></i>
          </button>
        </div>

        <div class="btn-group" role="group">
          <button class="btn btn-light btn-sm active phylotree-layout-mode" data-mode = "linear">
            Linear
          </button>
          <button class="btn btn-light btn-sm phylotree-layout-mode" data-mode = "radial" >
            Radial
          </button>
        </div>
        <div class="btn-group" role="group">
          <button class="btn btn-light btn-sm active phylotree-align-toggler" data-align= "left">
              <i class="fa fa-align-left" ></i>
          </button>
          <button class="btn btn-light btn-sm phylotree-align-toggler" data-align= "right">
              <i class="fa fa-align-right" ></i>
          </button>
        </div>
      </div>

      <div class="btn-group" role="group">
        <div class="container">
          <div class="col">
            <div class="row justify-content-center">
              Show more genes. Tree level: 
            </div>
            <div class="row justify-content-center">
              <div class="btn-group">
                <button class="btn btn-light btn-sm" id = "tree_level_up_1" title = "Show 1 extra level in tree">+1</button>
                <button class="btn btn-light btn-sm" id = "tree_level_up_5" title = "Show 5 extra levels in tree">+5</button>
                <button class="btn btn-light btn-sm" id = "tree_level_all" title = "Show all levels in tree">All</button>
                <button class="btn btn-light btn-sm" id = "tree_level_down_5" title = "Show 5 fewer levels in tree">-5</button>
                <button class="btn btn-light btn-sm" id = "tree_level_down_1" title = "Show 1 fewer level in tree">-1</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!--div class = 'col-md-4'>
      <label class = "pull-right"><b>Selected</b> <span class="badge badge-secondary" id="selected_branch_counter">0</span> <b>branches with current label</b></label>
    </div -->
  </div>

  <div class = 'row'>
    <div class = 'col-md-12'>
      <div id = 'tree_container' class = 'tree-widget'></div>
    </div>
  </div>
</div>

<footer class="footer fixed-bottom bg-light">
<!-- <footer class="navbar fixed-bottom bg-light pull-left"> -->
  <div class="container">
    <!-- <a class="navbar-brand">SHOOT: gene search and placement within a phylogenetic database. David Emms & Steven Kelly &copy; 2021</a> -->
    <span class="text-muted">SHOOT: gene search and placement within a phylogenetic database. David Emms & Steven Kelly &copy; 2021</span>
    <!-- <p class="text-muted text-left">SHOOT: gene search and placement within a phylogenetic database. David Emms & Steven Kelly &copy; 2021</span> -->
  </div>
</footer>


<!--
###############################################################################################################################
-->

<script>

var phylotree_extensions = new Object ();

$('#newick_export_modal').on('show.bs.modal', function (e) {
    $('textarea[id$="nwk_export_spec"]').val(
        tree.getNewick (
            function (node) {
                var tags = [];
                selection_set.forEach (function (d) { if (node[d]) {tags.push(d)}; });
                if (tags.length) {
                    return "{" + tags.join (",") + "}";
                }
                return "";
            }
        )
    );
})


// $('#sequences_export').on('click', function (e) {
//   var filename="hello.txt"
//   var text = "This is the contents"
//   var element = document.createElement('a');
//   element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
//   element.setAttribute('download', filename);

//   element.style.display = 'none';
//   document.body.appendChild(element);

//   element.click();

//   document.body.removeChild(element);
// });

$("#newick_file").on ("change", function (e) {

    var files = e.target.files; // FileList object

    if (files.length == 1) {
      var f = files[0];

      new FileUpload(f, f.file);

      var reader = new FileReader();

      reader.onload = function(e) {

            var res = e.target.result;
            var warning_div = d3.select ("#main_display").insert ("div", ":first-child");
            console.log(res);

            tree = new phylotree.phylotree(res);
            global_tree = tree;

            if (!tree["json"]) {
                warning_div.attr ("class", "alert alert-danger alert-dismissable")
                            .html ("<strong>Newick parser error for file " + f.name +": </strong> In file " + res["error"]);

            } else {
                rendered_tree = tree.render({
                  container: "#tree_container",
                  'draw-size-bubbles' : false,
                  'left-right-spacing' : 'fixed-step',
                  'node-styler': node_colorizer,
                  'edge-styler': edge_colorizer
                });

                $('#newick_modal').modal('hide');
                $(rendered_tree.container).html(rendered_tree.show())
            }
        };

      $('#newick-dropdown').dropdown('toggle');
      reader.readAsText(f);
    }
});



$("#display_tree").on ("click", function (e) {
    tree.options ({'branches' : 'straight'}, true);
});

$("#mp_label").on ("click", function (e) {
    tree.maxParsimony (true, 'Foreground');
});

$ ("[data-direction]").on ("click", function (e) {
    var which_function = $(this).data ("direction") == 'vertical' ? tree.display.spacing_x.bind(tree.display) : tree.display.spacing_y.bind(tree.display);
    which_function (which_function () + (+ $(this).data ("amount"))).update();
});




$(".phylotree-layout-mode").on ("click", function (e) {

    if (rendered_tree.radial () != ($(this).data ("mode") == "radial")) {
        $('.phylotree-layout-mode').toggleClass('active');
        rendered_tree.radial(!rendered_tree.radial()).update();
    }
});


$("#toggle_animation").on ("click", function (e) {
    var current_mode = $(this).hasClass('active');
    $(this).toggleClass('active');
    tree.options ({'transitions' : !current_mode} );
});


$(".phylotree-align-toggler").on ("click", function (e) {

  var button_align = $(this).data ("align");
  var tree_align = rendered_tree.options.alignTips;

  if (tree_align != button_align) {
      rendered_tree.alignTips(button_align == "right");
      $('.phylotree-align-toggler').toggleClass('active');
      rendered_tree.update();
  }
  // console.log(rendered_tree.options.alignTips)
});



function sort_nodes (asc) {

    tree.resortChildren (
      function(a, b) { return (b.height - a.height || b.value - a.value) * (asc ? 1 : -1); }
    );

}

$("#sort_original").on ("click", function (e) {
    tree.resortChildren (function (a,b) {
        return a["original_child_order"] - b["original_child_order"];
    });
});

// $("#collapse_wider_tree").on ("click", function (e) {
//     // collapse wider tree
//     console.log(1)
//     console.log(tree)
//     console.log(rendered_tree)
//     tree.getRootNode()

//     // pt = 
//     if (query_gene_name.length > 0){
//       query_node = rendered_tree.phylotree.getNodeByName(query_gene_name)
//       n = query_node
//       while (n.parent && n.count().value < 5) {
//         n = n.parent
//       }
//       n_keep = n
//       while (n_keep.parent) {
//         p = n_keep.parent
//         for (const ch of p.children) {
//           if (ch != n_keep && !rendered_tree.phylotree.isLeafNode(ch)) {
//             rendered_tree.collapse_node(ch)
//           }
//         }
//         n_keep = p
//       }
//     }
//     rendered_tree.update();
// });

$("#sort_ascending").on ("click", function (e) {
    sort_nodes (true);
    rendered_tree.update();
});

$("#sort_descending").on ("click", function (e) {
    sort_nodes (false);
    rendered_tree.update();
});

$("#and_label").on ("click", function (e) {
    rendered_tree.internalLabel (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] && prev; }, true)}, true);
});

$("#or_label").on ("click", function (e) {
    rendered_tree.internalLabel (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] || prev; }, false)}, true);
});


$("#select_all").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return true;});
});

$("#select_all_internal").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return !tree.isLeafNode (d.target);});
});

$("#select_all_leaves").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return tree.isLeafNode (d.target);});
});


$("#select_none").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return false;});
});

$("#clear_internal").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return tree.isLeafNode (d.target) ? d.target[current_selection_name] : false;});
});

$("#clear_leaves").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return !tree.isLeafNode (d.target) ? d.target[current_selection_name] : false;});
});


$("#display_dengrogram").on ("click", function (e) {
    rendered_tree.options ({'branches' : 'step'}, true);
});

$("#branch_filter").on ("input propertychange", function (e) {
   var filter_value = $(this).val();

   var rx = new RegExp (filter_value,"i");

   rendered_tree.modifySelection (n => {
     if(!n.target.data.name) {
       return false;
     }
      m = n.target.data.name.search (rx)
      return filter_value.length && m != -1;
   },"tag");

});

function default_tree_settings () {
    tree = phylotree();
    tree.branchLength (null);
    tree.branchName (null);
    rendered_tree.radial (false).separation (function (a,b) {return 0;})
}

function up_n(n){
  try {
    var n_level = n_global_level
    if (!n_level.parent) {
      return
    }
    var i;
    for (i = 0; i < n; i++){
      if (n_level.parent){
        n_level = n_level.parent
      }
      else{
        break
      }
    }
    if (n_level != n_global_level) {
      subtree_newick = getNewick_from_node(n_level, global_full_tree)
      display_tree(subtree_newick)
      n_global_level = n_level
    }
  }
  catch (e) {
  }
}

function down_n(n){
  try {
    var n_level = n_global_level
    if (!n_level.children) {
      return
    }
    var i;
    for (i = 0; i < n; i++){
      if (n_level.children){
        for (ch of n_level.children)
        {
          if (ch.path_to_target){
            break
          }
        }
        if (!ch.path_to_target){
          break
        }
        n_level = ch
      }
      else{
        break
      }
    }
    if (!n_level.children){
      n_level = n_level.parent
    }
    if (n_level != n_global_level) {
      subtree_newick = getNewick_from_node(n_level, global_full_tree)
      display_tree(subtree_newick)
      n_global_level = n_level
    }
  }
  catch (e) {
  }
}

$("#tree_level_up_1").on ("click", function (e) {
  up_n(1)
});

$("#tree_level_up_5").on ("click", function (e) {
  up_n(5)
});

$("#tree_level_down_1").on ("click", function (e) {
  down_n(1)
});

$("#tree_level_down_5").on ("click", function (e) {
  down_n(5)
});

$("#tree_level_all").on ("click", function (e) {
  up_n(Number.MAX_SAFE_INTEGER)
});

function node_colorizer (element, data) {

try{

   var count_class = 0;
    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("fill", color_scheme(i), i == current_selection_id ?  "important" : null);}});

    if (count_class > 1) {

    } else {
        if (count_class == 0) {
            element.style ("fill", null);
       }
    }

}
catch (e) {
}

}

function node_colorizer_ed_v2 (element, data) {
try{
  if (!data.children) {
    if (data.data.name == query_gene_name) {
      element.style ("fill", "#2b8cbe", "important");
    }
    else {
      var uniprot_id = data.data.name.split("_")[2]
      var uniprot_url = "https://www.uniprot.org/uniprot/" + uniprot_id
      element.on("click",function(d,i) { window.open(uniprot_url, "_blank"); });
    }
  }
}
catch (e) {
}
}

function edge_colorizer (element, data) {
try {
    var count_class = 0;

    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("stroke", color_scheme(i), i == current_selection_id ?  "important" : null);}});

    if (count_class > 1) {
        element.classed ("branch-multiple", true);
    } else
    if (count_class == 0) {
             element.style ("stroke", null)
                   .classed ("branch-multiple", false);
    }
}
catch (e) {
}

}

var valid_id = new RegExp ("^[\\w]+$");

$("#selection_name_box").on ("input propertychange", function (e) {

   var name = $(this).val();

   var accept_name = (selection_set.indexOf (name) < 0) &&
                     valid_id.exec (name);

   d3.select ("#save_selection_button").classed("disabled", accept_name ? null : true );

});

$("#selection_rename").on ("click", function (e) {

    d3.select ("#save_selection_button")
           .classed ("disabled",true)
           .on ("click", function (e) { // save selection handler
                var old_selection_name = current_selection_name;
                selection_set[current_selection_id] = current_selection_name = $("#selection_name_box").val();

                if (old_selection_name != current_selection_name) {
                    tree.update_key_name (old_selection_name, current_selection_name);
                    update_selection_names (current_selection_id);
                }
                send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                             {'detail' : ['save', this]}));
           });

    d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });

    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['rename', this]}));
    e.preventDefault    ();

});

$("#selection_delete").on ("click", function (e) {

    rendered_tree.updateKeyName (selection_set[current_selection_id], null)
    selection_set.splice (current_selection_id, 1);

    if (current_selection_id > 0) {
        current_selection_id --;
    }
    current_selection_name = selection_set[current_selection_id];
    update_selection_names (current_selection_id)
    $("#selection_name_box").val(current_selection_name)


    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
    e.preventDefault    ();

});

$("#selection_new").on ("click", function (e) {

    d3.select ("#save_selection_button")
               .classed ("disabled",true)
               .on ("click", function (e) { // save selection handler
                    current_selection_name = $("#selection_name_box").val();
                    current_selection_id = selection_set.length;
                    selection_set.push (current_selection_name);
                    update_selection_names (current_selection_id);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
              });

     d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });

    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['new', this]}));
    e.preventDefault    ();

});

function send_click_event_to_menu_objects (e) {
    $("#selection_new, #selection_delete, #selection_rename, #save_selection_name, #selection_name_box, #selection_name_dropdown").get().forEach (
        function (d) {
            d.dispatchEvent (e);
        }
    );
}

function update_selection_names (id, skip_rebuild) {

    skip_rebuild = skip_rebuild || false;
    id = id || 0;

    current_selection_name = selection_set[id];
    current_selection_id = id;

    if (!skip_rebuild) {
        d3.selectAll (".selection_set").remove();

        d3.select ("#selection_name_dropdown")
          .selectAll (".selection_set")
          .data (selection_set)
          .enter()
          .append ("a")
          .attr ("class", "selection_set dropdown-item")
          .attr ("href", "#")
          .text (function (d) { return d;})
          .style ("color", function (d,i) {return color_scheme(i);})
          .on ("click", function (d,i) {update_selection_names (i,true);});

    }


    d3.select ("#selection_name_box")
      .style ("color",  color_scheme(id))
      .property ("value", current_selection_name);

    rendered_tree.selectionLabel(selection_set[id]);
    rendered_tree.update();
}

var width  = 800, //$(container_id).width(),
    height = 800, //$(container_id).height()
    selection_set = ['Foreground'],
    current_selection_name = $("#selection_name_box").val(),
    current_selection_id = 0,
    max_selections       = 10;
    color_scheme = d3.scaleOrdinal(d3.schemeCategory10),
    selection_menu_element_action = "phylotree_menu_element_action";

{% if newick_str %}
    var initial_nwk_string = "{{ newick_str }}";
    var query_gene_name = "{{ query_gene_name }}";
{% else %}
    var initial_nwk_string = "()myroot";
    var query_gene_name = "";
{% endif %}
var container_id = '#tree_container';

//var tree = phylotree.phylotree(test_string);
            //.size([height, width]);

//window.setInterval (function () {});

var example_controls = d3.select ("#controls_form").append ("form");

//var svg = d3.select(container_id).append("svg")
//    .attr("width", width)
//    .attr("height", height);
    



function selection_handler_name_box (e) {
    var name_box = d3.select (this);
     switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            name_box.property ("disabled", true)
                    .style ("color",  color_scheme(current_selection_id));

            break;
        case 'new':
            name_box.property ("disabled", false)
                    .property ("value", "new_selection_name")
                    .style ("color",  color_scheme(selection_set.length));
            break;
        case 'rename':
           name_box.property ("disabled", false);
           break;
    }

}

function selection_handler_new (e) {
    var element = d3.select (this);
    $(this).data('tooltip', false);
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == max_selections) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'Up to ' + max_selections + ' are allowed', 'placement' : 'left'});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;

    }
}

function selection_handler_rename (e) {
    var element = d3.select (this);
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_save_selection_name (e) {
    var element = d3.select (this);
    element.style ("display", (e.detail[0] == "save" || e.detail[0] == "cancel") ? "none" : null);
}

function selection_handler_name_dropdown (e) {
    var element = d3.select (this).selectAll (".selection_set");
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_delete (e) {
    var element = d3.select (this);
    $(this).tooltip('dispose');
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == 1) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'At least one named selection set <br> is required;<br>it can be empty, however', 'placement' : 'bottom', 'html': true});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;

  }
}

var datamonkey_save_image = function(type, container) {
  var prefix = {
    xmlns: "http://www.w3.org/2000/xmlns/",
    xlink: "http://www.w3.org/1999/xlink",
    svg: "http://www.w3.org/2000/svg"
  };

  function get_styles(doc) {
    function process_stylesheet(ss) {
      try {
        if (ss.cssRules) {
          for (var i = 0; i < ss.cssRules.length; i++) {
            var rule = ss.cssRules[i];
            if (rule.type === 3) {
              // Import Rule
              process_stylesheet(rule.styleSheet);
            } else {
              // hack for illustrator crashing on descendent selectors
              if (rule.selectorText) {
                if (rule.selectorText.indexOf(">") === -1) {
                  styles += "\n" + rule.cssText;
                }
              }
            }
          }
        }
      } catch (e) {
        console.log("Could not process stylesheet : " + ss); // eslint-disable-line
      }
    }

    var styles = "",
      styleSheets = doc.styleSheets;

    if (styleSheets) {
      for (var i = 0; i < styleSheets.length; i++) {
        process_stylesheet(styleSheets[i]);
      }
    }

    return styles;
  }

  var svg = $(container).find("svg")[0];
  if (!svg) {
    svg = $(container)[0];
  }

  var styles = get_styles(window.document);

  svg.setAttribute("version", "1.1");

  var defsEl = document.createElement("defs");
  svg.insertBefore(defsEl, svg.firstChild);

  var styleEl = document.createElement("style");
  defsEl.appendChild(styleEl);
  styleEl.setAttribute("type", "text/css");

  // removing attributes so they aren't doubled up
  svg.removeAttribute("xmlns");
  svg.removeAttribute("xlink");

  // These are needed for the svg
  if (!svg.hasAttributeNS(prefix.xmlns, "xmlns")) {
    svg.setAttributeNS(prefix.xmlns, "xmlns", prefix.svg);
  }

  if (!svg.hasAttributeNS(prefix.xmlns, "xmlns:xlink")) {
    svg.setAttributeNS(prefix.xmlns, "xmlns:xlink", prefix.xlink);
  }

  var source = new XMLSerializer()
    .serializeToString(svg)
    .replace("</style>", "<![CDATA[" + styles + "]]></style>");
  var doctype =
    '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';
  var to_download = [doctype + source];
  var image_string =
    "data:image/svg+xml;base66," + encodeURIComponent(to_download);

  if (navigator.msSaveBlob) {
    // IE10
    download(image_string, "image.svg", "image/svg+xml");
  } else if (type == "png") {
    b64toBlob(
      image_string,
      function(blob) {
        var url = window.URL.createObjectURL(blob);
        var pom = document.createElement("a");
        pom.setAttribute("download", "image.png");
        pom.setAttribute("href", url);
        $("body").append(pom);
        pom.click();
        pom.remove();
      },
      function(error) {
        console.log(error); // eslint-disable-line
      }
    );
  } else {
    var pom = document.createElement("a");
    pom.setAttribute("download", "image.svg");
    pom.setAttribute("href", image_string);
    $("body").append(pom);
    pom.click();
    pom.remove();
  }
};

function getNewick_from_node(this_node, tree) {

annotator = d => '';

function nodeDisplay(n) {
  if (!tree.isLeafNode(n)) {
    element_array.push("(");
    n.children.forEach(function(d, i) {
      if (i) {
        element_array.push(",");
      }
      nodeDisplay(d);
    });
    element_array.push(")");
  }

  if(n.data.name != 'root') {
    element_array.push(n.data.name);
  }
  element_array.push(annotator(n));

  let bl = tree.branch_length_accessor(n);

  if (bl !== undefined) {
    element_array.push(":" + bl);
  }
}

let element_array = [];
annotator = annotator || "";
nodeDisplay(this_node);

return element_array.join("")+";";

}

function newick_n_genes(tree, n_genes) {
    // aim for a tree with at least n_genes but no more than 3*n_genes
    // console.log(tree)

    if (query_gene_name.length > 0){
      var query_node = tree.getNodeByName(query_gene_name)
      var n = query_node
      // set attribute "path_to_target" first
      n.path_to_target = true
      while (n.parent) {
        n = n.parent
        n.path_to_target = true
      }

      // now start again at query node and go up to required level
      n = query_node
      while (n.parent && n.count().value <= n_genes) {
        if (n.parent.count().value > 3*n_genes) {
          break
        }
        n = n.parent
      }
    }
    return [getNewick_from_node(n, tree), n]
};

global_active_tree = false;

function display_tree(subtree_newick){
  
  // get current mode
  var radial = false
  var right_align = false
  if (global_active_tree)
  {
    radial = rendered_tree.radial()
    right_align = rendered_tree.options.alignTips == "right";
    // console.log(right_align)
    // console.log(rendered_tree.options.alignTips)
    
  }

  tree = new phylotree.phylotree(subtree_newick);
    global_tree = tree;

    rendered_tree = tree.render({
      container: "#tree_container",
    	'draw-size-bubbles' : false,
      'node-styler': node_colorizer_ed_v2,
      'zoom': false,
      'edge-styler': edge_colorizer
    });


  if (radial) {
    rendered_tree.radial(true)
  }
  if (right_align) {
    rendered_tree.alignTips(true)
  }
  if (radial || right_align) {
    rendered_tree.update()
  }

    // console.log(rendered_tree)
    rendered_tree.selectionLabel (current_selection_name);

    rendered_tree.countHandler (count => {
            $("#selected_branch_counter").text (function (d) {return count[current_selection_name];});
        }
    );

    // Get selection set names from parsed newick
    if(tree.parsed_tags.length) {
      selection_set = tree.parsed_tags;
    }

    // Until a cleaner solution to supporting both Observable and regular HTML
    $(rendered_tree.container).append(rendered_tree.show())

    // $("#selection_new").get(0).addEventListener(selection_menu_element_action,selection_handler_new,false);
    // $("#selection_rename").get(0).addEventListener(selection_menu_element_action,selection_handler_rename,false);
    // $("#selection_delete").get(0).addEventListener(selection_menu_element_action,selection_handler_delete,false);
    // $("#selection_delete").get(0).dispatchEvent (new CustomEvent (selection_menu_element_action,
    //                              {'detail' : ['cancel', null]}));
    // $("#selection_name_box").get(0).addEventListener(selection_menu_element_action,selection_handler_name_box,false);
    // $("#save_selection_name").get(0).addEventListener(selection_menu_element_action,selection_handler_save_selection_name,false);
    // $("#selection_name_dropdown").get(0).addEventListener(selection_menu_element_action,selection_handler_name_dropdown,false);
    update_selection_names();

   global_active_tree = true
   $("#save_image").on ("click", function (e) {
			datamonkey_save_image('svg', "#tree_container");
    });
}

$( document ).ready( function () {
    var n_show = 100
    global_full_tree = new phylotree.phylotree(initial_nwk_string);
    var ret_val = newick_n_genes(global_full_tree, n_show)
    var subtree_newick = ret_val[0];
    n_global_level = ret_val[1];
    display_tree(subtree_newick)
});

</script>

<script>

    var _warn = console.warn;

    console.warn = function() {
        if(arguments[0].includes('Phylotree User Warning')) {
                var warning_div = d3.select ("#main_display").insert ("div", ":first-child");
                warning_div.attr ("class", "alert alert-danger alert-dismissable")
                            .html (arguments[0]);
        }
        return _warn.apply(console, arguments);
    };


</script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


</body>
</html>
