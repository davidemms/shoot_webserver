<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset="utf-8">

    <title>SHOOT.bio Results: {{ query_gene_name }}</title>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-153557091-2', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


    <!-- <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootswatch/4.1.1/spacelab/bootstrap.min.css">

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <script src="//d3js.org/d3.v5.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='phylotree.js') }}"></script>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='phylotree.css') }}" />
    <style>

        nav {
          margin-bottom: 25px;
        }

        body {
            padding-bottom: 60px;
        }

        footer {
          margin-top: 25px;
        }

        .fa-rotate-45 {
          -webkit-transform: rotate(45deg);
          -moz-transform: rotate(45deg);
          -ms-transform: rotate(45deg);
          -o-transform: rotate(45deg);
          transform: rotate(45deg);
        }

        .fa-rotate-135 {
          -webkit-transform: rotate(135deg);
          -moz-transform: rotate(135deg);
          -ms-transform: rotate(135deg);
          -o-transform: rotate(135deg);
          transform: rotate(135deg);
        }

        @media (max-width: 800px) { 
          .container {
            padding: 0px;
            margin-left: 30px;
            margin-right: 30px;
          }
        }

        .btn {
          height: 30px;
        }

        .query_gene {
          color:#2b8cbe;
        }

        #toolbar {
          display: flex;
          justify-content: space-between;
          width: 550px;
        }
        
        #controls {
          position: fixed;
          left: 5px;
        }

        #orthologs_table {
          margin-top: 50px;
          max-width: 800px;
        }
        #orthologs_table td+td {
          color: #2ca25f; 
        }
        #orthologs_table tr td:first-child { 
          font-weight: bold;
        }
        #orthologs table tr td {
          height: auto;
        }
   </style>
</head>

<body>

<!--
###############################################################################################################################
-->
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

<div class="container"></div>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <a class="navbar-brand mb-0 h1" href="/">SHOOT.bio: sprout a branch on the tree of life</a>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="navbar-nav">

      <li class="nav-item dropdown">
        <a href="#" id="newick-dropdown" class="nav-link dropdown-toggle" role="button" data-toggle="modal" data-target="#newick_export_modal">Export tree <b class="caret"></b></a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('download_sequences') }}" class="nav-link" role="button" id="fasta_download_nav">Export sequences</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('faq') }}" class="nav-link" role="link" target="_blank">FAQ</a>
      </li>
    </ul>
  </div><!-- /.container-fluid -->
</nav>
</div>

<div class="modal" id = 'newick_export_modal' role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body" id = 'newick_body'>
         <textarea id = 'nwk_export_spec' autofocus = true placeholder = "" style = 'width: 100%; height: 100%' rows = 20></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal" id = 'progress_model'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Task in progress</h4>
      </div>
      <div class="modal-body" id = 'progress_model_body'>
         
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id = 'controls'>
    <form id = 'controls_form' style = 'width:200px;'>
    </form>
</div>

{% if error %}
<div class="alert alert-warning" role="alert">  
<h1>Messages:</h1>
<p>{{ error }}</p>
</div>
{% endif %}

<div class="alert alert-warning" role="alert" id="outgroup_warning" style="display:none" >  
  Your gene has been placed close to the root of the tree and so could be an outgroup to all other genes in the tree. 
  If you have not done so, use a SHOOT database with a phylogenetic range that includes your species. Otherwise, consider 
  whether the tree should be rooted on your query gene.
</div>

<div class="container" id="main_text">
  <div class="container">
    <!-- <p class="lead">Query gene: <span class="query_gene">{{ query_gene_name }}</span></p> -->
    <h2>Query gene: <span class="query_gene">{{ query_gene_name }}</span></h2>
    <p class="lead">Results will be available for 7 days here: <a href="{{ results_url }}">{{ results_url }}</a></p>    
  </div>
  <div class="container" style="margin-top: 1em">
    <p class="lead">Tree visualisation powered by <a href="https://doi.org/10.1186/s12859-018-2283-2">phylotree.js</a></span></p>
  </div>
</div>

<div class = 'container' id = "main_display">
  <div class = 'row'>
    <div class = 'col-md-auto'>
      <div class="btn-toolbar" role="toolbar" id='toolbar'>
        <div class="btn-group">
          <button type="button" class="btn btn-light btn-sm" data-direction = 'vertical' data-amount = '1' title = "Expand vertical spacing">
              <i class="fa fa-arrows-v" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" data-direction = 'vertical' data-amount = '-1' title = "Compress vertical spacing">
              <i class="fa  fa-compress fa-rotate-135" ></i>
          </button>
          <button type="button" class="btn btn-light btn-sm" data-direction = 'horizontal' data-amount = '1' title = "Expand horizonal spacing">
              <i class="fa fa-arrows-h" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" data-direction = 'horizontal' data-amount = '-1' title = "Compress horizonal spacing">
              <i class="fa  fa-compress fa-rotate-45" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_ascending" title = "Sort deepest clades to the bototm">
              <i class="fa fa-sort-amount-asc" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_descending" title = "Sort deepsest clades to the top">
              <i class="fa fa-sort-amount-desc" ></i>
          </button>
           <button type="button" class="btn btn-light btn-sm" id = "sort_original" title = "Restore original order">
              <i class="fa fa-sort" ></i>
          </button>
          <!-- <button type="button" class="btn btn-light btn-sm" id = "collapse_wider_tree" title = "Collapse wider tree">
             <i class="fa compress-arrows-alt" ></i>
         </button> -->
          
           <button type="button" class="btn btn-light btn-sm" id = "save_image" title = "Save image">
              <i class="fa fa-picture-o" ></i>
          </button>
        </div>

        <div class="btn-group" role="group">
          <button class="btn btn-light btn-sm active phylotree-layout-mode" data-mode = "linear">
            Linear
          </button>
          <button class="btn btn-light btn-sm phylotree-layout-mode" data-mode = "radial" >
            Radial
          </button>
        </div>
        <div class="btn-group" role="group">
          <button class="btn btn-light btn-sm active phylotree-align-toggler" data-align= "left">
              <i class="fa fa-align-left" ></i>
          </button>
          <button class="btn btn-light btn-sm phylotree-align-toggler" data-align= "right">
              <i class="fa fa-align-right" ></i>
          </button>
        </div>
      </div>

      <div class="btn-group" role="group">
        <div class="container">
          <div class="col">
            <div class="row justify-content-center">
              Show more genes. Tree level: 
            </div>
            <div class="row justify-content-center">
              <div class="btn-group">
                <button class="btn btn-light btn-sm" id = "tree_level_up_1" title = "Show 1 extra level in tree">+1</button>
                <button class="btn btn-light btn-sm" id = "tree_level_up_5" title = "Show 5 extra levels in tree">+5</button>
                <button class="btn btn-light btn-sm" id = "tree_level_all" title = "Show all levels in tree">All</button>
                <button class="btn btn-light btn-sm" id = "tree_level_reset" title = "Reset tree">Re.</button>
                <button class="btn btn-light btn-sm" id = "tree_level_down_5" title = "Show 5 fewer levels in tree">-5</button>
                <button class="btn btn-light btn-sm" id = "tree_level_down_1" title = "Show 1 fewer level in tree">-1</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!--div class = 'col-md-4'>
      <label class = "pull-right"><b>Selected</b> <span class="badge badge-secondary" id="selected_branch_counter">0</span> <b>branches with current label</b></label>
    </div -->
  </div>

  <!-- <div class="container-fluid"> -->
  <div class = 'row'>
    <div class = 'col-sm-'>
        <div id = 'tree_container' class = 'tree-widget'></div>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-sm-4'></div>
        <table class="table" id="orthologs_table"></table>
    </div>
  </div>
  <!-- </div> -->
</div>

<footer class="footer fixed-bottom bg-light">
<!-- <footer class="navbar fixed-bottom bg-light pull-left"> -->
  <div class="container">
    <span class="text-muted">SHOOT.bio: phylogenetic gene search and ortholog inference. David Emms & Steven Kelly &copy; 2021</span>
  </div>
</footer>


<!--
###############################################################################################################################
-->

<script>

{% if error %}
  q_error = true;
{% else %}
  q_error = false;
{% endif %}

var phylotree_extensions = new Object ();

$('#newick_export_modal').on('show.bs.modal', function (e) {
    if (q_error) {
      return
    }
    $('textarea[id$="nwk_export_spec"]').val(
      global_subtree_newick
    );

})

$("#display_tree").on ("click", function (e) {
    tree.options ({'branches' : 'straight'}, true);
});

$("#mp_label").on ("click", function (e) {
    tree.maxParsimony (true, 'Foreground');
});

$ ("[data-direction]").on ("click", function (e) {
    var which_function = $(this).data ("direction") == 'vertical' ? tree.display.spacing_x.bind(tree.display) : tree.display.spacing_y.bind(tree.display);
    which_function (which_function () + (+ $(this).data ("amount"))).update();
});


$(".phylotree-layout-mode").on ("click", function (e) {

    if (rendered_tree.radial () != ($(this).data ("mode") == "radial")) {
        $('.phylotree-layout-mode').toggleClass('active');
        rendered_tree.radial(!rendered_tree.radial()).update();
    }
});


$("#toggle_animation").on ("click", function (e) {
    var current_mode = $(this).hasClass('active');
    $(this).toggleClass('active');
    tree.options ({'transitions' : !current_mode} );
});


$(".phylotree-align-toggler").on ("click", function (e) {

  var button_align = $(this).data ("align");
  var tree_align = rendered_tree.options.alignTips;

  if (tree_align != button_align) {
      rendered_tree.alignTips(button_align == "right");
      $('.phylotree-align-toggler').toggleClass('active');
      rendered_tree.update();
  }
  // console.log(rendered_tree.options.alignTips)
});



function sort_nodes (asc) {

    tree.resortChildren (
      function(a, b) { return (b.height - a.height || b.value - a.value) * (asc ? 1 : -1); }
    );

}

$("#sort_original").on ("click", function (e) {
    tree.resortChildren (function (a,b) {
        return a["original_child_order"] - b["original_child_order"];
    });
});

$("#sort_ascending").on ("click", function (e) {
    sort_nodes (true);
    rendered_tree.update();
});

$("#sort_descending").on ("click", function (e) {
    sort_nodes (false);
    rendered_tree.update();
});

$("#and_label").on ("click", function (e) {
    rendered_tree.internalLabel (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] && prev; }, true)}, true);
});

$("#or_label").on ("click", function (e) {
    rendered_tree.internalLabel (function (d) { return d.reduce (function (prev, curr) { return curr[current_selection_name] || prev; }, false)}, true);
});


$("#select_all").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return true;});
});

$("#select_all_internal").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return !tree.isLeafNode (d.target);});
});

$("#select_all_leaves").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return tree.isLeafNode (d.target);});
});


$("#select_none").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return false;});
});

$("#clear_internal").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return tree.isLeafNode (d.target) ? d.target[current_selection_name] : false;});
});

$("#clear_leaves").on ("click", function (e) {
    rendered_tree.modifySelection (function (d) { return !tree.isLeafNode (d.target) ? d.target[current_selection_name] : false;});
});


$("#display_dengrogram").on ("click", function (e) {
    rendered_tree.options ({'branches' : 'step'}, true);
});

// $("#branch_filter").on ("input propertychange", function (e) {
//    var filter_value = $(this).val();

//    var rx = new RegExp (filter_value,"i");

//    rendered_tree.modifySelection (n => {
//      if(!n.target.data.name) {
//        return false;
//      }
//       m = n.target.data.name.search (rx)
//       return filter_value.length && m != -1;
//    },"tag");
// });

function default_tree_settings () {
    tree = phylotree();
    tree.branchLength (null);
    tree.branchName (null);
    rendered_tree.radial (false).separation (function (a,b) {return 0;})
}

function up_n(n){
  if (!i_global_level) {
    return
  }
  try {
    var n_level = n_global_level
    var i_level = i_global_level
    if (!n_level.parent) {
      return
    }
    var i;
    for (i = 0; i < n; i++){
      if (n_level.parent){
        n_level = n_level.parent
        i_level++
      }
      else{
        break
      }
    }
    if (n_level != n_global_level) {
      subtree_newick = getNewick_from_node(n_level, global_full_tree)
      n_global_level = n_level
      i_global_level = i_level
      display_tree(subtree_newick)
    }
  }
  catch (e) {
  }
}

function down_n(n){
  if (!i_global_level) {
    return
  }
  try {
    var n_level = n_global_level
    var i_level = i_global_level
    if (!n_level.children) {
      return
    }
    var i;
    for (i = 0; i < n; i++){
      if (n_level.children){
        for (ch of n_level.children)
        {
          if (ch.path_to_target){
            break
          }
        }
        if (!ch.path_to_target){
          break
        }
        n_level = ch
        i_level--
      }
      else{
        break
      }
    }
    if (!n_level.children){
      n_level = n_level.parent
      i_level++
    }
    if (n_level != n_global_level) {
      subtree_newick = getNewick_from_node(n_level, global_full_tree)
      n_global_level = n_level
      i_global_level = i_level
      display_tree(subtree_newick)
    }
  }
  catch (e) {
  }
}

$("#tree_level_up_1").on ("click", function (e) {
  up_n(1)
});

$("#tree_level_up_5").on ("click", function (e) {
  up_n(5)
});

$("#tree_level_down_1").on ("click", function (e) {
  down_n(1)
});

$("#tree_level_down_5").on ("click", function (e) {
  down_n(5)
});

$("#tree_level_all").on ("click", function (e) {
  up_n(Number.MAX_SAFE_INTEGER)
});

$("#tree_level_reset").on ("click", function (e) {
  if (!i_global_level) {
    return
  }
  n_global_level = n_global_level_orig;
  i_global_level = i_global_level_orig;
  display_tree(global_subtree_newick_orig);
});


function node_colorizer (element, data) {

try{

   var count_class = 0;
    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("fill", color_scheme(i), i == current_selection_id ?  "important" : null);}});

    if (count_class > 1) {

    } else {
        if (count_class == 0) {
            element.style ("fill", null);
       }
    }

}
catch (e) {
}

}

{% if gene_webpage_url %}
    gene_webpage_url = "{{ gene_webpage_url }}";
{% else %}
  gene_webpage_url = "";
{% endif %}

function node_colorizer_ed_v2 (element, data) {
try{
  if (!data.children) {
    // deal with name truncation in the tree
    if (data.data.name.substring(0,75) == query_gene_name.substring(0,75)) {
      element.style ("fill", "#2b8cbe", "important");
    }
    else {
      if (orthologs.has(data.data.name))  {
        element.style ("fill", "#2ca25f", "important");
      }
      if (gene_webpage_url.includes("fungi.ensembl.org")) {
        var gene_id = data.data.name.split("_").slice(2, 4).join("_")
      }
      else {
        var gene_id = data.data.name.split("_")[2]
      }
      if (gene_webpage_url.length != 0 && gene_id.length != 0) {
        var gene_link = gene_webpage_url + gene_id
        element.on("click",function(d,i) { window.open(gene_link, "_blank"); });
      }
    }
  }
  else if (data.depth != 0)
  {
    // show support values - now done the way recommended here: https://github.com/veg/phylotree.js/issues/397
    // s = data.data.bootstrap_values.toString()
    // element.append("svg:text")
    //       .attr("dx", -6)
    //       .attr("dy", -6)
    //       .attr("text-anchor", 'end')
    //       .attr('font-size', '11px')
    //       .attr('fill', '#ccc')
    //       .text(s)
  }
  if (data.data.name == 'root') {
      element.style ("display", "none");
  }
  else if (/[A-Za-z]/.test(data.data.name) && data.children) {
      // highlight taxonomic labels on internal nodes for species trees. Not (numeric)
      // bootstrap values. Ignore 'e' or 'E' in scientific notation, shouldn't occur.
        element.style ("fill", "#0342ad", "important");
  }
}
catch (e) {
}
}

function edge_colorizer (element, data) {
try {
    var count_class = 0;

    selection_set.forEach (function (d,i) { if (data[d]) {count_class ++; element.style ("stroke", color_scheme(i), i == current_selection_id ?  "important" : null);}});

    if (count_class > 1) {
        element.classed ("branch-multiple", true);
    } else
    if (count_class == 0) {
             element.style ("stroke", null)
                   .classed ("branch-multiple", false);
    }
}
catch (e) {
}

}

var valid_id = new RegExp ("^[\\w]+$");

$("#selection_name_box").on ("input propertychange", function (e) {

   var name = $(this).val();

   var accept_name = (selection_set.indexOf (name) < 0) &&
                     valid_id.exec (name);

   d3.select ("#save_selection_button").classed("disabled", accept_name ? null : true );

});

$("#selection_rename").on ("click", function (e) {

    d3.select ("#save_selection_button")
           .classed ("disabled",true)
           .on ("click", function (e) { // save selection handler
                var old_selection_name = current_selection_name;
                selection_set[current_selection_id] = current_selection_name = $("#selection_name_box").val();

                if (old_selection_name != current_selection_name) {
                    tree.update_key_name (old_selection_name, current_selection_name);
                    update_selection_names (current_selection_id);
                }
                send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                             {'detail' : ['save', this]}));
           });

    d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });

    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['rename', this]}));
    e.preventDefault    ();

});

$("#selection_delete").on ("click", function (e) {

    rendered_tree.updateKeyName (selection_set[current_selection_id], null)
    selection_set.splice (current_selection_id, 1);

    if (current_selection_id > 0) {
        current_selection_id --;
    }
    current_selection_name = selection_set[current_selection_id];
    update_selection_names (current_selection_id)
    $("#selection_name_box").val(current_selection_name)


    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
    e.preventDefault    ();

});

$("#selection_new").on ("click", function (e) {

    d3.select ("#save_selection_button")
               .classed ("disabled",true)
               .on ("click", function (e) { // save selection handler
                    current_selection_name = $("#selection_name_box").val();
                    current_selection_id = selection_set.length;
                    selection_set.push (current_selection_name);
                    update_selection_names (current_selection_id);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['save', this]}));
              });

     d3.select ("#cancel_selection_button")
               .classed ("disabled",false)
               .on ("click", function (e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['cancel', this]}));
              });

    send_click_event_to_menu_objects (new CustomEvent (selection_menu_element_action,
                                 {'detail' : ['new', this]}));
    e.preventDefault    ();

});

function send_click_event_to_menu_objects (e) {
    $("#selection_new, #selection_delete, #selection_rename, #save_selection_name, #selection_name_box, #selection_name_dropdown").get().forEach (
        function (d) {
            d.dispatchEvent (e);
        }
    );
}

function update_selection_names (id, skip_rebuild) {

    skip_rebuild = skip_rebuild || false;
    id = id || 0;

    current_selection_name = selection_set[id];
    current_selection_id = id;

    if (!skip_rebuild) {
        d3.selectAll (".selection_set").remove();

        d3.select ("#selection_name_dropdown")
          .selectAll (".selection_set")
          .data (selection_set)
          .enter()
          .append ("a")
          .attr ("class", "selection_set dropdown-item")
          .attr ("href", "#")
          .text (function (d) { return d;})
          .style ("color", function (d,i) {return color_scheme(i);})
          .on ("click", function (d,i) {update_selection_names (i,true);});

    }


    d3.select ("#selection_name_box")
      .style ("color",  color_scheme(id))
      .property ("value", current_selection_name);

    rendered_tree.selectionLabel(selection_set[id]);
    rendered_tree.update();
}

var width  = 800, //$(container_id).width(),
    height = 800, //$(container_id).height()
    selection_set = ['Foreground'],
    current_selection_name = $("#selection_name_box").val(),
    current_selection_id = 0,
    max_selections       = 10;
    color_scheme = d3.scaleOrdinal(d3.schemeCategory10),
    selection_menu_element_action = "phylotree_menu_element_action";

{% if newick_str %}
    var initial_nwk_string = "{{ newick_str }}";
    var query_gene_name = "{{ query_gene_name }}";
{% else %}
    var initial_nwk_string = "()myroot";
    var query_gene_name = "";
{% endif %}
var container_id = '#tree_container';

//var tree = phylotree.phylotree(test_string);
            //.size([height, width]);

//window.setInterval (function () {});

var example_controls = d3.select ("#controls_form").append ("form");

//var svg = d3.select(container_id).append("svg")
//    .attr("width", width)
//    .attr("height", height);
    

function selection_handler_name_box (e) {
    var name_box = d3.select (this);
     switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            name_box.property ("disabled", true)
                    .style ("color",  color_scheme(current_selection_id));

            break;
        case 'new':
            name_box.property ("disabled", false)
                    .property ("value", "new_selection_name")
                    .style ("color",  color_scheme(selection_set.length));
            break;
        case 'rename':
           name_box.property ("disabled", false);
           break;
    }

}

function selection_handler_new (e) {
    var element = d3.select (this);
    $(this).data('tooltip', false);
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == max_selections) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'Up to ' + max_selections + ' are allowed', 'placement' : 'left'});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;
    }
}

function selection_handler_rename (e) {
    var element = d3.select (this);
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_save_selection_name (e) {
    var element = d3.select (this);
    element.style ("display", (e.detail[0] == "save" || e.detail[0] == "cancel") ? "none" : null);
}

function selection_handler_name_dropdown (e) {
    var element = d3.select (this).selectAll (".selection_set");
    element.classed ("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
}

function selection_handler_delete (e) {
    var element = d3.select (this);
    $(this).tooltip('dispose');
    switch (e.detail[0]) {
        case 'save':
        case 'cancel':
            if (selection_set.length == 1) {
                element.classed ("disabled", true);
                    $(this).tooltip ({'title' : 'At least one named selection set <br> is required;<br>it can be empty, however', 'placement' : 'bottom', 'html': true});
            } else {
                element.classed ("disabled", null);
            }
            break;
        default:
            element.classed ("disabled", true);
            break;
  }
}

var datamonkey_save_image = function(type, container) {
  var prefix = {
    xmlns: "http://www.w3.org/2000/xmlns/",
    xlink: "http://www.w3.org/1999/xlink",
    svg: "http://www.w3.org/2000/svg"
  };

  function get_styles(doc) {
    function process_stylesheet(ss) {
      try {
        if (ss.cssRules) {
          for (var i = 0; i < ss.cssRules.length; i++) {
            var rule = ss.cssRules[i];
            if (rule.type === 3) {
              // Import Rule
              process_stylesheet(rule.styleSheet);
            } else {
              // hack for illustrator crashing on descendent selectors
              if (rule.selectorText) {
                if (rule.selectorText.indexOf(">") === -1) {
                  styles += "\n" + rule.cssText;
                }
              }
            }
          }
        }
      } catch (e) {
        console.log("Could not process stylesheet : " + ss); // eslint-disable-line
      }
    }

    var styles = "",
      styleSheets = doc.styleSheets;

    // if (styleSheets) {
    //   for (var i = 0; i < styleSheets.length; i++) {
    //     console.log(styleSheets[i])
    //     process_stylesheet(styleSheets[i]);
    //   }
    // }

    // Can't access cross-origin stylesheets for security reasons, so only process 
    // the phylotree.css, that is enough. Otherwise the styling fails.
    var ss_phylotree = $('link[href="' + "{{ url_for('static', filename='phylotree.css') }}" + '"]')[0].sheet;
    // console.log(ss_phylotree)
    process_stylesheet(ss_phylotree)

    return styles;
  }

  var svg = $(container).find("svg")[0];
  if (!svg) {
    svg = $(container)[0];
  }

  var styles = get_styles(window.document);

  svg.setAttribute("version", "1.1");

  var defsEl = document.createElement("defs");
  svg.insertBefore(defsEl, svg.firstChild);

  var styleEl = document.createElement("style");
  defsEl.appendChild(styleEl);
  styleEl.setAttribute("type", "text/css");

  // removing attributes so they aren't doubled up
  svg.removeAttribute("xmlns");
  svg.removeAttribute("xlink");

  // These are needed for the svg
  if (!svg.hasAttributeNS(prefix.xmlns, "xmlns")) {
    svg.setAttributeNS(prefix.xmlns, "xmlns", prefix.svg);
  }

  if (!svg.hasAttributeNS(prefix.xmlns, "xmlns:xlink")) {
    svg.setAttributeNS(prefix.xmlns, "xmlns:xlink", prefix.xlink);
  }

  var source = new XMLSerializer()
    .serializeToString(svg)
    .replace("</style>", "<![CDATA[" + styles + "]]></style>");
  var doctype =
    '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';
  var to_download = [doctype + source];
  var image_string =
    "data:image/svg+xml;base66," + encodeURIComponent(to_download);

  if (navigator.msSaveBlob) {
    // IE10
    download(image_string, "image.svg", "image/svg+xml");
  } else if (type == "png") {
    b64toBlob(
      image_string,
      function(blob) {
        var url = window.URL.createObjectURL(blob);
        var pom = document.createElement("a");
        pom.setAttribute("download", "image.png");
        pom.setAttribute("href", url);
        $("body").append(pom);
        pom.click();
        pom.remove();
      },
      function(error) {
        console.log(error); // eslint-disable-line
      }
    );
  } else {
    var pom = document.createElement("a");
    pom.setAttribute("download", "image.svg");
    pom.setAttribute("href", image_string);
    $("body").append(pom);
    pom.click();
    pom.remove();
  }
};

function getNewick_from_node(this_node, tree) {

annotator = d => '';

function nodeDisplay(n) {
  if (!tree.isLeafNode(n)) {
    element_array.push("(");
    n.children.forEach(function(d, i) {
      if (i) {
        element_array.push(",");
      }
      nodeDisplay(d);
    });
    element_array.push(")");
  }

  if(n.data.name != 'root') {
    element_array.push(n.data.name);
  }
  element_array.push(annotator(n));

  let bl = tree.branch_length_accessor(n);

  if (bl !== undefined) {
    element_array.push(":" + bl);
  }
}

let element_array = [];
annotator = annotator || "";
nodeDisplay(this_node);

return element_array.join("")+";";

}

function union(setA, setB) {
    let _union = new Set(setA)
    for (let elem of setB) {
        _union.add(elem)
    }
    return _union
}

function intersection(setA_larger, setB_smaller) {
    let _intersection = new Set()
    for (let elem of setB_smaller) {
        if (setA_larger.has(elem))
        _intersection.add(elem)
    }
    return _intersection
}

function species_from_gene(gene){
  var x = gene.split("_", 2)
  return x[0] + "_" + x[1]
}

function is_overlap(setA_larger, setB_smaller){
    for (let elem of setB_smaller) {
        if (setA_larger.has(elem)) {
            return true
        }
    }
    return false
}

function get_species_below(node) {
  // get the **Set** of species below a node
  // will use a recursive function as I've limited the size of the tree
  if (node.children){
    var species_below = new Set()
    for (let child of node.children) {
        species_below = union(species_below, get_species_below(child))
      }
      return species_below
    }
  else {
    return new Set([species_from_gene(node.data.name), ])
  }
}

function get_genes_below(node) {
  // get the **List** of genes below a node
  // will use a recursive function as I've limited the size of the tree
  if (node.children){
    var genes = []
    for (let child of node.children) {
      genes.push(...get_genes_below(child))
      }
      return genes
    }
  else {
    var genes = [node.data.name, ]
    return genes
  }
}

function warn_if_outgroup(tree) {
  if (q_error) {
    return
  }
  var n = tree.getNodeByName(query_gene_name)
  var root = tree.getRootNode()
  var n_up = 3   // this is one beyond the closest it could ever be to the root
  while ((n.parent) && n_up > 0){
    n = n.parent
    n_up--
    if (n == root) {
      $("#outgroup_warning").show()
    }
  }
}

function get_orthologs(tree) {
  try {
    orthologs = []
    var query_node = tree.getNodeByName(query_gene_name)
    var species_below = new Set()
    if (query_node){
      // start at the query node, don't record a species for it
      var n = query_node
      while (n.parent) {
        var n_prev = n
        n = n.parent
        var new_species_below = new Set()
        for (let ch of n.children)
        {
          if (ch != n_prev){
            // allow non-binary nodes
            new_species_below = union(get_species_below(ch), new_species_below)
            
          }
        }
        // console.log(new_species_below)
        // if sets overlap then duplication node
        var n1 = species_below.size
        var n2 = new_species_below.size
        var prev_species_below = species_below
        species_below = union(species_below, new_species_below)
        var o = n1 + n2 - species_below.size
        var m = (n1 < n2) ? n1 : n2
          // allow on overlap of 1 if min(species) >= 4 or overlap or 2 if min(species) >= 9
        if (o == 0 || (m >= 4 && o == 1) || (m >= 9 && o ==2)){
          // console.log("orthologs")
          // speciation => orthologs
          for (let ch of n.children)
          {
            if (ch != n_prev){
              var gb = get_genes_below(ch)
              // exclude any in the overlap
              if (o > 0) {
                var overlap = (n1 < n2) ? intersection(new_species_below, prev_species_below) : intersection(prev_species_below, new_species_below)
                gb = gb.filter(gene_name => !overlap.has(species_from_gene(gene_name)))
              }
              orthologs.push(...gb)
            }
          }
        }
      }
    }
  }
  catch (e) {
  }
  orthologs = new Set(orthologs)
}

function newick_n_genes(tree, n_genes) {
    // set the initial zoom level to aim for a tree with at least n_genes but no more than 3*n_genes

    var query_node = tree.getNodeByName(query_gene_name)
    if (query_node){
      var n = query_node
      // set attribute "path_to_target" first
      n.path_to_target = true
      while (n.parent) {
        n = n.parent
        n.path_to_target = true
      }

      // now start again at query node and go up to required level
      n = query_node
      var i_level = 0
      while (n.parent && n.count().value <= n_genes) {
        if (n.parent.count().value > 3*n_genes) {
          break
        }
        n = n.parent
        i_level++
      }
      return [getNewick_from_node(n, tree), n, i_level]
    }
    else {
      return null
    }
};

global_active_tree = false;
orthologs = new Set()

function display_tree(subtree_newick){
  // get current mode
  if (i_global_level) {
    // E.g. Not defined if displaying a species tree, which hasn't got these navigation features
    document.getElementById("fasta_download_nav").href = "{{ url_for('download_sequences') }}?tl=" + i_global_level.toString()
  }
  var radial = false
  var right_align = false
  if (global_active_tree)
  {
    radial = rendered_tree.radial()
    right_align = rendered_tree.options.alignTips == "right";
  }

  global_subtree_newick = subtree_newick
  tree = new phylotree.phylotree(global_subtree_newick);
    global_tree = tree;

    rendered_tree = tree.render({
      container: "#tree_container",
    	'draw-size-bubbles' : false,
      'node-styler': node_colorizer_ed_v2,
      'zoom': false,
      'edge-styler': edge_colorizer,
      'internal-names':true,
      'align-tips':false
    });

  if (radial) {
    rendered_tree.radial(true)
  }
  if (right_align) {
    rendered_tree.alignTips(true)
  }
  if (radial || right_align) {
    rendered_tree.update()
  }

    rendered_tree.selectionLabel (current_selection_name);

    rendered_tree.countHandler (count => {
            $("#selected_branch_counter").text (function (d) {return count[current_selection_name];});
        }
    );

    // Get selection set names from parsed newick
    if(tree.parsed_tags.length) {
      selection_set = tree.parsed_tags;
    }

    // Until a cleaner solution to supporting both Observable and regular HTML
    $(rendered_tree.container).append(rendered_tree.show())

    // $("#selection_new").get(0).addEventListener(selection_menu_element_action,selection_handler_new,false);
    // $("#selection_rename").get(0).addEventListener(selection_menu_element_action,selection_handler_rename,false);
    // $("#selection_delete").get(0).addEventListener(selection_menu_element_action,selection_handler_delete,false);
    // $("#selection_delete").get(0).dispatchEvent (new CustomEvent (selection_menu_element_action,
    //                              {'detail' : ['cancel', null]}));
    // $("#selection_name_box").get(0).addEventListener(selection_menu_element_action,selection_handler_name_box,false);
    // $("#save_selection_name").get(0).addEventListener(selection_menu_element_action,selection_handler_save_selection_name,false);
    // $("#selection_name_dropdown").get(0).addEventListener(selection_menu_element_action,selection_handler_name_dropdown,false);
    update_selection_names();

   build_orthologs_table();
   global_active_tree = true
}

g_table_built = false
function build_orthologs_table(){
  if (g_table_built){
    return
  }
  // create a dict first
  d_ologs = {}
  sp_list_ologs = [] 
  for (let g of orthologs){
    var t = g.split("_")
    var sp = t[0] + " " + t[1]
    var g_bare = t.slice(2).join("_")
    if (sp in d_ologs){
      d_ologs[sp].push(g_bare)
    }
    else {
      d_ologs[sp] = [g_bare,]
      sp_list_ologs.push(sp)
    }
  }

  // create the table
  let table = document.getElementById("orthologs_table");
  let thead = table.createTHead();
  let row = thead.insertRow();
  let th = document.createElement("th");
  let text = document.createTextNode("Species");
  th.appendChild(text);
  row.appendChild(th);
  th = document.createElement("th");
  text = document.createTextNode("Orthologs");
  th.appendChild(text);
  row.appendChild(th);
  for (let sp of sp_list_ologs){
    let row = table.insertRow();
    let cell = row.insertCell();
    let text = document.createTextNode(sp);
    cell.appendChild(text);
    cell = row.insertCell();
    text = document.createTextNode(d_ologs[sp].join(", "));
    cell.appendChild(text);
  }
  g_table_built = true
}


$( document ).ready( function () {
    if (q_error) {
      $(main_display).hide()
      $(main_text).hide()
      return
    }
    // $("#outgroup_warning").hide()
    i_global_level = null
    var n_show = 30;
    global_full_tree = new phylotree.phylotree(initial_nwk_string);
    var ret_val = newick_n_genes(global_full_tree, n_show)
    if (ret_val) {
      // then we are displaying a gene tree with an identified target node
      var subtree_newick = ret_val[0];
      n_global_level = ret_val[1];
      i_global_level = ret_val[2]
      warn_if_outgroup(global_full_tree)
      get_orthologs(global_full_tree)
      display_tree(subtree_newick)
      global_subtree_newick_orig = subtree_newick;
      n_global_level_orig = n_global_level;
      i_global_level_orig = i_global_level
    }
    else {
      $('#orthologs_table').hide()
      var x = document.getElementById("fasta_download_nav");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }
      display_tree(initial_nwk_string)
    }
    // create the function (only once) for saving the image
    $("#save_image").on ("click", function (e) {
        datamonkey_save_image('svg', "#tree_container");
      });
    // var warning_div = d3.select ("#main_display").insert ("div", ":first-child");
    //             warning_div.attr ("class", "alert alert-danger alert-dismissable")
    //                         .html ("This is where a warning goes");
});

</script>

<script>

    var _warn = console.warn;

    console.warn = function() {
        if (q_error) {
          return
        }
        if(arguments[0].includes('Phylotree User Warning')) {
                var warning_div = d3.select ("#main_display").insert ("div", ":first-child");
                warning_div.attr ("class", "alert alert-danger alert-dismissable")
                            .html (arguments[0]);
        }
        return _warn.apply(console, arguments);
    };


</script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


</body>
</html>
