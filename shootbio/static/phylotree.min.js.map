{"version":3,"file":"phylotree.min.js","sources":["../src/nodes.js","../src/formats/newick.js","../src/formats/nexus.js","../src/formats/phyloxml.js","../src/formats/registry.js","../src/formats/nexml.js","../src/formats/beast.js","../src/traversal.js","../src/branches.js","../src/rooting.js","../src/render/coordinates.js","../src/render/radial.js","../src/render/cartesian.js","../src/render/helpers.js","../src/render/options.js","../src/render/nodes.js","../src/render/clades.js","../src/render/edges.js","../src/render/events.js","../src/render/menus.js","../src/render/draw.js","../src/main.js","../src/metrics/pairwise-distances.js","../src/metrics/root-to-tip.js","../src/max-parsimony.js","../src/export.js","../src/extract-dates.js","../src/metrics/center-of-tree.js","../src/clustering/cluster-picker.js","../src/metrics/compute-midpoint.js","../src/clustering/phylopart.js","../src/metrics/sackins.js"],"sourcesContent":["import * as _ from \"underscore\";\n\n// These methods are part of the Phylotree object\n\nexport function graftANode(graft_at, new_child, new_parent, lengths) {\n\n  let nodes = this.nodes.descendants();\n\n  if (graft_at.parent) {\n    let node_index = nodes.indexOf(graft_at);\n\n    if (node_index >= 0) {\n      let parent_index = graft_at.parent.children.indexOf(graft_at);\n\n      let new_split = {\n          name: new_parent,\n          parent: graft_at.parent,\n          attribute: lengths ? lengths[2] : null,\n          original_child_order: graft_at[\"original_child_order\"]\n        },\n        new_node = {\n          name: new_child,\n          parent: new_split,\n          attribute: lengths ? lengths[1] : null,\n          original_child_order: 2\n        };\n\n      new_split[\"children\"] = [graft_at, new_node];\n      graft_at[\"parent\"].children[parent_index] = new_split;\n      graft_at.parent = new_split;\n      graft_at[\"attribute\"] = lengths ? lengths[0] : null;\n      graft_at[\"original_child_order\"] = 1;\n    }\n  }\n\n  return this;\n\n}\n\n/**\n * Delete a given node.\n *\n * @param {Node} The node to be deleted, or the index of such a node.\n * @returns The current ``phylotree``.\n */\nexport function deleteANode(index) {\n  let nodes = this.nodes.descendants();\n\n  if (typeof index != \"number\") {\n    return this.deleteANode(nodes.indexOf(index));\n  }\n\n  if (index > 0 && index < nodes.length) {\n    let node = nodes[index];\n\n    if (node.parent) {\n      // can only delete nodes that are not the root\n      let delete_me_idx = node.parent.children.indexOf(node);\n\n      if (delete_me_idx >= 0) {\n        nodes.splice(index, 1);\n\n        if (node.children) {\n          node.children.forEach(function(d) {\n            d[\"original_child_order\"] = node.parent.children.length;\n            node.parent.children.push(d);\n            d.parent = node.parent;\n          });\n        }\n\n        if (node.parent.children.length > 2) {\n          node.parent.children.splice(delete_me_idx, 1);\n        } else {\n          if (node.parent.parent) {\n            node.parent.parent.children[\n              node.parent.parent.children.indexOf(node.parent)\n            ] =\n              node.parent.children[1 - delete_me_idx];\n            node.parent.children[1 - delete_me_idx].parent = node.parent.parent;\n            nodes.splice(nodes.indexOf(node.parent), 1);\n          } else {\n            nodes.splice(0, 1);\n            nodes.parent = null;\n            delete nodes.data[\"attribute\"];\n            delete nodes.data[\"annotation\"];\n            delete nodes.data[\"original_child_order\"];\n            nodes.name = \"root\";\n            nodes.data.name = \"root\";\n          }\n        }\n      }\n    }\n  }\n\n  return this;\n}\n\n/**\n * Get the tips of the tree\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function getTips() {\n  // get all nodes that have no nodes\n  return _.filter(this.nodes.descendants(), n => {\n    return !_.has(n, \"children\");\n  });\n}\n\n/**\n * Get the internal nodes of the tree\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function getInternals() {\n  // get all nodes that have no nodes\n  return _.filter(this.nodes.descendants(), n => {\n    return _.has(n, \"children\");\n  });\n}\n\n\n/**\n * Get the root node.\n *\n * @returns the current root node of the ``phylotree``.\n */\nexport function getRootNode() {\n  return this.nodes;\n}\n\n/**\n * Get an array of all nodes.\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function getNodes() {\n  return this.nodes;\n}\n\n/**\n * Get a node by name.\n *\n * @param {String} name Name of the desired node.\n * @returns {Node} Desired node.\n */\nexport function getNodeByName(name) {\n  return _.filter(this.nodes.descendants(), d => {\n    return d.data.name == name;\n  })[0];\n}\n\n/**\n * Add attributes to nodes. New attributes will be placed in the\n * ``annotations`` key of any nodes that are matched.\n *\n * @param {Object} attributes An object whose keys are the names of nodes\n * to modify, and whose values are the new attributes to add.\n */\nexport function assignAttributes(attributes) {\n  //return nodes;\n  // add annotations to each matching node\n  _.each(this.nodes, function(d) {\n    if (_.indexOf(_.keys(attributes), d.name) >= 0) {\n      d[\"annotations\"] = attributes[d.name];\n    }\n  });\n}\n\n/**\n * Determine if a given node is a leaf node.\n *\n * @param {Node} A node in a tree.\n * @returns {Bool} Whether or not the node is a leaf node.\n */\nexport function isLeafNode(node) {\n  return !_.has(node, \"children\")\n}\n\n/**\n * Update a given key name in each node.\n *\n * @param {String} old_key The old key name.\n * @param {String} new_key The new key name.\n * @returns The current ``this``.\n */\nexport function updateKeyName(old_key, new_key) {\n  this.nodes.each(function(n) {\n    if (old_key in n) {\n      if (new_key) {\n        n[new_key] = n[old_key];\n      }\n      delete n[old_key];\n    }\n  });\n\n  return this;\n}\n\nexport function clearInternalNodes(respect) {\n  if (!respect) {\n    this.nodes.each(d => {\n      if (!isLeafNode(d)) {\n\n        // TODO: Move away from storing attribute data as root (BREAKS occasionally with d3>3)\n        d[this.selection_attribute_name] = false;\n\n        if(!d.data.traits) {\n          d.data.traits = {};\n        }\n        d.data.traits[this.selection_attribute_name] = d[this.selection_attribute_name];\n\n      }\n    });\n  }\n}\n\n\n","import { isLeafNode } from \"../nodes\";\n\n/**\n * Parses a Newick string into an equivalent JSON representation that is\n * suitable for consumption by ``hierarchy``.\n *\n * Optionally accepts bootstrap values. Currently supports Newick strings with or without branch lengths,\n * as well as tagged trees such as\n *  ``(a,(b{TAG},(c{TAG},d{ANOTHERTAG})))``\n *\n * @param {String} nwk_str - A string representing a phylogenetic tree in Newick format.\n * @param {Object} bootstrap_values.\n * @returns {Object} An object with keys ``json`` and ``error``.\n */\n\nfunction newickParser(nwk_str, options={}) {\n\n  const bootstrap_values = true,\n    int_or_float = /^-?\\d+(\\.\\d+)?$/;\n  let left_delimiter = options.left_delimiter ||  '{',\n    right_delimiter = options.right_delimiter ||  '}';\n  let clade_stack = [];\n\n  function addNewTreeLevel() {\n    let new_level = {\n      name: null\n    };\n\n    let the_parent = clade_stack[clade_stack.length - 1];\n\n    if (!(\"children\" in the_parent)) {\n      the_parent[\"children\"] = [];\n    }\n\n    clade_stack.push(new_level);\n\n    the_parent[\"children\"].push(clade_stack[clade_stack.length - 1]);\n\n    clade_stack[clade_stack.length - 1][\"original_child_order\"] =\n      the_parent[\"children\"].length;\n  }\n\n  function finishNodeDefinition() {\n\n    let this_node = clade_stack.pop();\n\n    this_node[\"name\"] = current_node_name;\n\n    if (bootstrap_values && \"children\" in this_node) {\n      this_node[\"bootstrap_values\"] = current_node_name;\n    } else {\n      this_node[\"name\"] = current_node_name;\n    }\n\n    this_node[\"attribute\"] = current_node_attribute;\n    if(left_delimiter == \"[\" && current_node_annotation.includes(\"&&NHX\")) {\n      current_node_annotation\n        .split(':')\n        .slice(1)\n        .forEach(annotation => {\n          const [key, value] = annotation.split('=');\n          this_node[key] = int_or_float.test(value) ? +value : value;\n        });\n    } else {\n      this_node[\"annotation\"] = current_node_annotation;\n    }\n\n    current_node_name = \"\";\n    current_node_attribute = \"\";\n    current_node_annotation = \"\";\n  }\n\n  function generateError(location) {\n    return {\n      json: null,\n      error:\n        \"Unexpected '\" +\n        nwk_str[location] +\n        \"' in '\" +\n        nwk_str.substring(location - 20, location + 1) +\n        \"[ERROR HERE]\" +\n        nwk_str.substring(location + 1, location + 20) +\n        \"'\"\n    };\n  }\n\n  let automaton_state = 0;\n  let current_node_name = \"\";\n  let current_node_attribute = \"\";\n  let current_node_annotation = \"\";\n  let quote_delimiter = null;\n\n  let name_quotes = {\n    \"'\": 1,\n    '\"': 1\n  };\n\n  let tree_json = {\n    name: \"root\"\n  };\n\n  clade_stack.push(tree_json);\n\n  var space = /\\s/;\n\n  for (var char_index = 0; char_index < nwk_str.length; char_index++) {\n    try {\n      var current_char = nwk_str[char_index];\n      switch (automaton_state) {\n        case 0: {\n          // look for the first opening parenthesis\n          if (current_char == \"(\") {\n            addNewTreeLevel();\n            automaton_state = 1; // expecting node name\n          }\n          break;\n        }\n        case 1: // name\n        case 3: {\n          // branch length\n          // reading name\n          if (current_char == \":\") {\n            automaton_state = 3;\n          } else if (current_char == \",\" || current_char == \")\") {\n            try {\n              finishNodeDefinition();\n              automaton_state = 1;\n              if (current_char == \",\") {\n                addNewTreeLevel();\n              }\n            } catch (e) {\n              return generateError(char_index);\n            }\n          } else if (current_char == \"(\") {\n            if (current_node_name.length > 0) {\n              return generateError(char_index);\n            } else {\n              addNewTreeLevel();\n            }\n          } else if (current_char in name_quotes) {\n            if (\n              automaton_state == 1 &&\n              current_node_name.length === 0 &&\n              current_node_attribute.length === 0 &&\n              current_node_annotation.length === 0\n            ) {\n              automaton_state = 2;\n              quote_delimiter = current_char;\n              continue;\n            }\n            return generateError(char_index);\n          } else {\n            if (current_char == left_delimiter) {\n              if (current_node_annotation.length) {\n                return generateError(char_index);\n              } else {\n                automaton_state = 4;\n              }\n            } else {\n              if (automaton_state == 3) {\n                current_node_attribute += current_char;\n              } else {\n                if (space.test(current_char)) {\n                  continue;\n                }\n                if (current_char == \";\") {\n                  // semicolon terminates tree definition\n                  char_index = nwk_str.length;\n                  break;\n                }\n                current_node_name += current_char;\n              }\n            }\n          }\n\n          break;\n        }\n        case 2: {\n          // inside a quoted expression\n          if (current_char == quote_delimiter) {\n            if (char_index < nwk_str.length - 1) {\n              if (nwk_str[char_index + 1] == quote_delimiter) {\n                char_index++;\n                current_node_name += quote_delimiter;\n                continue;\n              }\n            }\n            quote_delimiter = 0;\n            automaton_state = 1;\n            continue;\n          } else {\n            current_node_name += current_char;\n          }\n          break;\n        }\n        case 4: {\n          // inside a comment / attribute\n          if (current_char == right_delimiter) {\n            automaton_state = 3;\n          } else {\n            if (current_char == left_delimiter) {\n              return generateError(char_index);\n            }\n            current_node_annotation += current_char;\n          }\n          break;\n        }\n      }\n    } catch (e) {\n      return generateError(char_index);\n    }\n  }\n\n  if (clade_stack.length != 1) {\n    return generateError(nwk_str.length - 1);\n  }\n\n  return {\n    json: tree_json,\n    error: null\n  };\n}\n\n/**\n * Return Newick string representation of a phylotree.\n *\n * @param {Function} annotator - Function to apply to each node, determining\n * what label is written (optional).\n * @returns {String} newick - Phylogenetic tree serialized as a Newick string.\n */\n\n// TODO: break this out into two seperate functions\nexport function getNewick(annotator) {\n\n  let self = this;\n\n  if (!annotator) annotator = d => '';\n\n  function nodeDisplay(n) {\n    if (!isLeafNode(n)) {\n      element_array.push(\"(\");\n      n.children.forEach(function(d, i) {\n        if (i) {\n          element_array.push(\",\");\n        }\n        nodeDisplay(d);\n      });\n      element_array.push(\")\");\n    }\n\n    if(n.data.name != 'root') {\n      element_array.push(n.data.name);\n    }\n    element_array.push(annotator(n));\n\n    let bl = self.branch_length_accessor(n);\n\n    if (bl !== undefined) {\n      element_array.push(\":\" + bl);\n    }\n  }\n\n  let element_array = [];\n  annotator = annotator || \"\";\n  nodeDisplay(this.nodes);\n\n  return element_array.join(\"\")+\";\";\n\n}\n\nexport default newickParser;\n","import * as _ from \"underscore\";\nimport {default as newickParser} from \"./newick\";\n\nexport function parseAnnotations (buf) {\n\n  let str = buf;\n  let index = str.toUpperCase().indexOf('BEGIN DATA;');\n  let data = str.slice(index);\n\n  if(data.length < 2) {\n    return '';\n  }\n\n  index = data.toUpperCase().indexOf('END;');\n  let data_str = data.slice(0, index);\n\n  // split on semicolon\n  data = _.map(data_str.split(';'), d => { return d.trim() } );\n\n  // get dimensions\n  let dimensions = _.filter(data, d => {return d.toUpperCase().startsWith('DIMENSION')}); \n  dimensions = dimensions[0].split(' ');\n  dimensions = _.object(_.map(_.rest(dimensions), d => { return d.split('=') }));\n\n  // get formats\n  let format = _.filter(data, d => {return d.toUpperCase().startsWith('FORMAT')}); \n  format = format[0].split(' ');\n  format = _.object(_.map(_.rest(format), d => { return d.split('=') }));\n  format.symbols = _.reject(format.symbols.split(\"\"), d => d=='\"');\n\n  // get character matrix\n  let matrix = _.filter(data, d => {return d.toUpperCase().startsWith('MATRIX')}); \n  matrix = matrix[0].split('\\n')\n  matrix = _.object(_.map(_.rest(matrix), d=> { return _.compact(d.split(' ')) }));\n\n  // create all possible states for matrix\n  matrix = _.mapObject(matrix, (v,k) => { \n\n    if(v == '?') {\n      return format.symbols\n    }\n    else { \n      return Array(v)\n    }\n  \n  });\n\n  return { 'dimensions' : dimensions, 'format' : format, 'matrix' : matrix }\n\n}\n\n/**\n *  Loads annotations from a nexus-formatted buffer and annotates existing tree\n *  nodes appropriately.\n *\n * @param {Object} tree - Instatiated phylotree\n * @param {String} NEXUS string\n * @returns {Object} Annotations\n */\nexport function loadAnnotations(tree, label, annotations) {\n\n  // if filename, then load from filesystem\n  _.each(tree.getTips(), d => { d.data[\"test\"] = annotations.matrix[d.data.name] });\n\n  // decorate nodes with annotations\n\n}\n\nexport default function loadTree(buf) {\n\n  // if filename, then load from filesystem\n  // Parse first tree from NEXUS file and send to newickParser\n\n  // Make all upper case\n  let str = buf;\n\n  // Get TREE block\n  let index = str.toUpperCase().indexOf('BEGIN TREES;');\n  let split = str.slice(index);\n\n  if(split.length < 2) {\n    return '';\n  }\n\n  index = split.toUpperCase().indexOf('END;');\n  let tree_str = split.slice(0, index);\n\n  // Filter lines that start with TREE\n  let trees = tree_str.split('\\n');\n  trees = _.filter(trees, d => { return d.trim().toUpperCase().startsWith('TREE') });\n\n  // Identify start of newick string\n  return newickParser(trees[0]);\n\n}\n\n","// Changes XML to JSON\n// Modified version from here: http://davidwalsh.name/convert-xml-json\nfunction xmlToJson(xml) {\n\n\t// Create the return object\n\tvar obj = {};\n\n\tif (xml.nodeType == 1) { // element\n\t\t// do attributes\n\t\tif (xml.attributes.length > 0) {\n\t\tobj[\"@attributes\"] = {};\n\t\t\tfor (var j = 0; j < xml.attributes.length; j++) {\n\t\t\t\tvar attribute = xml.attributes.item(j);\n\t\t\t\tobj[\"@attributes\"][attribute.nodeName] = attribute.nodeValue;\n\t\t\t}\n\t\t}\n\t} else if (xml.nodeType == 3) { // text\n\t\tobj = xml.nodeValue;\n\t}\n\n\t// do children\n\t// If just one text node inside\n\tif (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {\n\t\tobj = xml.childNodes[0].nodeValue;\n\t}\n\telse if (xml.hasChildNodes()) {\n\t\tfor(var i = 0; i < xml.childNodes.length; i++) {\n\t\t\tvar item = xml.childNodes.item(i);\n\t\t\tvar nodeName = item.nodeName;\n\t\t\tif (typeof(obj[nodeName]) == \"undefined\") {\n\t\t\t\tobj[nodeName] = xmlToJson(item);\n\t\t\t} else {\n\t\t\t\tif (typeof(obj[nodeName].push) == \"undefined\") {\n\t\t\t\t\tvar old = obj[nodeName];\n\t\t\t\t\tobj[nodeName] = [];\n\t\t\t\t\tobj[nodeName].push(old);\n\t\t\t\t}\n\t\t\t\tobj[nodeName].push(xmlToJson(item));\n\t\t\t}\n\t\t}\n\t}\n\treturn obj;\n}\n\nvar phyloxml_parser = function(xml, options) {\n\n  function parsePhyloxml(node, index) {\n    if (node.clade) {\n      node.clade.forEach(parsePhyloxml);\n      node.children = node.clade;\n      delete node.clade;\n    }\n\n\t\tnode.annotation = 1;\n\t\tnode.attribute = \"0.01\";\n    if (node.branch_length) {\n\t\t\tnode.attribute = node.branch_length;\n    }\n    if (node.taxonomy) {\n      node.name = node.taxonomy.scientific_name;\n    }\n\n    node.annotation = \"\";\n\n  }\n\n  var tree_json;\n\n  xml = xmlToJson(xml);\n  tree_json = xml.phyloxml.phylogeny.clade;\n  tree_json.name = \"root\";\n  parsePhyloxml(tree_json, 0);\n\n  return {\n    json: tree_json,\n    error: null\n  };\n};\n\nexport default phyloxml_parser;\n","import { default as nexml_parser } from \"./nexml\";\nimport { default as newickParser } from \"./newick\";\nimport { default as nexus_parser } from \"./nexus\";\nimport { default as phyloxml_parser } from \"./phyloxml\";\nimport { default as beast_parser } from \"./beast\";\n\n/* \n * A parser must have two fields, the object and\n * options\n */\nvar format_registry = {\n  nexml: nexml_parser,\n  phyloxml: phyloxml_parser,\n  nexus : nexus_parser,\n  nwk: newickParser,\n  nhx: newickParser,\n  beast: beast_parser\n};\n\nexport default format_registry;\n","import * as _ from \"underscore\";\n//import { parseString } from \"xml2js\";\n\nvar nexml_parser = function(xml_string, options) {\n  var trees;\n  parseString(xml_string, function(error, xml) {\n    trees = xml[\"nex:nexml\"].trees[0].tree.map(function(nexml_tree) {\n      var node_list = nexml_tree.node.map(d => d.$),\n        node_hash = node_list.reduce(function(a, b) {\n          b.edges = [];\n          b.name = b.id;\n          a[b.id] = b;\n          return a;\n        }, {}),\n        roots = node_list.filter(d => d.root),\n        root_id = roots > 0 ? roots[0].id : node_list[0].id;\n      node_hash[root_id].name = \"root\";\n\n      nexml_tree.edge.map(d => d.$).forEach(function(edge) {\n        node_hash[edge.source].edges.push(edge);\n      });\n\n      function parseNexml(node, index) {\n        if (node.edges) {\n          var targets = _.pluck(node.edges, \"target\");\n          node.children = _.values(_.pick(node_hash, targets));\n          node.children.forEach(function(child, i) {\n            child.attribute = node.edges[i].length || \"\";\n          });\n          node.children.forEach(parseNexml);\n          node.annotation = \"\";\n        }\n      }\n\n      parseNexml(node_hash[root_id]);\n      return node_hash[root_id];\n    });\n  });\n  return trees;\n};\n\nexport default nexml_parser;\n","import newickParser from \"./newick\";\n\nexport default function(newick, options) {\n  options.left_delimiter = '[';\n  options.right_delimiter = ']';\n  const parsed_newick = newickParser(newick, options);\n  function parseBeastNode(node) {\n    if(node.annotation) {\n      node.beast = {};\n      const tokens = node.annotation.split(/=|,|{|}/)\n        .filter(token => token);\n      for(var i = 0; i < tokens.length; i+=2) {\n        let key = tokens[i].replace(/&|%/g, '');\n        if(/[a-df-zA-DF-Z]+/.test(tokens[i+2])) {\n          node.beast[key] = +tokens[i+1];\n        } else {\n          node.beast[key] = [+tokens[i+1], +tokens[i+2]];\n          i++;\n        }\n      }\n    }\n    node.annotation = undefined;\n    if(node.children) {\n      node.children.forEach(parseBeastNode);\n    }\n  }\n  parseBeastNode(parsed_newick.json);\n  return parsed_newick;\n}\n","import * as _ from \"lodash\";\n\nexport function postOrder(node, callback, backtrack) {\n\n  let nodes = [node],\n    next = [],\n    children,\n    i,\n    n;\n\n  while ((node = nodes.pop())) {\n    if (!(backtrack && backtrack(node))) {\n      next.push(node), (children = node.children);\n      if (children)\n        for (i = 0, n = children.length; i < n; ++i) {\n          nodes.push(children[i]);\n        }\n    }\n  }\n\n  while ((node = next.pop())) {\n    callback(node);\n  }\n\n  return node;\n\n}\n\nexport function preOrder(node, callback, backtrack) {\n  let nodes = [node],\n    children,\n    i;\n\n  while ((node = nodes.pop())) {\n    if (!(backtrack && backtrack(node))) {\n      callback(node), (children = node.children);\n      if (children)\n        for (i = children.length - 1; i >= 0; --i) {\n          nodes.push(children[i]);\n        }\n    }\n  }\n\n  return node;\n}\n\nexport default function inOrder(node, callback, backtrack) {\n  let current,\n    next = [node],\n    children,\n    i,\n    n;\n\n  do {\n    (current = next.reverse()), (next = []);\n    while ((node = current.pop())) {\n      if (!(backtrack && backtrack(node))) {\n        callback(node), (children = node.children);\n        if (children)\n          for (i = 0, n = children.length; i < n; ++i) {\n            next.push(children[i]);\n          }\n      }\n    }\n  } while (next.length);\n\n  return node;\n}\n\n/**\n * Traverses a tree that represents left-child right-sibling\n * @param {Object} tree -- the phylotree.js tree object \n * @return {Object} An edge list that represents the original multi-way tree\n *\n */\nexport function leftChildRightSibling(root) {\n\n  let declareTrueParent = function(n) {\n\n    if(n.children) {\n      // left child is the child\n      n.children[0].data.multiway_parent = n;\n\n      // right child is the sibling\n      n.children[1].data.multiway_parent = n.parent;\n    }\n\n  }\n\n  // First decorate each node with its true parent node\n  postOrder(root, declareTrueParent);\n\n  // return edge list\n  let edge_list = _.map(root.descendants(), n => { \n\n    let source = n.data.multiway_parent; \n    let name = \"unknown\";\n\n    if(source) {\n      name = source.data.name;\n    }\n\n    // In order to get the true name of the infector/infectee, we must traverse\n    // the tree from the multiway_parents node.\n\n    return {\"source\" : n.data.multiway_parent, \"target\" : n, \"name\": name } });\n\n  // Construct edge list by new parent-child listing\n  return edge_list;\n\n}\n\n\n\n","import * as _ from \"underscore\";\n\n// These methods are part of the Phylotree object\n\nexport function setPartitions(partitions) {\n  this.partitions = partitions;\n}\n\nexport function getPartitions(attributes) {\n  return this.partitions;\n}\n\n/**\n * Returns T/F whether every branch in the tree has a branch length\n *\n * @returns {Object} true if  every branch in the tree has a branch length\n */\nexport default function hasBranchLengths() {\n\n  let bl = this.branch_length;\n\n  if (bl) {\n    return _.every(this.nodes.descendants(), function(node) {\n      return !node.parent || !_.isUndefined(bl(node));\n    });\n\n  }\n\n  return false;\n}\n\n/**\n * Returns branch lengths\n *\n * @returns {Array} array of branch lengths\n */\nexport function getBranchLengths() {\n\n  let bl = this.branch_length;\n  return _.map(this.nodes.descendants(), node => { return bl(node)});\n\n}\n\n\nexport function defBranchLengthAccessor(_node, new_length) {\n\n  let _node_data = _node.data;\n  //let _node_data = _node;\n\n  if (\n    \"attribute\" in _node_data &&\n    _node_data[\"attribute\"] &&\n    _node_data[\"attribute\"].length\n  ) {\n\n    if(new_length > 0) {\n      _node_data[\"attribute\"] = String(new_length);\n    }\n\n    let bl = parseFloat(_node_data[\"attribute\"]);\n\n    if (!isNaN(bl)) {\n      return Math.max(0, bl);\n    }\n\n  }\n\n  // Allow for empty branch length at root\n  if(_node_data.name == \"root\") {\n    return 0;\n  }\n\n  console.warn('Undefined branch length at ' + _node_data.name + '!');\n\n  return undefined;\n\n}\n\n/**\n * Get or set branch length accessor.\n *\n * @param {Function} attr Empty if getting, or new branch length accessor if setting.\n * @returns {Object} The branch length accessor if getting, or the current this if setting.\n */\nexport function setBranchLength(attr) {\n  if (!arguments.length) return this.branch_length_accessor;\n  this.branch_length_accessor = attr ? attr : defBranchLengthAccessor;\n  return this;\n}\n\n/**\n * Normalizes branch lengths\n */\nexport function normalize(attr) {\n\n  let bl = this.branch_length;\n\n  let branch_lengths = _.map(this.nodes.descendants(), function(node) {\n    if(bl(node)) {\n    return bl(node);\n    } else {\n      return null;\n    }\n  });\n\n  const max_bl = _.max(branch_lengths);\n  const min_bl = _.min(branch_lengths);\n\n  let scaler = function (x) {\n    return (x - min_bl)/(max_bl - min_bl);\n  }\n\n  _.each(this.nodes.descendants(), (node) => {\n      let len = bl(node);\n      if(len) {\n        bl(node, scaler(len));\n      }     \n  });\n\n  return this;\n\n}\n\n\n/**\n * Scales branch lengths\n *\n * @param {Function} function that scales the branches\n */\nexport function scale(scale_by) {\n\n  let bl = this.branch_length;\n\n  _.each(this.nodes.descendants(), (node) => {\n      let len = bl(node);\n      if(len) {\n        bl(node, scale_by(len));\n      }     \n  });\n\n  return this;\n\n}\n\n/**\n * Get or set branch name accessor.\n *\n * @param {Function} attr (Optional) If setting, a function that accesses a branch name\n * from a node.\n * @returns The ``nodeLabel`` accessor if getting, or the current ``this`` if setting.\n */\nexport function branchName(attr) {\n  if (!arguments.length) return this.nodeLabel;\n  this.nodeLabel = attr;\n  return this;\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\n/**\n* Reroot the tree on the given node.\n*\n* @param {Node} node Node to reroot on.\n* @param {fraction} if specified, partition the branch not into 0.5 : 0.5, but according to \n                   the specified fraction\n                   \n* @returns {Phylotree} The current ``phylotree``.\n*/\nexport function reroot(node, fraction) {\n\n  /** TODO add the option to root in the middle of a branch */\n  if(!(node instanceof d3.hierarchy)) {\n   throw new Error('node needs to be an instance of a d3.hierarchy node!');\n  }\n\n  let nodes = this.nodes.copy();\n\n  fraction = fraction !== undefined ? fraction : 0.5;\n\n  if (node.parent) {\n\n    var new_json = d3.hierarchy({\n      name: \"new_root\"\n    });\n    \n    new_json.children = [node.copy()];\n    new_json.data.__mapped_bl = undefined\n\n    nodes.each(n => {\n      n.data.__mapped_bl = this.branch_length_accessor(n);\n    });\n\n    this.setBranchLength(n => {\n      return n.data.__mapped_bl;\n    });\n\n    let remove_me = node,\n      current_node = node.parent,\n      stashed_bl = _.noop();\n\n    let apportioned_bl =\n      node.data.__mapped_bl === undefined ? undefined : node.data.__mapped_bl * fraction;\n\n    stashed_bl = current_node.data.__mapped_bl;\n\n    current_node.data.__mapped_bl =\n      node.data.__mapped_bl === undefined\n        ? undefined\n        : node.data.__mapped_bl - apportioned_bl;\n\n    node.data.__mapped_bl = apportioned_bl;\n\n    var remove_idx;\n\n    if (current_node.parent) {\n\n      new_json.children.push(current_node);\n\n      while (current_node.parent) {\n        remove_idx = current_node.children.indexOf(remove_me);\n        if (current_node.parent.parent) {\n          current_node.children.splice(remove_idx, 1, current_node.parent);\n        } else {\n          current_node.children.splice(remove_idx, 1);\n        }\n\n        let t = current_node.parent.data.__mapped_bl;\n\n        if (t !== undefined) {\n          current_node.parent.data.__mapped_bl = stashed_bl;\n          stashed_bl = t;\n        }\n        remove_me = current_node;\n        current_node = current_node.parent;\n      }\n      remove_idx = current_node.children.indexOf(remove_me);\n      current_node.children.splice(remove_idx, 1);\n    } else {\n      remove_idx = current_node.children.indexOf(remove_me);\n      current_node.children.splice(remove_idx, 1);\n      stashed_bl = current_node.data.__mapped_bl;\n      remove_me = new_json;\n    }\n\n    // current_node is now old root, and remove_me is the root child we came up\n    // the tree through\n    if (current_node.children.length == 1) {\n      if (stashed_bl) {\n        current_node.children[0].data.__mapped_bl += stashed_bl;\n      }\n      remove_me.children = remove_me.children.concat(current_node.children);\n    } else {\n      let new_node = new d3.hierarchy({ name: \"__reroot_top_clade\", __mapped_bl: stashed_bl });\n      _.extendOwn (new_json.children[0], node);\n      new_node.data.__mapped_bl = stashed_bl;\n      new_node.children = current_node.children.map(function(n) {\n        n.parent = new_node;\n        return n;\n      });\n\n      new_node.parent = remove_me;\n      remove_me.children.push(new_node);\n     }\n\n  }\n\n  // need to traverse the nodes and update parents\n  this.update(new_json);\n\n  this.traverse_and_compute(n => {\n    _.each (n.children, (c) => {c.parent = n;})\n  }, \"pre-order\");\n\n\n  if(!_.isUndefined(this.display)) {\n    // get container\n    let options = this.display.options;\n    d3.select(this.display.container).select('svg').remove()\n    // get options\n    delete this.display;\n    let rendered_tree = this.render(options);\n    d3.select(rendered_tree.container).node().appendChild(rendered_tree.show());\n  }\n\n  return this;\n\n}\n\nexport function rootpath(attr_name, store_name) {\n\n  attr_name = attr_name || \"attribute\";\n  store_name = store_name || \"y_scaled\";\n\n  if (\"parent\" in this) {\n    let my_value = parseFloat(this[attr_name]);\n\n    this[store_name] =\n      this.parent[store_name] + (isNaN(my_value) ? 0.1 : my_value);\n\n  } else {\n\n    this[store_name] = 0.0;\n\n  }\n\n  return this[store_name];\n\n}\n\nexport function pathToRoot(node) {\n  let selection = [];\n  while (node) {\n    selection.push(node);\n    node = node.parent;\n  }\n  return selection;\n}\n","export function xCoord(d) {\n  return d.y;\n}\n\nexport function yCoord(d) {\n  return d.x;\n}\n","import { xCoord, yCoord } from \"./coordinates\";\n\nfunction radialMapper(r, a, radial_center) {\n  return {\n    x: radial_center + r * Math.sin(a),\n    y: radial_center + r * Math.cos(a)\n  };\n}\n\nfunction cartesianMapper(x, y, radial_center) { // eslint-disable-line\n  return polarToCartesian(x - radial_center, y - radial_center);\n}\n\nfunction polarToCartesian(x, y) {\n  let r = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));\n  let a = Math.atan2(y, x);\n  return [r, a];\n}\n\nexport function cartesianToPolar(\n  node,\n  radius,\n  radial_root_offset,\n  radial_center,\n  scales,\n  size\n) {\n\n  node.radius = radius * (node.radius + radial_root_offset);\n\n  //if (!node.angle) {\n  node.angle = 2 * Math.PI * node.x * scales[0] / size[0];\n  //}\n\n  let radial = radialMapper(node.radius, node.angle, radial_center);\n\n  node.x = radial.x;\n  node.y = radial.y;\n\n  return node;\n\n}\n\nexport function drawArc(radial_center, points) {\n\n\n  var start = radialMapper(points[0].radius, points[0].angle, radial_center),\n    end = radialMapper(points[0].radius, points[1].angle, radial_center);\n\n  return (\n    \"M \" +\n    xCoord(start) +\n    \",\" +\n    yCoord(start) +\n    \" A \" +\n    points[0].radius +\n    \",\" +\n    points[0].radius +\n    \" 0,0, \" +\n    (points[1].angle > points[0].angle ? 1 : 0) +\n    \" \" +\n    xCoord(end) +\n    \",\" +\n    yCoord(end) +\n    \" L \" +\n    xCoord(points[1]) +\n    \",\" +\n    yCoord(points[1])\n  );\n}\n\nexport function arcSegmentPlacer(edge, where, radial_center) {\n  var r = radialMapper(\n    edge.target.radius + (edge.source.radius - edge.target.radius) * where,\n    edge.target.angle,\n    radial_center\n  );\n  return { x: xCoord(r), y: yCoord(r) };\n}\n","import * as d3 from \"d3\";\nimport { xCoord, yCoord } from \"./coordinates\";\n\nexport var draw_line = d3\n  .line()\n  .x(function(d) {\n    return xCoord(d);\n  })\n  .y(function(d) {\n    return yCoord(d);\n  })\n  .curve(d3.curveStepBefore);\n\nexport function lineSegmentPlacer(edge, where) {\n  return {\n    x:\n      xCoord(edge.target) +\n      (xCoord(edge.source) - xCoord(edge.target)) * where,\n    y: yCoord(edge.target)\n  };\n}\n\nexport default draw_line;\n","export function itemTagged(item) {\n  return item.tag || false;\n}\n\nexport function itemSelected(item, tag) {\n  return item[tag] || false;\n}\n","import { isLeafNode } from \"../nodes\";\n\nexport const css_classes = {\n  \"tree-container\": \"phylotree-container\",\n  \"tree-scale-bar\": \"tree-scale-bar\",\n  node: \"node\",\n  \"internal-node\": \"internal-node\",\n  \"tagged-node\": \"node-tagged\",\n  \"selected-node\": \"node-selected\",\n  \"collapsed-node\": \"node-collapsed\",\n  \"root-node\": \"root-node\",\n  branch: \"branch\",\n  \"selected-branch\": \"branch-selected\",\n  \"tagged-branch\": \"branch-tagged\",\n  \"tree-selection-brush\": \"tree-selection-brush\",\n  \"branch-tracer\": \"branch-tracer\",\n  clade: \"clade\",\n  node_text: \"phylotree-node-text\"\n};\n\nexport function internalNames(attr) {\n  if (!arguments.length) return this.options[\"internal-names\"];\n  this.options[\"internal-names\"] = attr;\n  return this;\n}\n\nexport function radial(attr) {\n  if (!arguments.length) return this.options[\"is-radial\"];\n  this.options[\"is-radial\"] = attr;\n  return this;\n}\n\nexport function alignTips(attr) {\n  if (!arguments.length) return this.options[\"align-tips\"];\n  this.options[\"align-tips\"] = attr;\n  return this;\n}\n\n/**\n * Return the bubble size of the current node.\n *\n * @param {Node} A node in the phylotree.\n * @returns {Float} The size of the bubble associated to this node.\n */\nexport function nodeBubbleSize(node) {\n\n  return this.options[\"draw-size-bubbles\"]\n    ? this.relative_nodeSpan(node) * this.scales[0] * 0.25\n    : 0;\n}\n\nexport function shiftTip(d) {\n  if (this.options[\"is-radial\"]) {\n    return [\n      (d.text_align == \"end\" ? -1 : 1) *\n        (this.radius_pad_for_bubbles - d.radius),\n      0\n    ];\n  }\n  if (this.options[\"right-to-left\"]) {\n    return [this.right_most_leaf - d.screen_x, 0];\n  }\n  return [this.right_most_leaf - d.screen_x, 0];\n}\n\nexport function layoutHandler(attr) {\n  if (!arguments.length) return this.layout_listener_handler;\n  this.layout_listener_handler = attr;\n  return this;\n}\n\n/**\n * Getter/setter for the selection label. Useful when allowing\n * users to make multiple selections.\n *\n * @param {String} attr (Optional) If setting, the new selection label.\n * @returns The current selection label if getting, or the current ``phylotree`` if setting.\n */\nexport function selectionLabel(attr) {\n  if (!arguments.length) return this.selection_attribute_name;\n  this.selection_attribute_name = attr;\n  this.syncEdgeLabels();\n  return this;\n}\n\n/**\n * Get or set the current node span. If setting, the argument should\n * be a function of a node which returns a number, so that node spans\n * can be determined dynamically. Alternatively, the argument can be the\n * string ``\"equal\"``, to give all nodes an equal span.\n *\n * @param {Function} attr Optional; if setting, the nodeSpan function.\n * @returns The ``nodeSpan`` if getting, or the current ``phylotree`` if setting.\n */\nexport function nodeSpan(attr) {\n  if (!arguments.length) return nodeSpan;\n  if (typeof attr == \"string\" && attr == \"equal\") {\n    nodeSpan = function(d) { // eslint-disable-line\n      return 1;\n    };\n  } else {\n    nodeSpan = attr; // eslint-disable-line\n  }\n  return this;\n}\n\n// List of all selecters that can be used with the restricted-selectable option\nexport var predefined_selecters = {\n  all: d => {\n    return true;\n  },\n  none: d => {\n    return false;\n  },\n  \"all-leaf-nodes\": d => {\n    return isLeafNode(d.target);\n  },\n  \"all-internal-nodes\": d => {\n    return !isLeafNode(d.target);\n  }\n};\n\n/**\n * Getter/setter for the selection callback. This function is called\n * every time the current selection is modified, and its argument is\n * an array of nodes that make up the current selection.\n *\n * @param {Function} callback (Optional) The selection callback function.\n * @returns The current ``selectionCallback`` if getting, or the current ``this`` if setting.\n */\nexport function selectionCallback(callback) {\n  if (!callback) return this.selectionCallback;\n  this.selectionCallback = callback;\n  return this;\n}\n","import * as d3 from \"d3\";\n\nimport { itemTagged, itemSelected } from \"./helpers\";\nimport { isLeafNode } from \"../nodes\";\nimport { css_classes } from \"./options\";\n\nexport function shiftTip(d) {\n\n  if (this.radial()) {\n    return [\n      (d.text_align == \"end\" ? -1 : 1) *\n        (this.radius_pad_for_bubbles - d.radius),\n      0\n    ];\n  }\n\n  if (this.options[\"right-to-left\"]) {\n    return [this.right_most_leaf - d.screen_x, 0];\n  }\n\n  return [this.right_most_leaf - d.screen_x, 0];\n\n}\n\nexport function drawNode(container, node, transitions) {\n\n  container = d3.select(container);\n  var is_leaf = isLeafNode(node);\n\n  if (is_leaf) {\n    container = container.attr(\"data-node-name\", node.data.name);\n  }\n\n  var labels = container.selectAll(\"text\").data([node]),\n    tracers = container.selectAll(\"line\");\n\n  if (is_leaf || (this.showInternalName(node) && !isNodeCollapsed(node))) {\n\n    labels = labels\n      .enter()\n      .append(\"text\")\n      .classed(this.css_classes[\"node_text\"], true)\n      .merge(labels)\n      .on(\"click\", this.handle_node_click)\n      .attr(\"dy\", d => {\n        return this.shown_font_size * 0.33;\n      })\n      .text(d => {\n        return this.options[\"show-labels\"] ? this._nodeLabel(d) : \"\";\n      })\n      .style(\"font-size\", d => {\n        return this.ensure_size_is_in_px(this.shown_font_size);\n      });\n\n    if (this.radial()) {\n      labels = labels\n        .attr(\"transform\", d => {\n          return (\n            this.d3PhylotreeSvgRotate(d.text_angle) +\n            this.d3PhylotreeSvgTranslate(\n              this.alignTips() ? this.shiftTip(d) : null\n            )\n          );\n        })\n        .attr(\"text-anchor\", d => {\n          return d.text_align;\n        });\n    } else {\n      labels = labels.attr(\"text-anchor\", \"start\").attr(\"transform\", d => {\n        if (this.options[\"layout\"] == \"right-to-left\") {\n          return this.d3PhylotreeSvgTranslate([-20, 0]);\n        }\n        return this.d3PhylotreeSvgTranslate(\n          this.alignTips() ? this.shiftTip(d) : null\n        );\n      });\n    }\n\n    if (this.alignTips()) {\n      tracers = tracers.data([node]);\n\n      if (transitions) {\n        tracers = tracers\n          .enter()\n          .append(\"line\")\n          .classed(this.css_classes[\"branch-tracer\"], true)\n          .merge(tracers)\n          .attr(\"x1\", d => {\n            return (\n              (d.text_align == \"end\" ? -1 : 1) * this.nodeBubbleSize(node)\n            );\n          })\n          .attr(\"x2\", 0)\n          .attr(\"y1\", 0)\n          .attr(\"y2\", 0)\n          .attr(\"x2\", d => {\n            if (this.options[\"layout\"] == \"right-to-left\") {\n              return d.screen_x;\n            }\n\n            return this.shiftTip(d)[0];\n          })\n          .attr(\"transform\", d => {\n            return this.d3PhylotreeSvgRotate(d.text_angle);\n          })\n          .attr(\"x2\", d => {\n            if (this.options[\"layout\"] == \"right-to-left\") {\n              return d.screen_x;\n            }\n            return this.shiftTip(d)[0];\n          })\n          .attr(\"transform\", d => {\n            return this.d3PhylotreeSvgRotate(d.text_angle);\n          });\n      } else {\n        tracers = tracers\n          .enter()\n          .append(\"line\")\n          .classed(this.css_classes[\"branch-tracer\"], true)\n          .merge(tracers)\n          .attr(\"x1\", d => {\n            return (\n              (d.text_align == \"end\" ? -1 : 1) * this.nodeBubbleSize(node)\n            );\n          })\n          .attr(\"y2\", 0)\n          .attr(\"y1\", 0)\n          .attr(\"x2\", d => {\n            return this.shiftTip(d)[0];\n          });\n        tracers.attr(\"transform\", d => {\n          return this.d3PhylotreeSvgRotate(d.text_angle);\n        });\n      }\n    } else {\n      tracers.remove();\n    }\n\n    if (this.options[\"draw-size-bubbles\"]) {\n\n      var shift = this.nodeBubbleSize(node);\n\n      let circles = container\n        .selectAll(\"circle\")\n        .data([shift])\n        .enter()\n        .append(\"circle\");\n\n      circles.attr(\"r\", function(d) {\n        return d;\n      });\n\n      if (this.shown_font_size >= 5) {\n        labels = labels.attr(\"dx\", d => {\n          return (\n            (d.text_align == \"end\" ? -1 : 1) *\n            ((this.alignTips() ? 0 : shift) + this.shown_font_size * 0.33)\n          );\n        });\n      }\n    } else {\n      if (this.shown_font_size >= 5) {\n        labels = labels.attr(\"dx\", d => { // eslint-disable-line\n          return (d.text_align == \"end\" ? -1 : 1) * this.shown_font_size * 0.33;\n        });\n      }\n    }\n  }\n\n  if (!is_leaf) {\n    let circles = container\n        .selectAll(\"circle\")\n        .data([node])\n        .enter()\n        .append(\"circle\"),\n      radius = this.node_circle_size()(node);\n\n    if (radius > 0) {\n      circles\n        .merge(circles)\n        .attr(\"r\", d => {\n          return Math.min(this.shown_font_size * 0.75, radius);\n        })\n        .on(\"click\", d => {\n          this.handle_node_click(d);\n        });\n    } else {\n      circles.remove();\n    }\n  }\n\n  if (this.node_styler) {\n    this.node_styler(container, node);\n  }\n\n  return node;\n}\n\nexport function updateHasHiddenNodes() {\n  let nodes = this.phylotree.nodes.descendants();\n\n  for (let k = nodes.length - 1; k >= 0; k -= 1) {\n    if (isLeafNode(nodes[k])) {\n      nodes[k].hasHiddenNodes = nodes[k].notshown;\n    } else {\n      nodes[k].hasHiddenNodes = nodes[k].children.reduce(function(p, c) {\n        return c.notshown || p;\n      }, false);\n    }\n  }\n\n  return this;\n}\n\nexport function showInternalName(node) {\n\n  const i_names = this.internalNames();\n\n  if (i_names) {\n    if (typeof i_names === \"function\") {\n      return i_names(node);\n    }\n    return i_names;\n  }\n\n  return false;\n}\n\n/**\n * Get or set the current node span. If setting, the argument should\n * be a function of a node which returns a number, so that node spans\n * can be determined dynamically. Alternatively, the argument can be the\n * string ``\"equal\"``, to give all nodes an equal span.\n *\n * @param {Function} attr Optional; if setting, the nodeSpan function.\n * @returns The ``nodeSpan`` if getting, or the current ``phylotree`` if setting.\n */\nexport function nodeSpan(attr) {\n  if (!arguments.length) return this.nodeSpan;\n  if (typeof attr == \"string\" && attr == \"equal\") {\n    this.nodeSpan = function(d) {\n      return 1;\n    };\n  } else {\n    this.nodeSpan = attr;\n  }\n  return this;\n}\n\nexport function reclassNode(node) {\n\n  let class_var = css_classes[isLeafNode(node) ? \"node\" : \"internal-node\"];\n\n  if (itemTagged(node)) {\n    class_var += \" \" + css_classes[\"tagged-node\"];\n  }\n\n  if (itemSelected(node, this.selection_attribute_name)) {\n    class_var += \" \" + css_classes[\"selected-node\"];\n  }\n\n  if (!node[\"parent\"]) {\n    class_var += \" \" + css_classes[\"root-node\"];\n  }\n\n  if (isNodeCollapsed(node) || hasHiddenNodes(node)) {\n    class_var += \" \" + css_classes[\"collapsed-node\"];\n  }\n\n  return class_var;\n}\n\nexport function nodeVisible(node) {\n  return !(node.hidden || node.notshown || false);\n}\n\nexport function nodeNotshown(node) {\n  return node.notshown;\n}\n\nexport function hasHiddenNodes(node) {\n  return node.hasHiddenNodes || false;\n}\n\nexport function isNodeCollapsed(node) {\n  return node.collapsed || false;\n}\n\nexport function nodeCssSelectors(css_classes) {\n  return [\n    css_classes[\"node\"],\n    css_classes[\"internal-node\"],\n    css_classes[\"collapsed-node\"],\n    css_classes[\"tagged-node\"],\n    css_classes[\"root-node\"]\n  ].reduce(function(p, c, i, a) {\n    return (p += \"g.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function internalLabel(callback, respect_existing) {\n\n  this.phylotree.clearInternalNodes(respect_existing);\n\n  for (var i = this.phylotree.nodes.descendants().length - 1; i >= 0; i--) {\n\n    var d = this.phylotree.nodes.descendants()[i];\n\n    if (!(isLeafNode(d) || itemSelected(d, this.selection_attribute_name))) {\n      d[this.selection_attribute_name] = callback(d.children);\n    }\n\n  }\n\n  this.modifySelection((d, callback) => {\n    if (isLeafNode(d.target)) {\n      return d.target[this.selection_attribute_name];\n    }\n    return d.target[this.selection_attribute_name];\n  });\n}\n\nexport function defNodeLabel(_node) {\n\n  _node = _node.data;\n\n  if (isLeafNode(_node)) {\n    return _node.name || \"\";\n  }\n\n  if (this.showInternalName(_node)) {\n    return _node.name;\n  }\n\n  return \"\";\n\n}\n\n/**\n * Get or set nodeLabel accessor.\n *\n * @param {Function} attr (Optional) If setting, a function that accesses a branch name\n * from a node.\n * @returns The ``nodeLabel`` accessor if getting, or the current ``this`` if setting.\n */\nexport function nodeLabel(attr) {\n  if (!arguments.length) return this._nodeLabel;\n  this._nodeLabel = attr ? attr : defNodeLabel;\n\tthis.update();\n  return this;\n}\n\n\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\nimport { isNodeCollapsed } from \"./nodes\";\n\nexport function cladeCssSelectors(css_classes) {\n  return [css_classes[\"clade\"]].reduce(function(p, c, i, a) {\n    return (p += \"path.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function updateCollapsedClades(transitions) {\n\n  let enclosure = this.svg.selectAll(\".\" + this.css_classes[\"tree-container\"]);\n  var node_id = 0;\n\n  let collapsed_clades = enclosure\n    .selectAll(cladeCssSelectors(this.css_classes))\n    .data(\n      this.phylotree.nodes.descendants().filter(isNodeCollapsed),\n      function(d) {\n        return d.id || (d.id = ++node_id);\n      }\n    );\n\n  let spline = function() {};\n  let spline_f = _.noop();\n\n  // Collapse radial differently\n  if (this.radial()) {\n    spline = d3\n      .line()\n      .curve(d3.curveBasis)\n      .y(function(d) {\n        return d[0];\n      })\n      .x(function(d) {\n        return d[1];\n      });\n\n    spline_f = function(coord, i, d, init_0, init_1) {\n      if (i) {\n        return [\n          d.screen_y + (coord[0] - init_0) / 50,\n          d.screen_x + (coord[1] - init_1) / 50\n        ];\n      } else {\n        return [d.screen_y, d.screen_x];\n      }\n    };\n  } else {\n    spline = d3\n      .line()\n      .y(function(d) {\n        return d[0];\n      })\n      .x(function(d) {\n        return d[1];\n      }).curve(d3.curveBasis);\n\n    spline_f = function(coord, i, d, init_0, init_1) {\n      if (i) {\n         return [\n          d.screen_y + (coord[0] - init_0) / 50 ,\n          d.screen_x + (coord[1] - init_1) / 50,\n        ];\n      } else {\n        return [d.screen_y, d.screen_x];\n      }\n    };\n  }\n\n  collapsed_clades\n    .exit()\n    .each(function(d) {\n      d.collapsed_clade = null;\n    })\n    .remove();\n\n  if (transitions) {\n    collapsed_clades\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .attr(\"class\", this.css_classes[\"clade\"])\n      .merge(collapsed_clades)\n      .attr(\"d\", function(d) {\n        if (d.collapsed_clade) {\n          return d.collapsed_clade;\n        }\n\n        //console.log (d.collapsed);\n        let init_0 = d.collapsed[0][0];\n        let init_1 = d.collapsed[0][1];\n        \n\n  \n        // #1 return spline(d.collapsed.map(spline_f, d, init_0, init_1));\n        return spline(\n          d.collapsed.map(function(coord, i) {\n            return spline_f(coord, i, d, init_0, init_1);\n          })\n        );\n      })\n      .attr(\"d\", function(d) {        \n        return (d.collapsed_clade = spline(d.collapsed));\n      });\n  } else {\n    collapsed_clades\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .attr(\"class\", this.css_classes[\"clade\"])\n      .merge(collapsed_clades)\n      .attr(\"d\", function(d) {\n        return (d.collapsed_clade ? d.collapsed_clade : d.collapsed_clade = spline(d.collapsed));\n      });\n  }\n}\n","import * as d3 from \"d3\";\nimport { itemTagged, itemSelected } from \"./helpers\";\nimport { css_classes } from \"./options\";\n\nexport function drawEdge(container, edge, transition) {\n\n  container = d3.select(container);\n\n  container = container\n    .attr(\"class\", d => {\n      return this.reclassEdge(d);\n    })\n    .on(\"click\", d => {\n      this.modifySelection([d.target], this.selection_attribute_name);\n      this.update();\n    });\n\n  let new_branch_path = this.draw_branch([edge.source, edge.target]);\n\n  if (transition) {\n\n    if (container.datum().existing_path) {\n      container = container.attr(\"d\", function(d) {\n        return d.existing_path;\n      });\n    }\n\n    container = container.attr(\"d\", new_branch_path);\n\n  } else {\n    container = container.attr(\"d\", new_branch_path);\n  }\n\n  edge.existing_path = new_branch_path;\n\n  var bl = this.phylotree.branch_length_accessor(edge.target);\n\n  if (bl !== undefined) {\n    var haz_title = container.selectAll(\"title\");\n\n    if (haz_title.empty()) {\n      haz_title = container.append(\"title\");\n    }\n    haz_title.text(\"Length = \" + bl);\n  } else {\n    container.selectAll(\"title\").remove();\n  }\n\n  if (this.edge_styler) {\n    this.edge_styler(container, edge, transition);\n  }\n\n  return this.phylotree;\n\n}\n\nexport function reclassEdge(edge) {\n  let class_var = css_classes[\"branch\"];\n\n  if (itemTagged(edge)) {\n    class_var += \" \" + css_classes[\"tagged-branch\"];\n  }\n\n  if (itemSelected(edge, this.selection_attribute_name)) {\n    class_var += \" \" + css_classes[\"selected-branch\"];\n  }\n\n  return class_var;\n\n}\n\nexport function initializeEdgeLabels() {\n\n  this.links.forEach(d => {\n\n    // TODO: Move away from storing attribute data as root (BREAKS occasionally with d3>3)\n    if(d.target.data.annotation) {\n      d.target[d.target.data.annotation] = d.target.data.annotation;\n    }\n\n  });\n\n}\n\n\nexport function syncEdgeLabels() {\n\n  this.links.forEach(d => {\n\n    // TODO: Move away from storing attribute data as root (BREAKS occasionally with d3>3)\n    d[this.selection_attribute_name] =\n      d.target[this.selection_attribute_name] || false;\n    d.tag = d.target.tag || false;\n\n  });\n\n  if (this.countHandler()) {\n\n    let counts = {};\n\n    counts[\n      this.selection_attribute_name\n    ] = this.links.reduce((p, c) => {\n      return p + (c[this.selection_attribute_name] ? 1 : 0);\n    }, 0);\n\n    counts[\"tagged\"] = this.links.reduce(function(p, c) {\n      return p + (itemTagged(c) ? 1 : 0);\n    }, 0);\n\n    this.countUpdate(this, counts, this.countHandler());\n\n  }\n\n}\n\nexport function edgeVisible(edge) {\n  return !(edge.target.hidden || edge.target.notshown || false);\n}\n\nexport function edgeCssSelectors(css_classes) {\n  return [\n    css_classes[\"branch\"],\n    css_classes[\"selected-branch\"],\n    css_classes[\"tagged-branch\"]\n  ].reduce(function(p, c, i, a) {\n    return (p += \"path.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function placeAlongAnEdge (e, where) {\n    return this.edge_placer (e, where);\n}\n","import { isLeafNode } from \"../nodes\";\nimport { css_classes } from \"./options\";\n\nlet d3_layout_phylotree_event_id = \"phylotree.event\";\n\n/**\n * Toggle collapsed view of a given node. Either collapses a clade into\n * a smaller blob for viewing large trees, or expands a node that was\n * previously collapsed.\n *\n * @param {Node} node The node to toggle.\n * @returns {Phylotree} The current ``phylotree``.\n */\nexport function toggleCollapse(node) {\n  if (node.collapsed) {\n    node.collapsed = false;\n\n    let unhide = function(n) {\n      if (!isLeafNode(n)) {\n        if (!n.collapsed) {\n          n.children.forEach(unhide);\n        }\n      }\n      n.hidden = false;\n    };\n\n    unhide(node);\n  } else {\n    node.collapsed = true;\n  }\n\n  this.placenodes();\n  return this;\n}\n\nexport function resizeSvg(tree, svg, tr) {\n\n  let sizes = this.size;\n\n  if (this.radial()) {\n    let pad_radius = this.pad_width(),\n      vertical_offset =\n        this.options[\"top-bottom-spacing\"] != \"fit-to-size\"\n          ? this.pad_height()\n          : 0;\n\n    sizes = [\n      sizes[1] + 2 * pad_radius,\n      sizes[0] + 2 * pad_radius + vertical_offset\n    ];\n\n    if (svg) {\n      svg\n        .selectAll(\".\" + css_classes[\"tree-container\"])\n        .attr(\n          \"transform\",\n          \"translate (\" +\n            pad_radius +\n            \",\" +\n            (pad_radius + vertical_offset) +\n            \")\"\n        );\n    }\n  } else {\n\n    sizes = [\n      sizes[0] +\n        (this.options[\"top-bottom-spacing\"] != \"fit-to-size\"\n          ? this.pad_height()\n          : 0),\n      sizes[1] +\n        (this.options[\"left-right-spacing\"] != \"fit-to-size\"\n          ? this.pad_width()\n          : 0)\n    ];\n\n  }\n\n  if (svg) {\n\n    if (tr) {\n      svg = svg.transition(100);\n    }\n\n    svg.attr(\"height\", sizes[0]).attr(\"width\", sizes[1]);\n\n  }\n\n  this.size = sizes;\n\n  return sizes;\n\n}\n\nexport function rescale(scale, attr_name) {\n  attr_name = attr_name || \"y_scaled\";\n  if (attr_name in this) {\n    this[attr_name] *= scale;\n  }\n}\n\nexport function triggerRefresh(tree) {\n\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"refresh\", tree]\n  });\n\n  document.dispatchEvent(event);\n\n}\n\nexport function countUpdate(tree, counts) {\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"countUpdate\", counts, tree.countHandler()]\n  });\n  document.dispatchEvent(event);\n}\n\nexport function d3PhylotreeTriggerLayout(tree) {\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"layout\", tree, tree.layoutHandler()]\n  });\n  document.dispatchEvent(event);\n}\n\nexport function d3PhylotreeEventListener(event) {\n  switch (event.detail[0]) {\n    case \"refresh\":\n      event.detail[1].refresh();\n      break;\n    case \"countUpdate\":\n      event.detail[2](event.detail[1]);\n      break;\n    case \"layout\":\n      event.detail[2](event.detail[1]);\n  }\n  return true;\n}\n\nexport function d3PhylotreeAddEventListener() {\n  document.addEventListener(\n    d3_layout_phylotree_event_id,\n    d3PhylotreeEventListener,\n    false\n  );\n}\n\nexport function d3PhylotreeSvgTranslate(x) {\n  if (x && (x[0] !== null || x[1] !== null))\n    return (\n      \"translate (\" +\n      (x[0] !== null ? x[0] : 0) +\n      \",\" +\n      (x[1] !== null ? x[1] : 0) +\n      \") \"\n    );\n\n  return \"\";\n}\n\nexport function d3PhylotreeSvgRotate(a) {\n  if (a !== null) {\n    return \"rotate (\" + a + \") \";\n  }\n  return \"\";\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\nimport * as events from \"./events\";\nimport { isLeafNode } from \"../nodes\";\nimport { isNodeCollapsed, hasHiddenNodes } from \"./nodes\";\nimport { predefined_selecters } from \"./options\";\n\nlet d3_layout_phylotree_context_menu_id = \"d3_layout_phylotree_context_menu\";\n\nexport function nodeDropdownMenu(node, container, phylotree, options) {\n  let menu_object = d3\n    .select(container)\n    .select(\"#\" + d3_layout_phylotree_context_menu_id);\n\n  if (menu_object.empty()) {\n    menu_object = d3\n      .select(container)\n      .append(\"div\")\n      .attr(\"id\", d3_layout_phylotree_context_menu_id)\n      .attr(\"class\", \"dropdown-menu\")\n      .attr(\"role\", \"menu\");\n  }\n\n  menu_object.selectAll(\"a\").remove();\n  menu_object.selectAll(\"h6\").remove();\n  menu_object.selectAll(\"div\").remove();\n\n  if (node) {\n    if (\n      !_.some([\n        Boolean(node.menu_items),\n        options[\"hide\"],\n        options[\"selectable\"],\n        options[\"collapsible\"]\n      ]) ||\n      !options[\"show-menu\"]\n    )\n      return;\n    if (!isLeafNode(node)) {\n      if (options[\"collapsible\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(isNodeCollapsed(node) ? \"Expand Subtree\" : \"Collapse Subtree\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.toggleCollapse(node).update();\n          });\n        if (options[\"selectable\"]) {\n          menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n          menu_object\n            .append(\"h6\")\n            .attr(\"class\", \"dropdown-header\")\n            .text(\"Toggle selection\");\n        }\n      }\n\n      if (options[\"selectable\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All descendant branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modifySelection(\n              phylotree.selectAllDescendants(node, true, true)\n            );\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All terminal branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modifySelection(\n              phylotree.selectAllDescendants(node, true, false)\n            );\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All internal branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modifySelection(\n              phylotree.selectAllDescendants(node, false, true)\n            );\n          });\n      }\n    }\n\n    if (node.parent) {\n      if (options[\"selectable\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Incident branch\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modifySelection([node]);\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Path to root\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.modifySelection(this.phylotree.pathToRoot(node));\n          });\n\n        if (options[\"reroot\"] || options[\"hide\"]) {\n          menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n        }\n      }\n\n      if (options[\"reroot\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Reroot on this node\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.phylotree.reroot(node);\n            this.update();\n          });\n      }\n\n      if (options[\"hide\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Hide this \" + (isLeafNode(node) ? \"node\" : \"subtree\"))\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.modifySelection([node], \"notshown\", true, true)\n              .updateHasHiddenNodes()\n              .update();\n          });\n      }\n    }\n\n    if (hasHiddenNodes(node)) {\n      menu_object\n        .append(\"a\")\n        .attr(\"class\", \"dropdown-item\")\n        .attr(\"tabindex\", \"-1\")\n        .text(\"Show all descendant nodes\")\n        .on(\"click\", function(d) {\n          menu_object.style(\"display\", \"none\");\n          phylotree\n            .modifySelection(\n              phylotree.selectAllDescendants(node, true, true),\n              \"notshown\",\n              true,\n              true,\n              \"false\"\n            )\n            .updateHasHiddenNodes()\n            .update();\n        });\n    }\n\n    // now see if we need to add user defined menus\n\n    var has_user_elements = [];\n    if (\"menu_items\" in node && typeof node[\"menu_items\"] === \"object\") {\n      node[\"menu_items\"].forEach(function(d) {\n        if (d.length == 3) {\n          if (!d[2] || d[2](node)) {\n            has_user_elements.push([d[0], d[1]]);\n          }\n        }\n      });\n    }\n\n    if (has_user_elements.length) {\n      const show_divider_options = [\n        options[\"hide\"],\n        options[\"selectable\"],\n        options[\"collapsible\"]\n      ];\n\n      if (_.some(show_divider_options)) {\n        menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n      }\n\n      has_user_elements.forEach(function(d) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(constant(d[0])(node)) // eslint-disable-line\n          .on(\"click\", _.partial(d[1], node));\n      });\n    }\n\n    let tree_container = $(container); // eslint-disable-line\n    let coordinates = d3.mouse(tree_container[0]);\n\n    menu_object\n      .style(\"position\", \"absolute\")\n      .style(\"left\", \"\" + (coordinates[0] + tree_container.position().left) + \"px\")\n      .style(\"top\", \"\" + (coordinates[1] + tree_container.position().top) + \"px\")\n      .style(\"display\", \"block\");\n  } else {\n    menu_object.style(\"display\", \"none\");\n  }\n}\n\nexport function addCustomMenu(node, name, callback, condition) {\n  if (!(\"menu_items\" in node)) {\n    node[\"menu_items\"] = [];\n  }\n  if (\n    !node[\"menu_items\"].some(function(d) {\n      return d[0] == name && d[1] == callback && d[2] == condition;\n    })\n  ) {\n    node[\"menu_items\"].push([name, callback, condition]);\n  }\n}\n\n/**\n *\n * Modify the current selection, via functional programming.\n *\n * @param {Function} node_selecter A function to apply to each node, which\n * determines whether they become part of the current selection. Alternatively,\n * if ``restricted-selectable`` mode is enabled, a string describing one of\n * the pre-defined restricted-selectable options.\n * @param {String} attr (Optional) The selection attribute to modify.\n * @param {Boolean} place (Optional) Whether or not ``placenodes`` should be called.\n * @param {Boolean} skip_refresh (Optional) Whether or not a refresh is called.\n * @param {String} mode (Optional) Can be ``\"toggle\"``, ``\"true\"``, or ``\"false\"``.\n * @returns The current ``this``.\n *\n */\nexport function modifySelection(\n  node_selecter,\n  attr,\n  place,\n  skip_refresh,\n  mode\n) {\n\n  attr = attr || this.selection_attribute_name;\n  mode = mode || \"toggle\";\n\n  // check if node_selecter is a value of pre-defined selecters\n\n  if (this.options[\"restricted-selectable\"].length) {\n    // the selection must be from a list of pre-determined selections\n    if (_.contains(_.keys(predefined_selecters), node_selecter)) {\n      node_selecter = predefined_selecters[node_selecter];\n    } else {\n      return;\n    }\n  }\n\n  if (\n    (this.options[\"restricted-selectable\"] || this.options[\"selectable\"]) &&\n    !this.options[\"binary-selectable\"]\n  ) {\n    var do_refresh = false;\n\n    if (typeof node_selecter === \"function\") {\n      this.links.forEach(function(d) {\n        let select_me = node_selecter(d);\n        d[attr] = d[attr] || false;\n        if (d[attr] != select_me) {\n          d[attr] = select_me;\n          do_refresh = true;\n          d.target[attr] = select_me;\n        }\n      });\n    } else {\n      node_selecter.forEach(function(d) {\n        var new_value;\n        switch (mode) {\n          case \"true\":\n            new_value = true;\n            break;\n          case \"false\":\n            new_value = false;\n            break;\n          default:\n            new_value = !d[attr];\n            break;\n        }\n\n        if (d[attr] != new_value) {\n          d[attr] = new_value;\n          do_refresh = true;\n        }\n      });\n\n      this.links.forEach(function(d) {\n        d[attr] = d.target[attr];\n      });\n    }\n\n    var counts;\n\n    if (do_refresh) {\n      if (!skip_refresh) {\n        events.triggerRefresh(this);\n      }\n      if (this.countHandler) {\n        counts = {};\n        counts[attr] = this.links.reduce(function(p, c) {\n          return p + (c[attr] ? 1 : 0);\n        }, 0);\n        events.countUpdate(this, counts, this.countHandler);\n      }\n\n      if (place) {\n        this.placenodes();\n      }\n    }\n  } else if (this.options[\"binary-selectable\"]) {\n    if (typeof node_selecter === \"function\") {\n      this.links.forEach(function(d) {\n        var select_me = node_selecter(d);\n        d[attr] = d[attr] || false;\n\n        if (d[attr] != select_me) {\n          d[attr] = select_me;\n          do_refresh = true;\n          d.target[attr] = select_me;\n        }\n\n        this.options[\"attribute-list\"].forEach(function(type) {\n          if (type != attr && d[attr] === true) {\n            d[type] = false;\n            d.target[type] = false;\n          }\n        });\n      });\n    } else {\n      node_selecter.forEach(function(d) {\n        var new_value;\n        new_value = !d[attr];\n\n        if (d[attr] != new_value) {\n          d[attr] = new_value;\n          do_refresh = true;\n        }\n      });\n\n      this.links.forEach(function(d) {\n        d[attr] = d.target[attr];\n        this.options[\"attribute-list\"].forEach(function(type) {\n          if (type != attr && d[attr] !== true) {\n            d[type] = false;\n            d.target[type] = false;\n          }\n        });\n      });\n    }\n\n    if (do_refresh) {\n      if (!skip_refresh) {\n        events.triggerRefresh(this);\n      }\n      if (this.countHandler()) {\n        counts = {};\n        counts[attr] = this.links.reduce(function(p, c) {\n          return p + (c[attr] ? 1 : 0);\n        }, 0);\n        this.countUpdate(this, counts, this.countHandler());\n      }\n\n      if (place) {\n        this.placenodes();\n      }\n    }\n  }\n\n  if (this.selectionCallback && attr != \"tag\") {\n    this.selectionCallback(this.getSelection());\n  }\n\n  this.refresh();\n  this.update();\n  return this;\n}\n\n/**\n * Get nodes which are currently selected.\n *\n * @returns {Array} An array of nodes that match the current selection.\n */\nexport function getSelection() {\n  return this.nodes.filter(d => {\n    return d[this.selection_attribute_name];\n  });\n}\n\n/**\n * Select all descendents of a given node, with options for selecting\n * terminal/internal nodes.\n *\n * @param {Node} node The node whose descendents should be selected.\n * @param {Boolean} terminal Whether to include terminal nodes.\n * @param {Boolean} internal Whther to include internal nodes.\n * @returns {Array} An array of selected nodes.\n */\nexport function selectAllDescendants(node, terminal, internal) {\n  let selection = [];\n\n  function sel(d) {\n    if (isLeafNode(d)) {\n      if (terminal) {\n        if (d != node) selection.push(d);\n      }\n    } else {\n      if (internal) {\n        if (d != node) selection.push(d);\n      }\n      d.children.forEach(sel);\n    }\n  }\n\n  sel(node);\n  return selection;\n}\n\n/**\n * Getter/setter for the selection callback. This function is called\n * every time the current selection is modified, and its argument is\n * an array of nodes that make up the current selection.\n *\n * @param {Function} callback (Optional) The selection callback function.\n * @returns The current ``selectionCallback`` if getting, or the current ``this`` if setting.\n */\nexport function selectionCallback(callback) {\n  if (!callback) return this.selectionCallback;\n  this.selectionCallback = callback;\n  return this;\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\nimport { drawArc, cartesianToPolar, arcSegmentPlacer } from \"./radial\";\nimport { default as draw_line, lineSegmentPlacer } from \"./cartesian\";\nimport { isLeafNode } from \"../nodes\";\nimport { xCoord, yCoord } from \"./coordinates\";\nimport * as clades from \"./clades\";\nimport * as render_nodes from \"./nodes\";\nimport * as render_edges from \"./edges\";\nimport * as events from \"./events\";\nimport { css_classes } from \"./options\";\nimport * as opt from \"./options\";\nimport * as menus from \"./menus\";\n\n// replacement for d3.functor\nfunction constant(x) {\n  return function() {\n    return x;\n  };\n}\n\nclass TreeRender {\n  constructor(phylotree, options = {}) {\n    this.css_classes = css_classes;\n    this.phylotree = phylotree;\n    this.container = options.container;\n    this.separation = function(_node, _previous) {\n      return 0;\n    };\n\n    this._nodeLabel = this.defNodeLabel;\n    this.svg = null;\n    this.selectionCallback = null;\n    this.scales = [1, 1];\n    this.size = [1, 1];\n    this.fixed_width = [14, 30];\n    this.font_size = 12;\n    this.scale_bar_font_size = 12;\n    this.offsets = [0, this.font_size / 2];\n\n    this.draw_branch = draw_line;\n    this.draw_scale_bar = null;\n    this.edge_placer = lineSegmentPlacer;\n    this.count_listener_handler = function() {};\n    this.layout_listener_handler = function() {};\n    this.node_styler = undefined;\n    this.edge_styler = undefined;\n    this.shown_font_size = this.font_size;\n    this.selection_attribute_name = \"selected\";\n    this.right_most_leaf = 0;\n    this.label_width = 0;\n    this.radial_center = 0;\n    this.radius = 1;\n    this.radius_pad_for_bubbles = 0;\n    this.rescale_nodeSpan = 1;\n    this.relative_nodeSpan = function(_node) {\n      return this.nodeSpan(_node) / this.rescale_nodeSpan;\n    };\n\n    let default_options = {\n      layout: \"left-to-right\",\n      logger: console,\n      branches: \"step\",\n      scaling: true,\n      bootstrap: false,\n      \"color-fill\": true,\n      \"internal-names\": false,\n      selectable: true,\n      // restricted-selectable can take an array of predetermined\n      // selecters that are defined in phylotree.predefined_selecters\n      // only the defined functions will be allowed when selecting\n      // branches\n      \"restricted-selectable\": false,\n      collapsible: true,\n      \"left-right-spacing\": \"fixed-step\", //'fit-to-size',\n      \"top-bottom-spacing\": \"fixed-step\",\n      \"left-offset\": 0,\n      \"show-scale\": \"top\",\n      // currently not implemented to support any other positioning\n      \"draw-size-bubbles\": false,\n      \"binary-selectable\": false,\n      \"is-radial\": false,\n      \"attribute-list\": [],\n      \"max-radius\": 768,\n      \"annular-limit\": 0.38196601125010515,\n      compression: 0.2,\n      \"align-tips\": false,\n      \"maximum-per-node-spacing\": 100,\n      \"minimum-per-node-spacing\": 2,\n      \"maximum-per-level-spacing\": 100,\n      \"minimum-per-level-spacing\": 10,\n      node_circle_size: constant(3),\n      transitions: null,\n      brush: true,\n      reroot: true,\n      hide: true,\n      \"label-nodes-with-name\": false,\n      zoom: false,\n      \"show-menu\": true,\n      \"show-labels\": true,\n      \"node-styler\": null,\n      \"edge-styler\": null,\n      \"node-span\": null\n    };\n\n    this.ensure_size_is_in_px = function(value) {\n      return typeof value === \"number\" ? value + \"px\" : value;\n    };\n\n    this.options = _.defaults(options, default_options);\n\n    this.width = this.options.width || 800;\n    this.height = this.options.height || 600;\n\n    this.node_styler = this.options['node-styler'];\n    this.edge_styler = this.options['edge-styler'];\n\n    this.nodeSpan = this.options['node-span'];\n\n    if(!this.nodeSpan) {\n      this.nodeSpan = function(_node) {\n        return 1;\n      };\n    }\n\n    this.rescale_nodeSpan =\n      this.phylotree.nodes.children\n        .map(d => {\n          if (isLeafNode(d) || this.showInternalName(d))\n            return this.nodeSpan(d);\n        })\n        .reduce(function(p, c) {\n          return Math.min(c, p || 1e200);\n        }, null) || 1;\n\n    this.initialize_svg(this.container);\n    this.links = this.phylotree.nodes.links();\n    this.initializeEdgeLabels();\n    this.update();\n    events.d3PhylotreeAddEventListener();\n  }\n\n  pad_height() {\n    if (this.draw_scale_bar) {\n      return this.scale_bar_font_size + 25;\n    }\n\n    return 0;\n  }\n\n  pad_width() {\n    // reset label_width\n    this.label_width = this._label_width(this.shown_font_size);\n\n    const _label_width = this.options[\"show-labels\"] ? this.label_width : 0;\n    return this.offsets[1] + this.options[\"left-offset\"] + _label_width;\n  }\n\n  /**\n   * Collapses a given node.\n   *\n   * @param {Node} node A node to be collapsed.\n   */\n  collapse_node(n) {\n    if (!render_nodes.isNodeCollapsed(n)) {\n      n.collapsed = true;\n    }\n  }\n\n  /**\n   * Get or set the size of tree in pixels.\n   *\n   * @param {Array} attr (optional) An array of the form ``[height, width]``.\n   * @returns {Phylotree} The current ``size`` array if getting, or the current ``phylotree``\n   * if setting.\n   */\n  set_size(attr) {\n    if (!arguments.length) {\n      return this.size;\n    }\n\n    let phylo_attr = attr;\n\n    if (this.options[\"top-bottom-spacing\"] != \"fixed-step\") {\n      this.size[0] = phylo_attr[0];\n    }\n    if (this.options[\"left-right-spacing\"] != \"fixed-step\") {\n      this.size[1] = phylo_attr[1];\n    }\n\n    return this;\n  }\n\n  /**\n   * Getter/setter for the SVG element for the Phylotree to be rendered in.\n   *\n   * @param {d3-selection} svg_element (Optional) SVG element to render within, selected by D3.\n   * @returns The selected SVG element if getting, or the current ``phylotree`` if setting.`\n   */\n  initialize_svg(svg_element) {\n    //if (!arguments.length) return this.svg;\n\n    if (this.svg !== svg_element) {\n      d3.select(svg_element)\n        .select(\"svg\")\n        .remove();\n\n      this.svg = d3\n        .create(\"svg\")\n        .attr(\"width\", this.width)\n        .attr(\"height\", this.height);\n\n      this.set_size([this.height, this.width]);\n\n      if (this.css_classes[\"tree-container\"] == \"phylotree-container\") {\n        this.svg.selectAll(\"*\").remove();\n        this.svg.append(\"defs\");\n      }\n\n      d3.select(this.container).on(\n        \"click\",\n        d => {\n          this.handle_node_click(null);\n        },\n        true\n      );\n    }\n\n    return this;\n  }\n\n  update_layout(new_json, do_hierarchy) {\n    if (do_hierarchy) {\n      this.nodes = d3.hierarchy(new_json);\n      this.nodes.each(function(d) {\n        d.id = null;\n      });\n    }\n\n    this.update();\n    this.syncEdgeLabels();\n  }\n\n  /**\n   * Update the current phylotree, i.e., alter the svg\n   * elements.\n   *\n   * @param {Boolean} transitions (Optional) Toggle whether transitions should be shown.\n   * @returns The current ``phylotree``.\n   */\n  update(transitions) {\n\n    var self = this;\n\n    //if (!this.svg) return this;\n\n    this.placenodes();\n\n    transitions = this.transitions(transitions);\n\n    let node_id = 0;\n\n    let enclosure = this.svg\n      .selectAll(\".\" + css_classes[\"tree-container\"])\n      .data([0]);\n\n    enclosure = enclosure\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", css_classes[\"tree-container\"])\n      .merge(enclosure)\n      .attr(\"transform\", d => {\n        return this.d3PhylotreeSvgTranslate([\n          this.offsets[1] + this.options[\"left-offset\"],\n          this.pad_height()\n        ]);\n      });\n\n    if (this.draw_scale_bar) {\n      let scale_bar = this.svg\n        .selectAll(\".\" + css_classes[\"tree-scale-bar\"])\n        .data([0]);\n\n      scale_bar\n        .enter()\n        .append(\"g\")\n        .attr(\"class\", css_classes[\"tree-scale-bar\"])\n        .style(\"font-size\", this.ensure_size_is_in_px(this.scale_bar_font_size))\n        .merge(scale_bar)\n        .attr(\"transform\", d => {\n          return this.d3PhylotreeSvgTranslate([\n            this.offsets[1] + this.options[\"left-offset\"],\n            this.pad_height() - 10\n          ]);\n        })\n        .call(this.draw_scale_bar);\n\n      scale_bar.selectAll(\"text\").style(\"text-anchor\", \"end\");\n    } else {\n      this.svg.selectAll(\".\" + css_classes[\"tree-scale-bar\"]).remove();\n    }\n\n    enclosure = this.svg\n      .selectAll(\".\" + css_classes[\"tree-container\"])\n      .data([0]);\n\n    this.updateCollapsedClades(transitions);\n\n    let drawn_links = enclosure\n      .selectAll(render_edges.edgeCssSelectors(css_classes))\n      .data(this.links.filter(render_edges.edgeVisible), d => {\n        return d.target.id || (d.target.id = ++node_id);\n      });\n\n    if (transitions) {\n      drawn_links.exit().remove();\n    } else {\n      drawn_links.exit().remove();\n    }\n\n    drawn_links = drawn_links\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .merge(drawn_links)\n      .each(function(d) {\n        self.drawEdge(this, d, transitions);\n      });\n\n    let drawn_nodes = enclosure\n      .selectAll(render_nodes.nodeCssSelectors(css_classes))\n      .data(\n        this.phylotree.nodes.descendants().filter(render_nodes.nodeVisible),\n        d => {\n          return d.id || (d.id = ++node_id);\n        }\n      );\n\n    drawn_nodes.exit().remove();\n\n    drawn_nodes = drawn_nodes\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", this.reclassNode)\n      .merge(drawn_nodes)\n      .attr(\"transform\", d => {\n        const should_shift =\n          this.options[\"layout\"] == \"right-to-left\" && isLeafNode(d);\n\n        d.screen_x = xCoord(d);\n        d.screen_y = yCoord(d);\n\n        return this.d3PhylotreeSvgTranslate([\n          should_shift ? 0 : d.screen_x,\n          d.screen_y\n        ]);\n      })\n      .each(function(d) {\n        self.drawNode(this, d, transitions);\n      })\n      .attr(\"transform\", d => {\n        if (!_.isUndefined(d.screen_x) && !_.isUndefined(d.screen_y)) {\n          return \"translate(\" + d.screen_x + \",\" + d.screen_y + \")\";\n        }\n      });\n\n    if (this.options[\"label-nodes-with-name\"]) {\n      drawn_nodes = drawn_nodes.attr(\"id\", d => {\n        return \"node-\" + d.name;\n      });\n    }\n\n    this.resizeSvg(this.phylotree, this.svg, transitions);\n\n    if (this.options[\"brush\"]) {\n      var brush = enclosure\n        .selectAll(\".\" + css_classes[\"tree-selection-brush\"])\n        .data([0])\n        .enter()\n        .insert(\"g\", \":first-child\")\n        .attr(\"class\", css_classes[\"tree-selection-brush\"]);\n\n      var brush_object = d3\n        .brush()\n        .on(\"brush\", d => {\n          var extent = d3.event.selection,\n            shown_links = this.links.filter(render_edges.edgeVisible);\n          var selected_links = shown_links\n              .filter((d, i) => {\n                return (\n                  d.source.screen_x >= extent[0][0] &&\n                  d.source.screen_x <= extent[1][0] &&\n                  d.source.screen_y >= extent[0][1] &&\n                  d.source.screen_y <= extent[1][1] &&\n                  d.target.screen_x >= extent[0][0] &&\n                  d.target.screen_x <= extent[1][0] &&\n                  d.target.screen_y >= extent[0][1] &&\n                  d.target.screen_y <= extent[1][1]\n                );\n              })\n              .map(d => {\n                return d.target;\n              });\n\n          this.modifySelection(\n            this.phylotree.links.map(d => {\n              return d.target;\n            }),\n            \"tag\",\n            false,\n            selected_links.length > 0,\n            \"false\"\n          );\n\n          this.modifySelection(selected_links, \"tag\", false, false, \"true\");\n        })\n        .on(\"end\", () => {\n          //brush.call(d3.event.target.clear());\n        });\n\n      brush.call(brush_object);\n    }\n\n    this.syncEdgeLabels();\n\n    if (this.options[\"zoom\"]) {\n      let zoom = d3\n        .zoom()\n        .scaleExtent([0.1, 10])\n        .on(\"zoom\", () => {\n\n          d3.select(\".\" + css_classes[\"tree-container\"]).attr(\"transform\", d => {\n            let toTransform = d3.event.transform;\n            return toTransform;\n          });\n\n          // Give some extra room\n          d3.select(\".\" + css_classes[\"tree-scale-bar\"]).attr(\"transform\", d => {\n            let toTransform = d3.event.transform;\n            toTransform.y -= 10; \n            return toTransform;\n          });\n          \n        });\n\n      this.svg.call(zoom);\n    }\n\n    return this;\n  }\n\n  _handle_single_node_layout(\n    a_node\n  ) {\n    let _nodeSpan = this.nodeSpan(a_node) / this.rescale_nodeSpan;\n    // compute the relative size of nodes (0,1)\n    // sum over all nodes is 1\n    this.x = a_node.x =\n      this.x +\n      this.separation(this.last_node, a_node) +\n      (this.last_span + _nodeSpan) * 0.5;\n      \n \n    // separation is a user-settable callback to add additional spacing on nodes\n    this._extents[1][1] = Math.max(this._extents[1][1], a_node.y);\n    this._extents[1][0] = Math.min(\n      this._extents[1][0],\n      a_node.y - _nodeSpan * 0.5\n    );\n    \n\n    if (this.is_under_collapsed_parent) {\n       this._extents[0][1] = Math.max(\n        this._extents[0][1],\n        this.save_x +\n          (a_node.x - this.save_x) * this.options[\"compression\"] +\n          this.save_span +\n          (_nodeSpan * 0.5 + this.separation(this.last_node, a_node)) *\n            this.options[\"compression\"]\n      );      \n    } else {\n      this._extents[0][1] = Math.max(\n        this._extents[0][1],\n        this.x + _nodeSpan * 0.5 + this.separation(this.last_node, a_node)\n      );\n    }\n\n\n    this.last_node = a_node;\n    this.last_span = _nodeSpan;\n    \n  }\n\n  tree_layout(a_node) {\n    /**\n            for each node: \n                y: the y coordinate is root to tip\n                    (left to right in cladogram layout, radius is radial layout\n                x : the x coordinate is top-most to bottom-most \n                    (top to bottom in cladogram layout, angle in radial layout)\n                \n                \n         @return the x-coordinate of a_node or undefined in the node is not displayed\n                 (hidden or under a collapsed node)\n        */\n\n\n    // do not layout hidden nodes\n    if (render_nodes.nodeNotshown(a_node)) {\n      return undefined;\n    }\n\n    let is_leaf = isLeafNode(a_node);\n\n    // the next four members are radial layout options\n    a_node.text_angle = null; // the angle at which text is being laid out\n    a_node.text_align = null; // css alignment option for node labels\n    a_node.radius = null; // radial layout radius\n    a_node.angle = null; // radial layout angle (in radians)\n\n    /** determine the root-to-tip location of this node;\n            \n      the root node receives the co-ordinate of 0\n      \n      if the tree has branch lengths, then the placement of each node is simply the \n      total branch length to the root\n      \n      if the tree has no branch lengths, all leaves get the same depth (\"number of internal nodes on the deepest path\")\n      and all internal nodes get the depth in integer units of the # of internal nodes on the path to the root + 1\n        \n    */\n\n    let undef_BL = false;\n\n    /** _extents computes a bounding box for the tree (initially NOT in screen \n            coordinates)\n\n        all account for node sizes\n\n        _extents [1][0] -- the minimum x coordinate (breadth)\n        _extents [1][1] -- the maximum y coordinate (breadth)\n        _extents [1][0] -- the minimum y coordinate (root-to-tip, or depthwise)\n        _extents [1][1] -- the maximum y coordinate (root-to-tip, or depthwise)\n\n    */\n\n\n    // last node laid out in the top bottom hierarchy\n\n    if (a_node[\"parent\"]) {\n      if (this.do_scaling) {\n        if (undef_BL) {\n          return 0;\n        }\n\n        a_node.y = this.phylotree.branch_length_accessor(a_node);\n\n        if (typeof a_node.y === \"undefined\") {\n          undef_BL = true;\n          return 0;\n        }\n        a_node.y += a_node.parent.y;\n      } else {\n        a_node.y = is_leaf ? this.max_depth : a_node.depth;\n      }\n    } else {\n      this.x = 0.0;\n      // the span of the last node laid out in the top to bottom hierarchy\n      a_node.y = 0.0;\n      this.last_node = null;\n      this.last_span = 0.0;\n      this._extents = [[0, 0], [0, 0]];\n    }\n\n    /** the next block has to do with top-to-bottom spacing of nodes **/\n\n    if (is_leaf) {\n      // displayed internal nodes are handled in `process_internal_node`\n      this._handle_single_node_layout(\n        a_node\n      );\n    }\n\n    if (!is_leaf) {\n      // for internal nodes\n      if (\n        render_nodes.isNodeCollapsed(a_node) &&\n        !this.is_under_collapsed_parent\n      ) {\n        // collapsed node\n        this.save_x = this.x;\n        this.save_span = this.last_span * 0.5;\n        this.is_under_collapsed_parent = true;\n        this.process_internal_node(a_node);\n        this.is_under_collapsed_parent = false;\n \n        if (typeof a_node.x === \"number\") {\n          a_node.x =\n            this.save_x +\n            (a_node.x -this.save_x) * this.options[\"compression\"] +\n            this.save_span;\n\n          a_node.collapsed = [[a_node.x, a_node.y]];\n\n          var map_me = n => {\n            n.hidden = true;\n\n            if (isLeafNode(n)) {            \n              this.x = n.x =\n                this.save_x +\n                (n.x - this.save_x) * this.options[\"compression\"] +\n                this.save_span;\n\n              a_node.collapsed.push([n.x, n.y]);             \n            } else {\n              n.children.map(map_me);\n            }\n          };\n\n          this.x = this.save_x;\n          map_me(a_node);\n         \n\n          a_node.collapsed.splice(1, 0, [this.save_x, a_node.y]);\n          a_node.collapsed.push([this.x, a_node.y]);\n          a_node.collapsed.push([a_node.x, a_node.y]);\n          a_node.hidden = false;\n        }\n      } else {\n        // normal node, or under a collapsed parent\n        this.process_internal_node(a_node);\n      }\n    }\n\n    return a_node.x;\n  }\n\n  process_internal_node(a_node) {\n    /** \n            decide if the node will be shown, and compute its top-to-bottom (breadthwise)\n            placement \n        */\n\n    let count_undefined = 0;\n\n    if (this.showInternalName(a_node)) {\n      // do in-order traversal to allow for proper internal node spacing\n      // (x/2) >> 0 is integer division\n      let half_way = (a_node.children.length / 2) >> 0;\n      let displayed_children = 0;\n      let managed_to_display = false;\n\n      for (let child_id = 0; child_id < a_node.children.length; child_id++) {\n        let child_x = this.tree_layout(a_node.children[child_id]);//.bind(this);\n\n        if (typeof child_x == \"number\") {\n          displayed_children++;\n        }\n\n        if (displayed_children >= half_way && !managed_to_display) {\n          this._handle_single_node_layout(a_node);\n          managed_to_display = true;\n        }\n      }\n\n      if (displayed_children == 0) {\n        a_node.notshown = true;\n        a_node.x = undefined;\n      } else {\n        if (!managed_to_display) {\n          this._handle_single_node_layout(a_node);\n        }\n      }\n    } else {\n      // postorder layout\n      a_node.x = a_node.children\n        .map(this.tree_layout.bind(this))\n        .reduce((a, b) => {\n          if (typeof b == \"number\") return a + b;\n          count_undefined += 1;\n          return a;\n        }, 0.0);\n\n      if (count_undefined == a_node.children.length) {\n        a_node.notshown = true;\n        a_node.x = undefined;\n      } else {\n        a_node.x /= a_node.children.length - count_undefined;\n      }\n    }\n  }\n\n  do_lr(at_least_one_dimension_fixed) {\n    if (this.radial() && at_least_one_dimension_fixed) {\n      this.offsets[1] = 0;\n    }\n\n    if (this.options[\"left-right-spacing\"] == \"fixed-step\") {\n      this.size[1] = this.max_depth * this.fixed_width[1];\n\n      this.scales[1] = \n        (this.size[1] - this.offsets[1] - this.options[\"left-offset\"]) /\n        this._extents[1][1];\n\n      this.label_width = this._label_width(this.shown_font_size);\n\n      if (this.radial()) {\n        this.label_width *= 2;\n      }\n    } else {\n      this.label_width = this._label_width(this.shown_font_size);\n\n      at_least_one_dimension_fixed = true;\n\n      let available_width =\n        this.size[1] - this.offsets[1] - this.options[\"left-offset\"];\n\n      if (available_width * 0.5 < this.label_width) {\n        this.shown_font_size *= (available_width * 0.5) / this.label_width;\n        this.label_width = available_width * 0.5;\n      }\n\n      this.scales[1] =\n        (this.size[1] -\n          this.offsets[1] -\n          this.options[\"left-offset\"] -\n          this.label_width) /\n        this._extents[1][1];\n    }\n  }\n\n  /**\n   * Place the current nodes, i.e., determine their coordinates based\n   * on current settings.\n   *\n   * @returns The current ``phylotree``.\n   */\n  placenodes() {\n    this._extents = [\n      [0, 0],\n      [0, 0]\n    ];\n\n    this.x = 0.0;\n    this.last_span = 0.0;\n    //let x = 0.0,\n    //  last_span = 0;\n    \n    this.last_node = null;\n    this.last_span = 0.0;\n\n    (this.save_x = this.x), (this.save_span = this.last_span * 0.5);\n\n    this.do_scaling = this.options[\"scaling\"];\n    let undef_BL = false;\n\n    this.is_under_collapsed_parent = false;\n    this.max_depth = 1;\n    \n    // Set initial x\n    this.phylotree.nodes.x = this.tree_layout(\n      this.phylotree.nodes,\n      this.do_scaling\n    );\n\n    this.max_depth = d3.max(this.phylotree.nodes.descendants(), n => {\n      return n.depth;\n    });\n\n    if (this.do_scaling && undef_BL) {\n      // requested scaling, but some branches had no branch lengths\n      // redo layout without branch lengths\n      this.do_scaling = false;\n      this.phylotree.nodes.x = this.tree_layout(this.phylotree.nodes);\n    }\n\n    let at_least_one_dimension_fixed = false;\n\n    this.draw_scale_bar = this.options[\"show-scale\"] && this.do_scaling;\n\n    // this is a hack so that phylotree.pad_height would return ruler spacing\n    this.offsets[1] = Math.max(\n      this.font_size,\n      -this._extents[1][0] * this.fixed_width[0]\n    );\n\n    if (this.options[\"top-bottom-spacing\"] == \"fixed-step\") {\n      this.size[0] = this._extents[0][1] * this.fixed_width[0];\n      this.scales[0] = this.fixed_width[0];\n    } else {\n      this.scales[0] = (this.size[0] - this.pad_height()) / this._extents[0][1];\n      at_least_one_dimension_fixed = true;\n    }\n\n    this.shown_font_size = Math.min(this.font_size, this.scales[0]);\n\n    if (this.radial()) {\n      // map the nodes to polar coordinates\n      this.draw_branch = _.partial(drawArc, this.radial_center);\n      this.edge_placer = arcSegmentPlacer;\n\n      let last_child_angle = null,\n        last_circ_position = null,\n        last_child_radius = null,\n        min_radius = 0,\n        effective_span = this._extents[0][1] * this.scales[0];\n\n      let compute_distance = function(r1, r2, a1, a2, annular_shift) {\n        annular_shift = annular_shift || 0;\n        return Math.sqrt(\n          (r2 - r1) * (r2 - r1) +\n            2 *\n              (r1 + annular_shift) *\n              (r2 + annular_shift) *\n              (1 - Math.cos(a1 - a2))\n        );\n      };\n\n      let max_r = 0;\n\n      this.phylotree.nodes.each(d => {\n        let my_circ_position = d.x * this.scales[0];\n        d.angle = (2 * Math.PI * my_circ_position) / effective_span;\n        d.text_angle = d.angle - Math.PI / 2;\n        d.text_angle = d.text_angle > 0 && d.text_angle < Math.PI;\n        d.text_align = d.text_angle ? \"end\" : \"start\";\n        d.text_angle = (d.text_angle ? 180 : 0) + (d.angle * 180) / Math.PI;\n      });\n\n      this.do_lr(at_least_one_dimension_fixed);\n\n      this.phylotree.nodes.each(d => {\n        d.radius = (d.y * this.scales[1]) / this.size[1];\n        max_r = Math.max(d.radius, max_r);\n      });\n\n      let annular_shift = 0;\n\n      this.phylotree.nodes.each(d => {\n        if (!d.children) {\n          let my_circ_position = d.x * this.scales[0];\n          if (last_child_angle !== null) {\n            let required_spacing = my_circ_position - last_circ_position,\n              radial_dist = compute_distance(\n                d.radius,\n                last_child_radius,\n                d.angle,\n                last_child_angle,\n                annular_shift\n              );\n\n            let local_mr =\n              radial_dist > 0\n                ? required_spacing / radial_dist\n                : 10 * this.options[\"max-radius\"];\n\n            if (local_mr > this.options[\"max-radius\"]) {\n              // adjust the annular shift\n              let dd = required_spacing / this.options[\"max-radius\"],\n                b = d.radius + last_child_radius,\n                c =\n                  d.radius * last_child_radius -\n                  (dd * dd -\n                    (last_child_radius - d.radius) *\n                      (last_child_radius - d.radius)) /\n                    2 /\n                    (1 - Math.cos(last_child_angle - d.angle)),\n                st = Math.sqrt(b * b - 4 * c);\n\n              annular_shift = Math.min(\n                this.options[\"annular-limit\"] * max_r,\n                (-b + st) / 2\n              );\n              min_radius = this.options[\"max-radius\"];\n            } else {\n              min_radius = Math.max(min_radius, local_mr);\n            }\n          }\n\n          last_child_angle = d.angle;\n          last_circ_position = my_circ_position;\n          last_child_radius = d.radius;\n        }\n      });\n\n      this.radius = Math.min(\n        this.options[\"max-radius\"],\n        Math.max(effective_span / 2 / Math.PI, min_radius)\n      );\n\n      if (at_least_one_dimension_fixed) {\n        this.radius = Math.min(\n          this.radius,\n          (Math.min(effective_span, this._extents[1][1] * this.scales[1]) -\n            this.label_width) *\n            0.5 -\n            this.radius * annular_shift\n        );\n      }\n\n      this.radial_center = this.radius_pad_for_bubbles = this.radius;\n      this.draw_branch = _.partial(drawArc, this.radial_center);\n\n      let scaler = 1;\n\n      if (annular_shift) {\n        scaler = max_r / (max_r + annular_shift);\n        this.radius *= scaler;\n      }\n\n      this.phylotree.nodes.each(d => {\n        cartesianToPolar(\n          d,\n          this.radius,\n          annular_shift,\n          this.radial_center,\n          this.scales,\n          this.size\n        );\n\n        max_r = Math.max(max_r, d.radius);\n\n        if (this.options[\"draw-size-bubbles\"]) {\n          this.radius_pad_for_bubbles = Math.max(\n            this.radius_pad_for_bubbles,\n            d.radius + this.nodeBubbleSize(d)\n          );\n        } else {\n          this.radius_pad_for_bubbles = Math.max(\n            this.radius_pad_for_bubbles,\n            d.radius\n          );\n        }\n\n        if (d.collapsed) {\n          d.collapsed = d.collapsed.map(p => {\n            let z = {};\n            z.x = p[0];\n            z.y = p[1];\n            z = cartesianToPolar(\n              z,\n              this.radius,\n              annular_shift,\n              this.radial_center,\n              this.scales,\n              this.size\n            );\n            return [z.x, z.y];\n          });\n\n          let last_point = d.collapsed[1];\n\n          d.collapsed = d.collapsed.filter(function(p, i) {\n            if (i < 3 || i > d.collapsed.length - 4) return true;\n            if (\n              Math.sqrt(\n                Math.pow(p[0] - last_point[0], 2) +\n                  Math.pow(p[1] - last_point[1], 2)\n              ) > 3\n            ) {\n              last_point = p;\n              return true;\n            }\n            return false;\n          });\n        }\n      });\n\n      this.size[0] = this.radial_center + this.radius / scaler;\n      this.size[1] = this.radial_center + this.radius / scaler;\n    } else {\nthis.do_lr();\n\n      this.draw_branch = draw_line;\n      this.edge_placer = lineSegmentPlacer;\n      this.right_most_leaf = 0;\n\n      this.phylotree.nodes.each(d => {\n\n        d.x *= this.scales[0];\n        d.y *= this.scales[1]*.8;\n\n        if (this.options[\"layout\"] == \"right-to-left\") {   \n          d.y = this._extents[1][1] * this.scales[1] - d.y;\n        }\n\n\n        if (isLeafNode(d)) {\n          this.right_most_leaf = Math.max(\n            this.right_most_leaf,\n            d.y + this.nodeBubbleSize(d)\n          );\n        }\n\n        if (d.collapsed) {\n          d.collapsed.forEach(p => {\n            p[0] *= this.scales[0];\n            p[1] *= this.scales[1]*.8;\n          });\n\n          let last_x = d.collapsed[1][0];\n\n          d.collapsed = d.collapsed.filter(function(p, i) {\n            if (i < 3 || i > d.collapsed.length - 4) return true;\n            if (p[0] - last_x > 3) {\n              last_x = p[0];\n              return true;\n            }\n            return false;\n          });\n        }\n      });\n    }\n\n    if (this.draw_scale_bar) {\n      let domain_limit, range_limit;\n\n      if (this.radial()) {\n        range_limit = Math.min(this.radius / 5, 50);\n        domain_limit = Math.pow(\n          10,\n          Math.ceil(\n            Math.log((this._extents[1][1] * range_limit) / this.radius) /\n              Math.log(10)\n          )\n        );\n        \n\n        range_limit = domain_limit * (this.radius / this._extents[1][1]);\n\n        if (range_limit < 30) {\n          let stretch = Math.ceil(30 / range_limit);\n          range_limit *= stretch;\n          domain_limit *= stretch;\n        }\n      } else {\n        domain_limit = this._extents[1][1];\n\n        range_limit =\n          this.size[1] - this.offsets[1] - this.options[\"left-offset\"] - this.shown_font_size;\n     }\n\n      let scale = d3\n          .scaleLinear()\n          .domain([0, domain_limit])\n          .range([0, range_limit]),\n         \n          scaleTickFormatter = d3.format(\".2f\");\n\n      this.draw_scale_bar = d3\n        .axisTop()\n        .scale(scale)\n        .tickFormat(function(d) {\n          if (d === 0) {\n            return \"\";\n          }\n          return scaleTickFormatter(d);\n        });\n\n      if (this.radial()) {\n        this.draw_scale_bar.tickValues([domain_limit]);\n      } else {\n        let round = function(x, n) {\n          return n ? Math.round(x * (n = Math.pow(10, n))) / n : Math.round(x);\n        };\n\n        let my_ticks = scale.ticks();\n        my_ticks = my_ticks.length > 1 ? my_ticks[1] : my_ticks[0];\n\n        this.draw_scale_bar.ticks(\n          Math.min(\n            10,\n            round(\n              range_limit /\n                (this.shown_font_size *\n                  scaleTickFormatter(my_ticks).length *\n                  2),\n              0\n            )\n          )\n        );\n      }\n    } else {\n      this.draw_scale_bar = null;\n    }\n\n    return this;\n  }\n\n  /**\n   * Get or set spacing in the x-direction.\n   *\n   * @param {Number} attr (Optional), the new spacing value if setting.\n   * @param {Boolean} skip_render (Optional), whether or not a refresh should be performed.\n   * @returns The current ``spacing_x`` value if getting, or the current ``phylotree`` if setting.\n   */\n  spacing_x(attr, skip_render) {\n    if (!arguments.length) return this.fixed_width[0];\n\n    if (\n      this.fixed_width[0] != attr &&\n      attr >= this.options[\"minimum-per-node-spacing\"] &&\n      attr <= this.options[\"maximum-per-node-spacing\"]\n    ) {\n      this.fixed_width[0] = attr;\n      if (!skip_render) {\n        this.placenodes();\n      }\n    }\n\n    return this;\n  }\n\n  /**\n   * Get or set spacing in the y-direction.\n   *\n   * @param {Number} attr (Optional), the new spacing value if setting.\n   * @param {Boolean} skip_render (Optional), whether or not a refresh should be performed.\n   * @returns The current ``spacing_y`` value if getting, or the current ``phylotree`` if setting.\n   */\n  spacing_y(attr, skip_render) {\n    if (!arguments.length) return this.fixed_width[1];\n\n    if (\n      this.fixed_width[1] != attr &&\n      attr >= this.options[\"minimum-per-level-spacing\"] &&\n      attr <= this.options[\"maximum-per-level-spacing\"]\n    ) {\n      this.fixed_width[1] = attr;\n      if (!skip_render) {\n        this.placenodes();\n      }\n    }\n    return this;\n  }\n\n  _label_width(_font_size) {\n    _font_size = _font_size || this.shown_font_size;\n    let width = 0;\n\n    this.phylotree.nodes\n      .descendants()\n      .filter(render_nodes.nodeVisible)\n      .forEach(node => {\n        let node_width = 12 + this._nodeLabel(node).length * _font_size * 0.8;\n\n        if (node.angle !== null) {\n          node_width *= Math.max(\n            Math.abs(Math.cos(node.angle)),\n            Math.abs(Math.sin(node.angle))\n          );\n        }\n        width = Math.max(node_width, width);\n      });\n\n    return width;\n  }\n\n  /**\n   * Get or set font size.\n   *\n   * @param {Function} attr Empty if getting, or new font size if setting.\n   * @returns The current ``font_size`` accessor if getting, or the current ``phylotree`` if setting.\n   */\n  font_size(attr) {\n    if (!arguments.length) return this.font_size;\n    this.font_size = attr === undefined ? 12 : attr;\n    return this;\n  }\n\n  scale_bar_font_size(attr) {\n    if (!arguments.length) return this.scale_bar_font_size;\n    this.scale_bar_font_size = attr === undefined ? 12 : attr;\n    return this;\n  }\n\n  node_circle_size(attr, attr2) {\n    if (!arguments.length) return this.options[\"node_circle_size\"];\n    this.options[\"node_circle_size\"] = constant(attr === undefined ? 3 : attr);\n    return this;\n  }\n\n  css(opt) {\n    if (arguments.length === 0) return this.css_classes;\n\n    if (arguments.length > 2) {\n      var arg = {};\n      arg[opt[0]] = opt[1];\n      return this.css(arg);\n    }\n\n    for (var key in css_classes) {\n      if (key in opt && opt[key] != css_classes[key]) {\n        css_classes[key] = opt[key];\n      }\n    }\n\n    return this;\n  }\n\n  transitions(arg) {\n    if (arg !== undefined) {\n      return arg;\n    }\n\n    if (this.options[\"transitions\"] !== null) {\n      return this.options[\"transitions\"];\n    }\n\n    return this.phylotree.nodes.descendants().length <= 300;\n  }\n\n  /**\n   * Get or set CSS classes.\n   *\n   * @param {Object} opt Keys are the CSS class to toggle and values are\n   * the parameters for that CSS class.\n   * @param {Boolean} run_update (optional) Whether or not the tree should update.\n   * @returns The current ``phylotree``.\n   */\n  css_classes(opt, run_update) {\n    if (!arguments.length) return this.css_classes;\n\n    let do_update = false;\n\n    for (var key in css_classes) {\n      if (key in opt && opt[key] != this.css_classes[key]) {\n        do_update = true;\n        this.css_classes[key] = opt[key];\n      }\n    }\n\n    if (run_update && do_update) {\n      this.layout();\n    }\n\n    return this;\n  }\n\n  /**\n   * Lay out the tree within the SVG.\n   *\n   * @param {Boolean} transitions Specify whether or not transitions should occur.\n   * @returns The current ``phylotree``.\n   */\n  layout(transitions) {\n    if (this.svg) {\n      this.svg.selectAll(\n        \".\" +\n          this.css_classes[\"tree-container\"] +\n          \",.\" +\n          this.css_classes[\"tree-scale-bar\"] +\n          \",.\" +\n          this.css_classes[\"tree-selection-brush\"]\n      );\n\n      //.remove();\n      this.d3PhylotreeTriggerLayout(this);\n      return this.update();\n    }\n\n    this.d3PhylotreeTriggerLayout(this);\n    return this;\n  }\n\n  handle_node_click(node) {\n    this.nodeDropdownMenu(node, this.container, this, this.options);\n  }\n\n  refresh() {\n    if (this.svg) {\n      // for re-entrancy\n      let enclosure = this.svg.selectAll(\n        \".\" + this.css_classes[\"tree-container\"]\n      );\n\n      let edges = enclosure\n        .selectAll(render_edges.edgeCssSelectors(this.css_classes))\n        .attr(\"class\", this.reclassEdge.bind(this));\n\n      if (this.edge_styler) {\n        edges.each(d => {\n          this.edge_styler(d3.select(this), d);\n        });\n      }\n\n      //let nodes = this.enclosure\n      //  .selectAll(inspector.nodeCssSelectors(this.css_classes))\n      //  .attr(\"class\", this.phylotree.reclassNode);\n\n      //if (this.node_styler) {\n      //  nodes.each(function(d) {\n      //    this.node_styler(d3.select(this), d);\n      //  });\n      //}\n    }\n\n    return this;\n  }\n\n  countHandler(attr) {\n    if (!arguments.length) return this.count_listener_handler;\n    this.count_listener_handler = attr;\n    return this;\n  }\n\n  /**\n   * Get or set node styler. If setting, pass a function of two arguments,\n   * ``element`` and ``data``. ``data`` exposes the underlying node so that\n   * its attributes can be referenced. These can be used to apply styles to\n   * ``element``, which will be a D3 selection corresponding to the SVG element\n   * that makes up the current node.\n   * ``transition`` is the third argument which indicates that there is an ongoing\n   * d3 transition in progress\n   *\n   * @param {Function} attr - Optional; if setting, the node styler function to be set.\n   * @returns The ``node_styler`` function if getting, or the current ``phylotree`` if setting.\n   */\n  style_nodes(attr) {\n    if (!arguments.length) return this.node_styler;\n    this.node_styler = attr;\n    return this;\n  }\n\n  /**\n   * Get or set edge styler. If setting, pass a function of two arguments,\n   * ``element`` and ``data``. ``data`` exposes the underlying edge so that\n   * its attributes can be referenced. These can be used to apply styles to\n   * ``element``, which will be a D3 selection corresponding to the SVG element\n   * that makes up the current edge.\n   *\n   * Note that, in accordance with the D3 hierarchy layout, edges will have\n   * a ``source`` and ``target`` field, corresponding to the nodes that make up\n   * up the associated branch.\n   *\n   * @param {Function} attr - Optional; if setting, the node styler function to be set.\n   * @returns The ``edge_styler`` function if getting, or the current ``phylotree`` if setting.\n   */\n  style_edges(attr) {\n    if (!arguments.length) return this.edge_styler;\n    this.edge_styler = attr.bind(this);\n    return this;\n  }\n\n  itemSelected(item, tag) {\n    return item[tag] || false;\n  }\n\n  show() {\n    return this.svg.node()\n  }\n\n}\n\n_.extend(TreeRender.prototype, clades);\n_.extend(TreeRender.prototype, render_nodes);\n_.extend(TreeRender.prototype, render_edges);\n_.extend(TreeRender.prototype, events);\n_.extend(TreeRender.prototype, menus);\n_.extend(TreeRender.prototype, opt);\n\nexport default TreeRender;\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\nimport { default as parser_registry } from \"./formats/registry\";\nimport { default as newickParser, getNewick } from \"./formats/newick\";\nimport { default as getTipLengths } from \"./export\";\nimport * as nexus from \"./formats/nexus\";\nimport { default as phyloxml_parser } from \"./formats/phyloxml\";\nimport { default as maxParsimony } from \"./max-parsimony\";\nimport { leftChildRightSibling, postOrder, preOrder, default as inOrder } from \"./traversal\";\n\nimport {\n  default as hasBranchLengths,\n  getBranchLengths,\n  defBranchLengthAccessor,\n  setBranchLength,\n  branchName,\n  normalize,\n  scale\n} from \"./branches\";\n\nimport * as node_operations from \"./nodes\";\nimport * as rooting from \"./rooting\";\nimport { default as TreeRender } from \"./render/draw\";\n\nfunction resortChildren(comparator, start_node, filter) {\n  // ascending\n  this.nodes\n    .sum(function(d) {\n      return d.value;\n    })\n    .sort(comparator);\n\n  // if a tree is rendered in the DOM\n  if (this.display) {\n    this.display.update_layout(this.nodes);\n    this.display.update();\n  }\n\n  return this;\n}\n\n/**\n * Return most recent common ancestor of a pair of nodes.\n * @returns An array of strings, comprising each tag that was read.\n */\nfunction mrca() {\n\n  var mrca_nodes, mrca;\n\n  if (arguments.length == 1) {\n    mrca_nodes = arguments[0];\n  } else {\n    mrca_nodes = Array.from(arguments);\n  }\n\n  mrca_nodes = mrca_nodes.map(function(mrca_node) {\n    return typeof mrca_node == \"string\" ? mrca_node : mrca_node.name;\n  });\n\n  this.traverse_and_compute(function(node) {\n    if (!node.children) {\n      node.mrca = _.intersection([node.name], mrca_nodes);\n    } else if (!node.parent) {\n      if (!mrca) {\n        mrca = node;\n      }\n    } else {\n      node.mrca = _.union(...node.descendants().map(child => child.mrca));\n      if (!mrca && node.mrca.length == mrca_nodes.length) {\n        mrca = node;\n      }\n    }\n  });\n\n  return mrca;\n\n}\n\n/**\n * An instance of a phylotree. Sets event listeners, parses tags, and creates links\n * that represent branches.\n *\n * @param {Object} nwk - A Newick string, PhyloXML string, or hierarchical JSON representation of a phylogenetic tree.\n * @param {Object} options\n * - boostrap_values\n * - type - format type\n * @returns {Phylotree} phylotree - itself, following the builder pattern.\n */\nlet Phylotree = class {\n\n  constructor(nwk, options = {}) {\n\n    this.newick_string = \"\";\n\n    this.nodes = [];\n    this.links = [];\n    this.parsed_tags = [];\n    this.partitions = [];\n    this.branch_length_accessor = defBranchLengthAccessor;\n    this.branch_length = defBranchLengthAccessor;\n    this.logger = options.logger || console;\n    this.selection_attribute_name = \"selected\";\n\n    // initialization\n    var type = options.type || undefined,\n      _node_data = [],\n      self = this;\n\n    // If the type is a string, check the parser_registry\n    if (_.isString(type)) {\n      if (type in parser_registry) {\n        _node_data = parser_registry[type](nwk, options);\n      } else {\n        // Hard failure\n        self.logger.error(\n          \"type \" +\n            type +\n            \" not in registry! Available types are \" +\n            _.keys(parser_registry)\n        );\n      }\n    } else if (_.isFunction(type)) {\n      // If the type is a function, try executing the function\n      try {\n        _node_data = type(nwk, options);\n      } catch (e) {\n        // Hard failure\n        self.logger.error(\"Could not parse custom format!\");\n      }\n    } else {\n      // this builds children and links;\n      if (nwk.name == \"root\") {\n        // already parsed by phylotree.js\n        _node_data = { json: nwk, error: null };\n      } else if (typeof nwk != \"string\") {\n        // old default\n        _node_data = nwk;\n      } else if (nwk.contentType == \"application/xml\") {\n        // xml\n        _node_data = phyloxml_parser(nwk);\n      } else {\n        // newick string\n        this.newick_string = nwk;\n        _node_data = newickParser(nwk, options);\n      }\n\n    }\n\n    if (!_node_data[\"json\"]) {\n\n      self.nodes = [];\n\n    } else {\n\n      self.nodes = d3.hierarchy(_node_data.json);\n\n      // Parse tags\n      let _parsed_tags = {};\n\n      self.nodes.each(node => {\n        if (node.data.annotation) {\n          _parsed_tags[node.data.annotation] = true;\n        }\n      });\n\n      self.parsed_tags = Object.keys(_parsed_tags);\n\n    }\n\n    self.links = self.nodes.links();\n\n    // If no branch lengths are supplied, set all to 1\n    if(!this.hasBranchLengths()) {\n      console.warn(\"Phylotree User Warning : NO BRANCH LENGTHS DETECTED, SETTING ALL LENGTHS TO 1\");\n      this.setBranchLength(x => 1)\n    }\n\n    return self;\n\n  }\n\n  /*\n    Export the nodes of the tree with all local keys to JSON\n    The return will be an array of nodes in the specified traversal_type\n    ('post-order' : default, 'pre-order', or 'in-order')\n    with parents and children referring to indices in that array\n\n  */\n  json(traversal_type) {\n\n    var index = 0;\n\n    this.traverse_and_compute(function(n) {\n      n.json_export_index = index++;\n    }, traversal_type);\n\n    var node_array = new Array(index);\n\n    index = 0;\n\n    this.traverse_and_compute(function(n) {\n      let node_copy = _.clone(n);\n      delete node_copy.json_export_index;\n\n      if (n.parent) {\n        node_copy.parent = n.parent.json_export_index;\n      }\n\n      if (n.children) {\n        node_copy.children = _.map(n.children, function(c) {\n          return c.json_export_index;\n        });\n      }\n      node_array[index++] = node_copy;\n    }, traversal_type);\n\n    this.traverse_and_compute(function(n) {\n      delete n.json_export_index;\n    }, traversal_type);\n\n    return JSON.stringify(node_array);\n  }\n\n  /*\n   * Traverse the tree in a prescribed order, and compute a value at each node.\n   *\n   * @param {Function} callback A function to be called on each node.\n   * @param {String} traversal_type Either ``\"pre-order\"`` or ``\"post-order\"`` or ``\"in-order\"``.\n   * @param {Node} root_node start traversal here, if provided, otherwise start at root\n   * @param {Function} backtrack ; if provided, then at each node n, backtrack (n) will be called,\n                                   and if it returns TRUE, traversal will NOT continue past into this\n                                   node and its children\n   */\n  traverse_and_compute(callback, traversal_type, root_node, backtrack) {\n    traversal_type = traversal_type || \"post-order\";\n\n    function post_order(node) {\n      if (_.isUndefined(node)) {\n        return;\n      }\n\n      postOrder(node, callback, backtrack);\n\n    }\n\n    function pre_order(node) {\n      preOrder(node, callback, backtrack);\n    }\n\n    function in_order(node) {\n      inOrder(node, callback, backtrack);\n    }\n\n    if (traversal_type == \"pre-order\") {\n      traversal_type = pre_order;\n    } else {\n      if (traversal_type == \"in-order\") {\n        traversal_type = in_order;\n      } else {\n        traversal_type = post_order;\n      }\n    }\n\n    traversal_type(root_node ? root_node : this.nodes);\n\n    return this;\n\n  }\n\n  get_parsed_tags() {\n    return this.parsed_tags;\n  }\n\n  update(json) {\n    // update with new hiearchy layout\n    this.nodes = json;\n  }\n\n  // Warning : Requires DOM!\n  render(options) {\n    this.display = new TreeRender(this, options);\n    return this.display;\n  }\n\n};\n\nPhylotree.prototype.isLeafNode = node_operations.isLeafNode;\nPhylotree.prototype.mrca = mrca;\nPhylotree.prototype.hasBranchLengths = hasBranchLengths;\nPhylotree.prototype.getBranchLengths = getBranchLengths;\nPhylotree.prototype.branchName = branchName;\nPhylotree.prototype.normalizeBranchLengths = normalize;\nPhylotree.prototype.scaleBranchLengths = scale;\nPhylotree.prototype.getNewick = getNewick;\nPhylotree.prototype.resortChildren = resortChildren;\nPhylotree.prototype.setBranchLength = setBranchLength;\nPhylotree.prototype.maxParsimony = maxParsimony;\n\nPhylotree.prototype.getTipLengths = getTipLengths;\nPhylotree.prototype.leftChildRightSibling = leftChildRightSibling;\n\n_.extend(Phylotree.prototype, node_operations);\n_.extend(Phylotree.prototype, rooting);\n_.extend(Phylotree.prototype, nexus);\n\nexport function itemTagged(item) {\n  return item.tag || false;\n}\n\nexport default Phylotree;\n","import * as _ from \"underscore\";\n\n/*\n *  given a tree, this function will compute quantities required to work with \n *  all v all pairwise distances (like in COT) \n *\n *  @param   tree the tree object\n *  @returns leaf count\n *\n */\nfunction computePairwiseDistances(tree) {\n  /*\n   *    traverse the tree and populate the following values in each node\n   *        \n   *        .cot_computed_length -> for each node (except the root), the current branch length \n   *                                (so as to not compute them each time via a callback) \n   *        .cot_leaf_index      -> post_order traversal order of a leaf (0 to number of leaves - 1)\n   *        \n   *        for each node\n   *        \n   *        .cot_path_to_leaves_below   \n   *                             -> a dictionary that maps a leaf index to the total path length from this node\n   *                                to each of the descendant leaves, EXCLUDING the length of this branch\n   *\n   *        .cot_path_to_leaves_above   \n   *                             -> a dictionary that maps a leaf index to the total path length from this node\n   *                                to each of the leaves outside the split defined by this node, EXCLUDING\n   *                                the length of this branch\n   */\n\n  var bl = tree.branch_length_accessor;\n\n  if (!bl) {\n    throw \"A non-null branch lengths accessor function is required for this operation\";\n  }\n\n  var leaf_count = 0;\n\n  tree.traverse_and_compute(function(n) {\n    n.cot_computed_length = bl(n);\n\n \n    if (n.parent && _.isUndefined(n.cot_computed_length)) {\n      throw \"Non-null branch lengths are required for this operation: missing branch length at node \" + n.data.name;\n    }\n\n    if (tree.isLeafNode(n)) {\n      n.cot_leaf_index = leaf_count++;\n      n.cot_path_to_leaves_below = {};\n      n.cot_path_to_leaves_below[n.cot_leaf_index] = 0;\n      n.cot_path_to_leaves_above = {};\n    } else {\n      n.cot_path_to_leaves_below = {};\n      n.cot_path_to_leaves_above = {};\n    }\n  });\n\n  // populate all cot_path_to_leaves_below\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      _.each(n.cot_path_to_leaves_below, function(length_so_far, leaf_index) {\n        n.parent.cot_path_to_leaves_below[leaf_index] =\n          length_so_far + n.cot_computed_length;\n      });\n    }\n  });\n\n  // populate all cot_path_to_leaves_above; this is done via a 'pre-order' traversal\n  // handle root node first\n  var root_node = tree.getRootNode();\n\n  function CopyFromSiblings(a_node) {\n    for (var this_node = 0; this_node < a_node.children.length; this_node++) {\n      for (\n        var other_node = 0;\n        other_node < a_node.children.length;\n        other_node++\n      ) {\n        if (this_node != other_node) {\n          _.each(a_node.children[other_node].cot_path_to_leaves_below, function(\n            length,\n            index\n          ) {\n            if (a_node.children[this_node].cot_path_to_leaves_above) {\n              a_node.children[this_node].cot_path_to_leaves_above[index] =\n                length + a_node.children[other_node].cot_computed_length;\n            }\n          });\n        }\n      }\n    }\n  }\n\n  CopyFromSiblings(root_node);\n\n  // takes two passes\n\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      // copy parent's 'above' nodes\n      _.each(n.parent.cot_path_to_leaves_above, function(\n        length_so_far,\n        leaf_index\n      ) {\n        n.cot_path_to_leaves_above[leaf_index] =\n          length_so_far + n.parent.cot_computed_length;\n      });\n\n      if (!tree.isLeafNode(n)) {\n        CopyFromSiblings(n);\n      }\n      // copy sibling's 'below' nodes\n    }\n  }, \"pre-order\");\n\n  return leaf_count;\n}\n\nexport default computePairwiseDistances;\n","import * as _ from \"underscore\";\n\nfunction annotateCopyNumber(tree) {\n  tree.traverse_and_compute(function(node) {\n    if (tree.isLeafNode(node)) {\n      node.data.copy_number = 1;\n    }\n  });\n}\n\n// internal function used by best root fitting\nfunction computeRootToTipOtherRoot(\n  tree,\n  node,\n  coming_from,\n  shared_distance,\n  distance_to_new_root\n) {\n\n  var my_bl = tree.branch_length(node);\n\n  var go_up = false;\n\n  if (!coming_from) {\n    shared_distance = node.data.rootToTip;\n    distance_to_new_root = 0;\n    go_up = true;\n  }\n\n  if (node.children) {\n    for (var c = 0; c < node.children.length; c++) {\n      if (node.children[c] != coming_from) {\n        computeRootToTipOtherRoot(\n          tree,\n          node.children[c],\n          node,\n          shared_distance,\n          distance_to_new_root\n        );\n      } else {\n        go_up = true;\n      }\n    }\n  }\n\n  node.data.rtta = node.data.rootToTip - shared_distance + distance_to_new_root;\n\n  if (go_up) {\n    shared_distance -= my_bl;\n    distance_to_new_root += my_bl;\n  }\n\n  if (node.parent && go_up) {\n    computeRootToTipOtherRoot(\n      tree,\n      node.parent,\n      node,\n      shared_distance,\n      distance_to_new_root\n    );\n  }\n}\n\nexport function fitRootToTip(tree) {\n\n  var linear_data = [],\n    max_r2 = 0,\n    best_node = 0;\n\n  annotateCopyNumber(tree);\n  rootToTip(tree);\n\n  // To return if best node is the root already\n  tree.traverse_and_compute(function(node) {\n    if (tree.isLeafNode(node) && !_.isNull(node.data.decimal_date_value)) {\n      linear_data.push([node.data.decimal_date_value, node.data.rtta, node.data.copy_number]);\n    }\n  });\n\n  let best_fit = linearFit(linear_data);\n\n  tree.traverse_and_compute(function(node) {\n\n    if (tree.isLeafNode(node) && !_.isNull(node.data.decimal_date_value)) {\n\n      computeRootToTipOtherRoot(tree, node, null, 0, 0);\n\n      linear_data = [];\n\n      tree.traverse_and_compute(function(node) {\n        if (tree.isLeafNode(node) && !_.isNull(node.data.decimal_date_value)) {\n          linear_data.push([\n            node.data.decimal_date_value,\n            node.data.rtta,\n            node.data.copy_number\n          ]);\n        }\n      });\n\n      var fit = linearFit(linear_data),\n        r2 = fit[\"r2\"];\n\n      if (r2 > max_r2) {\n        max_r2 = r2;\n        best_node = node;\n        best_fit = fit;\n      }\n\n    }\n  });\n\n  return { root: best_node, fit: best_fit };\n\n}\n\n// linear fit of root to tip distances\nfunction linearFit(data) {\n\n  var ss = data.reduce(function(p, c) {\n      return c[2] + p;\n    }, 0), // sample count\n    sx = data.reduce(function(p, c) {\n      return c[2] * c[0] + p;\n    }, 0), // sum X\n    sy = data.reduce(function(p, c) {\n      return c[2] * c[1] + p;\n    }, 0), // sum Y\n    sxoss = sx / ss,\n    syoss = sy / ss;\n\n  var fitB = 0,\n    st2 = 0,\n    vary = 0;\n\n  data.forEach(function(point) {\n    var t = point[0] - sxoss;\n    st2 += point[2] * t * t;\n    fitB += point[2] * t * point[1];\n    vary += point[2] * (point[1] - syoss) * (point[1] - syoss);\n  });\n\n  fitB /= st2;\n\n  var a = (sy - sx * fitB) / ss;\n\n  var varres = 0;\n\n  data.forEach(function(point) {\n    var t = point[1] - a - fitB * point[0];\n    varres += point[2] * t * t;\n  });\n\n  return {\n    intercept: a,\n    slope: fitB,\n    r2: 1 - varres / vary,\n    \"var (intercept)\": Math.sqrt((1 + sx * sx / (ss * st2)) / ss),\n    \"var (slope)\": Math.sqrt(1 / st2)\n  };\n}\n\n/**\n *   fast and memory efficient root to tip distance calculator\n *   for each leaf node stores the current root to tip distance in \n *   the node.rootToTip field\n *   \n *   @param tree\n *   @return tree with rootToTip computed\n *\n */\nexport default function rootToTip(tree) {\n\n  var bl = tree.branch_length_accessor,\n    index = 0;\n\n  tree.traverse_and_compute(n => {\n    if (n.parent) {\n      n.data._computed_length = bl(n);\n      if (!_.isNumber(n.data._computed_length)) {\n        throw \"rootToTip cannot be run on trees with missing branch lengths\";\n      }\n    }\n    if (tree.isLeafNode(n)) {\n      n.data.leaf_index = index++;\n    }\n    if (\"r2t\" in n.data) {\n      delete n.data.r2t;\n    }\n  });\n\n  tree.traverse_and_compute(n => {\n    if (n.parent) {\n      if (!(\"r2t\" in n.parent.data)) {\n        n.parent.data.r2t = {};\n      }\n      if (tree.isLeafNode(n)) {\n        n.parent.data.r2t[n.data.leaf_index] = n.data._computed_length;\n      } else {\n        _.each(n.data.r2t, function(v, idx) {\n          n.parent.data.r2t[idx] = v + n.data._computed_length;\n        });\n        delete n.data.r2t;\n      }\n      delete n.data._computed_length;\n    }\n  });\n\n  var r2t = tree.getRootNode().data.r2t;\n\n  tree.traverse_and_compute(n => {\n    if (tree.isLeafNode(n)) {\n      n.data.rootToTip = r2t[n.data.leaf_index] || 0;\n      delete n.data.leaf_index;\n    }\n  });\n\n  delete tree.getRootNode().data.r2t;\n\n  return tree;\n}\n","import * as _ from \"underscore\";\nimport { isLeafNode } from \"./nodes\";\n\nexport default function maxParsimony(respect_existing, attr_name) {\n\n  function populateMpMatrix(attr_name, d) {\n\n    d.mp = [\n      [0, 0], // score for parent selected / not selected\n      [false, false]\n    ]; // selected or not\n\n    if (isLeafNode(d)) {\n\n      d.mp[1][0] = d.mp[1][1] = d[attr_name] || false;\n      d.mp[0][0] = d.mp[1][0] ? 1 : 0;\n      d.mp[0][1] = 1 - d.mp[0][0];\n\n    } else {\n\n      d.children.forEach(pop_mp_mat);\n\n      var s0 = d.children.reduce(function(p, n) {\n        return n.mp[0][0] + p;\n      }, 0);\n\n      // cumulative children score if this node is 0\n      var s1 = d.children.reduce(function(p, n) {\n        return n.mp[0][1] + p;\n      }, 0);\n\n      // cumulative children score if this node is 1\n      // parent = 0\n\n      if (d[attr_name]) {\n        // respect selected\n        d.mp[0][0] = s1 + 1;\n        d.mp[1][0] = true;\n        d.mp[0][1] = s1;\n        d.mp[1][1] = true;\n      } else {\n        if (s0 < s1 + 1) {\n          d.mp[0][0] = s0;\n          d.mp[1][0] = false;\n        } else {\n          d.mp[0][0] = s1 + 1;\n          d.mp[1][0] = true;\n        }\n\n        // parent = 1\n\n        if (s1 < s0 + 1) {\n          d.mp[0][1] = s1;\n          d.mp[1][1] = true;\n        } else {\n          d.mp[0][1] = s0 + 1;\n          d.mp[1][1] = false;\n        }\n      }\n    }\n  }\n\n  const pop_mp_mat = _.partial(populateMpMatrix, attr_name);\n  pop_mp_mat(this.nodes);\n\n  this.nodes.each(d => {\n    if (d.parent) {\n      d.mp = d.mp[1][d.parent.mp ? 1 : 0];\n    } else {\n      d.mp = d.mp[1][d.mp[0][0] < d.mp[0][1] ? 0 : 1];\n    }\n  });\n\n  this.display.modifySelection((d, callback) => {\n    if (isLeafNode(d.target)) {\n      return d.target[attr_name];\n    }\n    return d.target.mp;\n  });\n\n}\n","import * as _ from \"underscore\";\n\n/**\n * Return CSV of nodes sorted by longest branches.\n *\n * @returns {Array} An array of all tips and associated lengths of the form :\n * [{\n *    name : <tip_name>,\n *    length: <tip_length>\n * }, ...]\n */\n\nexport default function getTipLengths() {\n\n  // Get nodes and branch lengths\n  let self = this;\n  let tips = self.getTips();\n\n  // Transform to name, attribute key-pair and sort by attribute length, descending\n  let toExport = _.map(tips, d => { return {'name' : d.data.name, 'length' : parseFloat(d.data.attribute) } });\n  toExport = _.sortBy(toExport, d=> -d.length)\n  return toExport;\n  \n  \n}\n","import * as d3 from \"d3\";\n\nconst default_date_converter = d3.timeParse(\"%Y%m%d\");\n\nconst default_regexp = /([0-9]{4}).?([0-9]{2}).?([0-9]{2})$/g;\n\nconst default_date_getter = function(node) {\n  if (d3.layout.phylotree.isLeafNode(node)) {\n    if (\"name\" in node) {\n      var location = default_regexp.exec(node.name);\n      if (location) {\n        return location[1] + location[2] + location[3];\n      }\n    }\n  }\n  return null;\n};\n\n/*\n *  Extracts dates from nodes using a provided callback (defaults supplied),\n *  and also converts them to decimal dates; missing dates are allowed; if desired, missing dates \n *  can throw exceptions \n *  \n *  @param tree             : the tree object \n *\n *  @param date_getter      : a function that extracts date strings from nodes (e.g. by parsing the name),\n *                            default is to extract from the end of the node name, using [YYYY] optional sep [MM] optional sep [DD] format;\n *                            default is implemented in phylotree_extensions.extract_dates.date_getter ()\n *                            \n *  @param date_converter   : if provided, will be used to parse the date string; default is %Y%m%d implemented in \n *                            phylotree_extensions.extract_dates.date_converter\n *  \n *  \n *  @return tree with date-annotated nodes, i.e. each node will have\n *  \n *      n.date_value (date object, e.g. 2018-08-17); null for missing\n *      n.decimal_date_value (decimal object, e.g. 2018.72)\n *  \n */\nconst extract_dates = function(tree, date_getter, date_converter=default_date_converter) {\n\n  date_getter = date_getter || default_date_getter;\n  \n  tree.traverse_and_compute(function(n) {\n    var d_string = date_getter(n);\n    if (d_string) {\n      try {\n        n.data.date_value = date_converter(d_string);\n        var full_year = n.data.date_value.getFullYear();\n        var year_start = new Date(full_year, 0, 1),\n          year_start_p1 = new Date(full_year + 1, 0, 1);\n\n        n.data.decimal_date_value =\n          full_year +\n          (n.data.date_value - year_start) / (year_start_p1 - year_start);\n        return;\n      } catch (e) {\n        // for conversion failures\n      }\n    }\n    n.data.date_value = null;\n    n.data.decimal_date_value = null;\n  });\n\n  return tree;\n};\n\nexport default extract_dates;\n","import * as _ from \"underscore\";\n\n/*\n *special case for L^2\n *\n *For a fixed branch B, we have one parameter : where to break the branch `t` in [0, T], \n *where T is the branch length\n *\n *D   = sum (a is a leaf above B) [d(B,a) + (T-t)] ^ 2 +\n *      sum (b is a leaf below B) [d(B,b) + t] ^ 2;\n *      \n *expanding, we have \n *\n *D   = sum (a is a leaf above B) [d^2 (B,a) + 2(T-t) d(B,a) + (T-t)^2]\n *      sum (b is a leaf below B) [d^2 (B,b) + 2(t) d(B,b) + t^2]\n *      \n *    = (sum distances above)^2 + sum (distances above)*2(T-t) + (T-t)^2 * # leaves_above\n *      (sum distances below)^2 + sum (distances below)*2*t    + t^2 * # leaves_below\n *\n *      \n *Taking a derivative with respect to t we have\n *\n *dD / dt = - 2 sum (a is a leaf above B) [d(B,a) + (T-t)]\n *          + 2 sum (b is a leaf below B) [d(B,b) + t]\n *          \n *\n *second derivative is positive the function is convex, so can set to the nearest boundary if solution is outside range\n *\n *setting dD / dt to zero, we have \n *\n *- sum (distances leaves above) - T * (#leaves above) + t * (#leaves above) + sum (distances leaves below) + t * (#leaves below) = 0\n *\n *t = [sum (distances leaves above) - sum (distances leaves below) + T * (#leaves above)] / (#leaves)\n */\n\nimport { default as pairwise_distances } from \"./pairwise-distances\";\n\nexport function centerOfTree(tree, power) {\n  power = power || 2;\n\n  var leaf_count = pairwise_distances(tree);\n\n  var current_min = Number.MAX_VALUE,\n    current_split = 0,\n    current_location = null;\n\n  if (power == 2) {\n    tree.traverse_and_compute(function(n) {\n      if (n.parent) {\n        // can't consider the root\n        var sum_below = 0,\n          sum_below_squared = 0,\n          sum_above = 0,\n          sum_above_squared = 0;\n\n        var count_below = 0;\n\n        _.each(n.cot_path_to_leaves_below, function(l) {\n          sum_below += l;\n          sum_below_squared += l * l;\n          count_below++;\n        });\n\n        _.each(n.cot_path_to_leaves_above, function(l) {\n          sum_above += l;\n          sum_above_squared += l * l;\n        });\n\n        var count_above = leaf_count - count_below;\n\n        var tt =\n          (sum_above - sum_below + n.cot_computed_length * count_above) /\n          leaf_count;\n        if (tt < 0) {\n          tt = 0;\n        } else if (tt > n.cot_computed_length) {\n          tt = n.cot_computed_length;\n        }\n\n        var score =\n          sum_above_squared +\n          sum_below_squared +\n          2 * (sum_above * (n.cot_computed_length - tt) + sum_below * tt) +\n          count_below * tt * tt +\n          (n.cot_computed_length - tt) *\n            (n.cot_computed_length - tt) *\n            count_above;\n\n        if (score < current_min) {\n          current_location = n;\n          current_split = tt / n.cot_computed_length; //n.cot_computed_length-tt;//1 - tt / n.cot_computed_length;\n          current_min = score;\n        }\n\n        delete n.cot_computed_length;\n        delete n.cot_path_to_leaves_below;\n        delete n.cot_path_to_leaves_above;\n        delete n.cot_leaf_index;\n      }\n    });\n  } else {\n    // in the general case try a simple grid optimization\n    tree.traverse_and_compute(function(n) {\n      if (n.parent) {\n        // can't consider the root\n\n        var optimization_step =\n            n.cot_computed_length > 0.0 ? n.cot_computed_length * 0.05 : 0.1,\n          current_t = 0;\n\n        while (current_t < n.cot_computed_length) {\n          var score = 0.0;\n\n          _.each(n.cot_path_to_leaves_below, function(l) {\n            score += Math.pow(l + current_t, power);\n          });\n\n          _.each(n.cot_path_to_leaves_above, function(l) {\n            score += Math.pow(l + (n.cot_computed_length - current_t), power);\n          });\n\n          if (score < current_min) {\n            current_location = n;\n            current_split = current_t / n.cot_computed_length; //n.cot_computed_length-tt;//1 - tt / n.cot_computed_length;\n            current_min = score;\n          }\n          current_t += optimization_step;\n        }\n      }\n    });\n  }\n\n  return {\n    location: current_location,\n    breakpoint: current_split,\n    distance: current_min\n  };\n}\n","import * as _ from \"underscore\";\n\n/**\n * Implements a linear time / space version of the Cluster picker algorithm\n * \n * @param tree -- the tree object \n * @param bootstrap_thresold -- value in [0,1] that sets the stringency of bootstrap support\n * @param diameter_threshold -- value >=0 that defines the maximum allowable pairwise distance in a cluster\n * @param root_node -- if specified, traverse the tree starting here (useful for only looking at parts of the tree),\n * tree root by default\n * @param missing_bootstrap_value -- if a branch is missing bootstrap support value, use this value instead\n *                   (1.0 by default)\n *                                 \n * @return an array of clusters, where cluster = \n * \\{\n *    'root'   : [root node of cluster],\n *    'members' : [list of leaf. nodes],\n *    'diameter' : max distance in the cluster,\n *    'bootstrap' : bootstrap support at the root node\n * \\}                        \n */\nfunction clusterPicker(\n  tree,\n  bootstrap_threshold,\n  diameter_threshold,\n  root_node,\n  missing_bootstrap_value\n) {\n  root_node = root_node || tree.getRootNode();\n  missing_bootstrap_value = _.isNumber(missing_bootstrap_value)\n    ? missing_bootstrap_value\n    : 1;\n\n  // perform a bottom-up pass of the tree\n  // where each internal node will receive a floating point value\n  // that stores the longest path from the internal node to any of its descendants,\n  // the diameter of the cluster,  is then the sum of longest paths of all of its children\n  let bl = tree.branch_length;\n\n  // initialize member variables\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      n._computed_length = bl(n);\n      if (!_.isNumber(n._computed_length)) {\n        throw \"clusterPicker cannot be run on trees with missing branch lengths\";\n      }\n      n.max_path_length = 0;\n    }\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      n.parent.max_path_length = Math.max(\n        n.parent.max_path_length,\n        n.max_path_length + n._computed_length\n      );\n    }\n  });\n\n  var clusters = [];\n\n  tree.traverse_and_compute(_.noop, \"pre-order\", root_node, function(n) {\n    if (!tree.isLeafNode(n)) {\n      var bs = _.isString(n.data.bootstrap_values)\n        ? +n.data.bootstrap_values\n        : missing_bootstrap_value;\n\n      if (bs >= bootstrap_threshold) {\n        var my_diameter = _.reduce(\n          n.children,\n          function(c, n) {\n            return n.max_path_length + n._computed_length + c;\n          },\n          0\n        );\n\n        if (my_diameter <= diameter_threshold) {\n          clusters.push({ root: n, diameter: my_diameter, bootstrap: bs });\n          return true;\n        }\n      }\n    }\n\n    return false;\n  });\n\n  // clean up member variables\n  tree.traverse_and_compute(\n    function(n) {\n      if (n.parent) {\n        delete n._computed_length;\n        delete n.max_path_length;\n      }\n    },\n    \"post-order\",\n    root_node\n  );\n\n  _.each(clusters, function(cluster) {\n    cluster[\"members\"] = [];\n    tree.traverse_and_compute(\n      function(n) {\n        if (tree.isLeafNode(n)) {\n          cluster[\"members\"].push(n);\n        }\n      },\n      \"post-order\",\n      cluster[\"root\"]\n    );\n  });\n\n  return clusters;\n}\n\nexport default clusterPicker;\n","/**\n * Compute midpoint of a phylogenetic tree\n * \n * @param {Object} tree -- the phylotree.js tree object \n * @return {Object} the calculated midpoint to root on\n *  { location: root_node, breakpoint: 0 }\n *\n */\nexport function computeMidpoint(tree) {\n  if (!tree.hasBranchLengths()) {\n    throw \"Center of tree calculation cannot be performed on trees that do not have fully specified branch lengths\";\n  }\n\n  var bl = tree.branch_length;\n\n  tree.traverse_and_compute(function(node) {\n    if (node.parent) {\n      var my_longest_path_length = bl(node);\n      var my_longest_path_terminus;\n\n      if (tree.isLeafNode(node)) {\n        my_longest_path_terminus = node;\n        node.max_path = 0;\n        node.max_path_terminus = node;\n      } else {\n        my_longest_path_length += node.max_path;\n        my_longest_path_terminus = node.max_path_terminus;\n      }\n\n      if (\n        !node.parent.max_path ||\n        node.parent.max_path < my_longest_path_length\n      ) {\n        node.parent.max_path = my_longest_path_length;\n        node.parent.max_path_terminus = my_longest_path_terminus;\n      }\n    }\n  });\n\n  var root_node = tree.getRootNode();\n  var longest_path_length = 0;\n\n  root_node.children.forEach(function(root_child) {\n    if (root_child.max_path_terminus !== root_node.max_path_terminus) {\n      var pl = root_child.max_path + bl(root_child);\n      if (pl >= longest_path_length) {\n        longest_path_length = pl;\n      }\n    }\n  });\n\n  if (root_node.max_path > longest_path_length) {\n    // not already midpoint rooted\n    longest_path_length = (longest_path_length + root_node.max_path) * 0.5;\n\n    // start traversing up from the deepest leaf to the root, until we find the\n    // half-way point\n\n    var root_on = root_node.max_path_terminus;\n\n    while (true) {\n      var current_bl = bl(root_on);\n      //console.log (current_bl, longest_path_length);\n      if (current_bl <= longest_path_length) {\n        longest_path_length -= current_bl;\n        root_on = root_on.parent;\n      } else {\n        //console.log (\"Rooting on \", root_on, longest_path_length[0], current_bl);\n\n        return {\n          location: root_on,\n          breakpoint: longest_path_length / current_bl\n        };\n\n        //console.log (\"Longest \" + root_path (tree.getNodeByName(root_node.max_path_terminus.name)));\n        //console.log (\"Second longest \" + root_path (tree.getNodeByName(longest_path_length[1].name)));\n      }\n    }\n  }\n  return { location: root_node, breakpoint: 0 };\n}\n","import * as _ from \"underscore\";\n\n/*\n *Implements a linear time / space version of the Phylopart algorithm\n *Nature Communications volume 2, Article number: 321 (2011)\n *\n *@param tree                 -- the tree object \n *\n *@param bootstrap_thresold -- value in [0,1] that sets the stringency of bootstrap support\n *\n *@param percentile threshold -- a value in 0-1, which is used to delineate how clusters\n *                               are defined; the actual criterion used is \n *        [approximate] median pairwise distance in a cluster <= %-le of tree-wide distribution \n *                               \n *@param missing_bootstrap_value -- if a branch is missing bootstrap support value, use this value instead\n *                    (1.0 by default)\n *                    \n *@param resolution -- the width of the bin for the histogram; by default is set to be the   \n *                     minimum of 0.001, branch length range / 100,\n *                     however, the maximum number of histogram bins is capped at 500 for \n *                     performance reasons\n *                                 \n *@return an array of clusters, where cluster = \n *{\n *    'root'              : [root node of cluster]\n *    'members'           : [list of leaf. nodes]\n *    'median'            : approximate median cluster distance,\n *    'bootstrap'         : bootstrap support at the root node\n *}                        \n */\n\nimport { default as pairwise_distances } from \"../metrics/pairwise-distances\";\n\nfunction phylopart(\n  tree,\n  bootstrap_threshold,\n  percentile_threshold,\n  missing_bootstrap_value,\n  resolution\n) {\n  /** TODO SLKP 20180817 : this implementation does not compute pairwise distances correctly at the moment;\n   instead it computes root-to-tip distances */\n  missing_bootstrap_value = _.isNumber(missing_bootstrap_value)\n    ? missing_bootstrap_value\n    : 1;\n\n  var leaf_count = pairwise_distances(tree);\n\n  /** first, decide on the domain of branch lengths **/\n\n  var core_node = tree.getRootNode().children[0];\n\n  var min_bl = Number.MAX_VALUE,\n    min_bl2 = Number.MAX_VALUE;\n\n  if (!(percentile_threshold > 0 && percentile_threshold < 1)) {\n    throw \"Invalid percentile threshold in perform_phylopart\";\n  }\n\n  tree.traverse_and_compute(function(n) {\n    if (tree.isLeafNode(n)) {\n      if (n.cot_computed_length < min_bl) {\n        if (min_bl < min_bl2) {\n          min_bl2 = min_bl;\n        }\n        min_bl = n.cot_computed_length;\n      } else {\n        if (n.cot_computed_length < min_bl2) {\n          min_bl2 = n.cot_computed_length;\n        }\n      }\n    }\n  });\n\n  min_bl += min_bl2;\n\n  // pairwise distances are bounded below by the sum of two shortest terminal branches\n\n  // compute the upper bound\n  var max_path_length =\n    _.reduce(\n      core_node.cot_path_to_leaves_below,\n      function(c, n) {\n        return n > c ? n : c;\n      },\n      0\n    ) +\n    _.reduce(\n      core_node.cot_path_to_leaves_above,\n      function(c, n) {\n        return n > c ? n : c;\n      },\n      0\n    ) +\n    core_node.cot_computed_length;\n\n  var domain = max_path_length - min_bl;\n\n  if (_.isUndefined(resolution)) {\n    resolution = Math.min(1e-3, domain / 100);\n  }\n\n  var number_of_bins = ((domain / resolution) >> 0) + 1;\n  if (number_of_bins > 500) {\n    number_of_bins = 500;\n    resolution = domain / number_of_bins;\n  }\n\n  var root_node = tree.getRootNode();\n\n  root_node.paths_to_leaves = new Array(leaf_count);\n\n  _.each(root_node.children, function(cn) {\n    _.each(root_node.cot_path_to_leaves_below, function(v, i) {\n      root_node.paths_to_leaves[i] = v + cn.cot_computed_length;\n    });\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.isLeafNode(n)) {\n      n.histogram = new Array(number_of_bins);\n      for (var i = 0; i < number_of_bins; i++) {\n        n.histogram[i] = 0;\n      }\n      if (n.parent) {\n        var index = 0;\n        n.paths_to_leaves = [];\n        _.each(n.cot_path_to_leaves_below, function(v, i) {\n          n.paths_to_leaves[index++] = v;\n        });\n      }\n    }\n    delete n.cot_path_to_leaves_above;\n    delete n.cot_path_to_leaves_below;\n  });\n\n  /**\n        for each internal node, produce a histogram of pairwise distances on sequences that are defined \n        by the subtree at that node\n        \n        this could be approximated (I think), by merging histograms of children\n    */\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.isLeafNode(n)) {\n      for (var n1 = 0; n1 < n.paths_to_leaves.length; n1++) {\n        for (var n2 = n1 + 1; n2 < n.paths_to_leaves.length; n2++) {\n          var sum = n.paths_to_leaves[n1] + n.paths_to_leaves[n2];\n          n.histogram[((sum - min_bl) / resolution) >> 0]++;\n        }\n      }\n      n.leaf_count = n.paths_to_leaves.length;\n\n      delete n.paths_to_leaves;\n    }\n  });\n\n  // compute the percentile distance cutoff\n\n  var total_comparisons =\n    (leaf_count - 1) * leaf_count / 2 * percentile_threshold;\n  var bin_i = 0;\n  for (\n    ;\n    bin_i < number_of_bins - 1 &&\n    total_comparisons > root_node.histogram[bin_i];\n    bin_i++\n  ) {\n    total_comparisons -= root_node.histogram[bin_i];\n  }\n\n  var median_threshold =\n    min_bl +\n    (bin_i +\n      (root_node.histogram[bin_i] - total_comparisons) /\n        root_node.histogram[bin_i]) *\n      resolution;\n\n  var clusters = [];\n\n  tree.traverse_and_compute(_.noop, \"pre-order\", null, function(n) {\n    if (!tree.isLeafNode(n)) {\n      var bs = _.isString(n.data.bootstrap_values)\n        ? +n.data.bootstrap_values\n        : missing_bootstrap_value;\n      if (bs >= bootstrap_threshold) {\n        var total_comparisons = n.leaf_count * (n.leaf_count - 1) * 0.25;\n\n        var bin_i = 0;\n        for (\n          ;\n          bin_i < number_of_bins - 1 && total_comparisons > n.histogram[bin_i];\n          bin_i++\n        ) {\n          total_comparisons -= n.histogram[bin_i];\n        }\n\n        var my_median =\n          min_bl +\n          (bin_i +\n            (n.histogram[bin_i] - total_comparisons) / n.histogram[bin_i]) *\n            resolution;\n\n        if (my_median <= median_threshold) {\n          clusters.push({ root: n, median: my_median, bootstrap: bs });\n          return true;\n        }\n      }\n    }\n    return false;\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.isLeafNode(n)) {\n      if (\"histogram\" in n) {\n        delete n.histogram;\n        delete n.leaf_count;\n      }\n    }\n  });\n\n  _.each(clusters, function(cluster) {\n    cluster[\"members\"] = [];\n    tree.traverse_and_compute(\n      function(n) {\n        if (tree.isLeafNode(n)) {\n          cluster[\"members\"].push(n);\n        }\n      },\n      \"post-order\",\n      cluster[\"root\"]\n    );\n  });\n\n  return clusters;\n}\n\nexport default phylopart;\n","import * as _ from \"underscore\";\n\n/*\n * The Sackin's index is computed as the sum of the number of ancestors for each\n * tips of the tree.\n *\n * The less balanced a tree is, the larger its Sackin's index.\n *\n */\n\nexport default function sackin(tree) {\n\n  // Get tips of tree\n  let tips = tree.getTips();\n\n  // Count number of ancestors to root for each tree\n  let depths = _.map(tips, d => { return d.depth });\n\n  return _.reduce(depths, function(memo, num){ return memo + num; }, 0);\n\n}\n"],"names":["isLeafNode","node","_","has","graft_at","new_child","new_parent","lengths","nodes","this","descendants","parent","indexOf","parent_index","children","new_split","name","attribute","original_child_order","new_node","index","deleteANode","length","delete_me_idx","splice","forEach","d","push","data","filter","n","attributes","each","keys","old_key","new_key","respect","selection_attribute_name","traits","newickParser","nwk_str","options","int_or_float","left_delimiter","right_delimiter","clade_stack","addNewTreeLevel","the_parent","finishNodeDefinition","this_node","pop","current_node_name","current_node_attribute","current_node_annotation","includes","split","slice","annotation","key","value","test","generateError","location","json","error","substring","automaton_state","quote_delimiter","name_quotes","'","\"","tree_json","space","char_index","current_char","e","parseAnnotations","buf","str","toUpperCase","data_str","map","trim","dimensions","startsWith","object","rest","format","symbols","reject","matrix","compact","mapObject","v","k","Array","loadAnnotations","tree","label","annotations","getTips","loadTree","trees","xmlToJson","xml","obj","nodeType","j","item","nodeName","nodeValue","hasChildNodes","childNodes","i","old","phyloxml_parser","phyloxml","phylogeny","clade","parsePhyloxml","branch_length","taxonomy","scientific_name","format_registry","nexml","xml_string","parseString","nexml_tree","node_list","$","node_hash","reduce","a","b","edges","id","roots","root","root_id","edge","source","parseNexml","targets","pluck","values","pick","child","nexus","nexus_parser","nwk","nhx","beast","newick","parsed_newick","parseBeastNode","tokens","token","replace","undefined","postOrder","callback","backtrack","next","preOrder","inOrder","current","reverse","leftChildRightSibling","multiway_parent","target","defBranchLengthAccessor","_node","new_length","_node_data","String","bl","parseFloat","isNaN","Math","max","console","warn","fraction","d3","hierarchy","Error","copy","new_json","__mapped_bl","branch_length_accessor","setBranchLength","remove_me","current_node","stashed_bl","noop","apportioned_bl","remove_idx","t","concat","extendOwn","update","traverse_and_compute","c","isUndefined","display","select","container","remove","rendered_tree","render","appendChild","show","attr_name","store_name","my_value","selection","xCoord","y","yCoord","x","radialMapper","r","radial_center","sin","cos","cartesianToPolar","radius","radial_root_offset","scales","size","angle","PI","radial","drawArc","points","start","end","arcSegmentPlacer","where","draw_line","line","curve","curveStepBefore","lineSegmentPlacer","itemTagged","tag","itemSelected","css_classes","tree-container","tree-scale-bar","internal-node","tagged-node","selected-node","collapsed-node","root-node","branch","selected-branch","tagged-branch","tree-selection-brush","branch-tracer","node_text","nodeSpan","attr","arguments","predefined_selecters","all","none","all-leaf-nodes","all-internal-nodes","relative_nodeSpan","text_align","radius_pad_for_bubbles","right_most_leaf","screen_x","layout_listener_handler","syncEdgeLabels","selectionCallback","nodeVisible","hidden","notshown","nodeNotshown","hasHiddenNodes","isNodeCollapsed","collapsed","nodeCssSelectors","p","defNodeLabel","showInternalName","transitions","is_leaf","labels","selectAll","tracers","enter","append","classed","merge","on","handle_node_click","shown_font_size","text","_nodeLabel","style","ensure_size_is_in_px","d3PhylotreeSvgRotate","text_angle","d3PhylotreeSvgTranslate","alignTips","shiftTip","nodeBubbleSize","shift","circles","node_circle_size","min","node_styler","phylotree","i_names","internalNames","class_var","respect_existing","clearInternalNodes","modifySelection","cladeCssSelectors","enclosure","svg","node_id","collapsed_clades","spline","spline_f","curveBasis","coord","init_0","init_1","screen_y","exit","collapsed_clade","insert","edgeVisible","edgeCssSelectors","transition","reclassEdge","new_branch_path","draw_branch","datum","existing_path","haz_title","empty","edge_styler","links","countHandler","counts","countUpdate","edge_placer","d3_layout_phylotree_event_id","triggerRefresh","event","CustomEvent","detail","document","dispatchEvent","d3PhylotreeEventListener","refresh","d3PhylotreeAddEventListener","addEventListener","unhide","placenodes","tr","sizes","pad_radius","pad_width","vertical_offset","pad_height","scale","layoutHandler","d3_layout_phylotree_context_menu_id","menu_object","some","Boolean","menu_items","toggleCollapse","selectAllDescendants","pathToRoot","reroot","updateHasHiddenNodes","has_user_elements","show_divider_options","constant","partial","tree_container","coordinates","mouse","position","left","top","condition","node_selecter","place","skip_refresh","mode","contains","select_me","do_refresh","type","new_value","events.triggerRefresh","events.countUpdate","getSelection","terminal","internal","sel","TreeRender","[object Object]","separation","_previous","fixed_width","font_size","scale_bar_font_size","offsets","draw_scale_bar","count_listener_handler","label_width","rescale_nodeSpan","default_options","layout","logger","branches","scaling","bootstrap","color-fill","internal-names","selectable","restricted-selectable","collapsible","left-right-spacing","top-bottom-spacing","left-offset","show-scale","draw-size-bubbles","binary-selectable","is-radial","attribute-list","max-radius","annular-limit","compression","align-tips","maximum-per-node-spacing","minimum-per-node-spacing","maximum-per-level-spacing","minimum-per-level-spacing","brush","hide","label-nodes-with-name","zoom","show-menu","show-labels","node-styler","edge-styler","node-span","defaults","width","height","initialize_svg","initializeEdgeLabels","events.d3PhylotreeAddEventListener","_label_width","render_nodes.isNodeCollapsed","phylo_attr","svg_element","create","set_size","do_hierarchy","self","scale_bar","call","updateCollapsedClades","drawn_links","render_edges.edgeCssSelectors","render_edges.edgeVisible","drawEdge","drawn_nodes","render_nodes.nodeCssSelectors","render_nodes.nodeVisible","reclassNode","should_shift","drawNode","resizeSvg","brush_object","extent","selected_links","scaleExtent","transform","toTransform","a_node","_nodeSpan","last_node","last_span","_extents","is_under_collapsed_parent","save_x","save_span","render_nodes.nodeNotshown","undef_BL","do_scaling","max_depth","depth","_handle_single_node_layout","process_internal_node","map_me","count_undefined","half_way","displayed_children","managed_to_display","child_id","tree_layout","bind","at_least_one_dimension_fixed","available_width","last_child_angle","last_circ_position","last_child_radius","min_radius","effective_span","compute_distance","r1","r2","a1","a2","annular_shift","sqrt","max_r","my_circ_position","do_lr","required_spacing","radial_dist","local_mr","dd","st","scaler","z","last_point","pow","last_x","domain_limit","range_limit","ceil","log","stretch","scaleLinear","domain","range","scaleTickFormatter","axisTop","tickFormat","tickValues","round","my_ticks","ticks","skip_render","_font_size","node_width","abs","attr2","opt","arg","css","run_update","do_update","d3PhylotreeTriggerLayout","nodeDropdownMenu","extend","prototype","clades","render_nodes","render_edges","events","menus","Phylotree","newick_string","parsed_tags","partitions","isString","parser_registry","isFunction","contentType","_parsed_tags","Object","hasBranchLengths","traversal_type","json_export_index","node_array","node_copy","clone","JSON","stringify","root_node","computePairwiseDistances","leaf_count","CopyFromSiblings","other_node","cot_path_to_leaves_below","cot_path_to_leaves_above","cot_computed_length","cot_leaf_index","length_so_far","leaf_index","getRootNode","computeRootToTipOtherRoot","coming_from","shared_distance","distance_to_new_root","my_bl","go_up","rootToTip","rtta","linearFit","ss","sx","sy","sxoss","syoss","fitB","st2","vary","point","varres","intercept","slope","var (intercept)","var (slope)","_computed_length","isNumber","r2t","idx","node_operations.isLeafNode","mrca","mrca_nodes","from","mrca_node","union","intersection","every","getBranchLengths","branchName","nodeLabel","normalizeBranchLengths","branch_lengths","max_bl","min_bl","len","scaleBranchLengths","scale_by","getNewick","annotator","element_array","nodeDisplay","join","resortChildren","comparator","start_node","sum","sort","update_layout","maxParsimony","pop_mp_mat","mp","s0","s1","getTipLengths","tips","toExport","sortBy","node_operations","rooting","default_date_converter","timeParse","default_regexp","default_date_getter","exec","power","pairwise_distances","current_min","Number","MAX_VALUE","current_split","current_location","sum_below","sum_below_squared","sum_above","sum_above_squared","count_below","l","count_above","tt","score","optimization_step","current_t","breakpoint","distance","bootstrap_threshold","diameter_threshold","missing_bootstrap_value","max_path_length","clusters","bs","bootstrap_values","my_diameter","diameter","cluster","my_longest_path_terminus","my_longest_path_length","max_path","max_path_terminus","longest_path_length","root_child","pl","root_on","current_bl","date_getter","date_converter","d_string","date_value","full_year","getFullYear","year_start","Date","year_start_p1","decimal_date_value","linear_data","max_r2","best_node","copy_number","annotateCopyNumber","isNull","best_fit","fit","percentile_threshold","resolution","core_node","min_bl2","number_of_bins","paths_to_leaves","cn","histogram","n1","n2","total_comparisons","bin_i","median_threshold","my_median","median","depths","memo","num"],"mappings":"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"}